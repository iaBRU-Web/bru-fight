<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Stickman Rage: Arena Fury 3D - 16 Sections Adventure</title>
</head>
<body>

<!-- Loading Screen -->
<div id="loading">
    <div id="loadBg"></div>
    <div id="loadContent">
        <div style="position:relative;">
            <div id="loadRing"></div>
            <div id="loadStick">
                <svg viewBox="0 0 80 120" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <circle cx="40" cy="16" r="13" fill="#ffddaa" stroke="#00ffff" stroke-width="1.5"/>
                    <circle cx="35" cy="14" r="2.5" fill="#222"/>
                    <circle cx="45" cy="14" r="2.5" fill="#222"/>
                    <rect x="33" y="30" width="14" height="30" rx="4" fill="#00aaff"/>
                    <line x1="33" y1="35" x2="12" y2="55" stroke="#666" stroke-width="5" stroke-linecap="round"/>
                    <line x1="47" y1="35" x2="70" y2="42" stroke="#666" stroke-width="5" stroke-linecap="round"/>
                    <circle cx="70" cy="42" r="6" fill="#222"/>
                    <line x1="36" y1="60" x2="22" y2="90" stroke="#444" stroke-width="5" stroke-linecap="round"/>
                    <line x1="44" y1="60" x2="58" y2="90" stroke="#444" stroke-width="5" stroke-linecap="round"/>
                    <rect x="14" y="88" width="16" height="8" rx="3" fill="#111"/>
                    <rect x="52" y="88" width="16" height="8" rx="3" fill="#111"/>
                    <path d="M62 10 L80 28 L68 26 L75 48" stroke="#00ffff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" opacity="0.8"/>
                </svg>
            </div>
        </div>
        <div id="loadTitle">STICKMAN RAGE<br>ARENA FURY 3D</div>
        <div id="loadSub">16 sections &nbsp;â€¢&nbsp; boss fights &nbsp;â€¢&nbsp; guns</div>
        <div id="loadBarWrap">
            <div id="loadBar"><div id="loadFill"></div></div>
            <div style="display:flex;justify-content:space-between;width:min(340px,80vw);">
                <div id="loadStatus">Initializing...</div>
                <div id="loadPct">0%</div>
            </div>
        </div>
    </div>
</div>

<!-- Main Menu -->
<div id="menu">
    <h1>ğŸ¦¾ STICKMAN RAGE: ARENA FURY 3D ğŸ¦¾</h1>
    <p>16 Sections â€¢ 10 Waves Each â€¢ Boss Fights â€¢ Guns â€¢ Shops â€¢ Coins!</p>
    <button class="menuBtn" onclick="startGame('story')">ğŸš€ STORY MODE</button>
    <button class="menuBtn" onclick="startGame('survival')">â™¾ï¸ SURVIVAL MODE</button>
    <button class="menuBtn" onclick="showTutorial()">ğŸ“– TUTORIAL</button>
    <button class="menuBtn" onclick="toggleMobile()">ğŸ“± MOBILE CONTROLS</button>
    <button class="menuBtn" onclick="showSettings()">âš™ï¸ SETTINGS</button>
    <p style="font-size:13px;color:#666;">Save data loaded automatically | Press P to pause</p>
</div>

<!-- Tutorial -->
<div id="tutorial">
    <h2>ğŸ® HOW TO PLAY</h2>
    <div class="tutRow"><div>Move Left / Right</div><span>A / D</span></div>
    <div class="tutRow"><div>Jump (double jump allowed)</div><span>W / Space</span></div>
    <div class="tutRow"><div>Punch</div><span>Z</span></div>
    <div class="tutRow"><div>Kick</div><span>X</span></div>
    <div class="tutRow"><div>Block</div><span>C</span></div>
    <div class="tutRow"><div>Dodge Roll</div><span>Q</span></div>
    <div class="tutRow"><div>Shoot (when armed)</div><span>V</span></div>
    <div class="tutRow"><div>Special Attack</div><span>B</span></div>
    <div class="tutRow"><div>Pause</div><span>P / Esc</span></div>
    <button class="continueBtn" onclick="closeTutorial()">GOT IT! âœ…</button>
</div>

<!-- Settings -->
<div id="settings">
    <h2>âš™ï¸ SETTINGS</h2>
    <div class="settingRow"><label>Music Volume</label><input type="range" id="musicVol" min="0" max="100" value="50" oninput="setMusicVol(this.value)"></div>
    <div class="settingRow"><label>SFX Volume</label><input type="range" id="sfxVol" min="0" max="100" value="80" oninput="setSfxVol(this.value)"></div>
    <div class="settingRow"><label>Screen Shake</label><input type="checkbox" id="shakeEnabled" checked></div>
    <div class="settingRow"><label>Damage Numbers</label><input type="checkbox" id="dmgNumsEnabled" checked></div>
    <div class="settingRow"><label>Particles</label><input type="checkbox" id="particlesEnabled" checked></div>
    <button class="continueBtn" onclick="closeSettings()">SAVE âœ…</button>
</div>

<!-- Shop -->
<div id="shop">
    <h2>ğŸ›’ WORKSHOP</h2>
    <div id="shopCoins">ğŸ’° <span id="shopCoinAmt">0</span></div>
    <div id="shopItems"></div>
    <br>
    <button class="continueBtn" onclick="continueStory()">NEXT SECTION â¡ï¸</button>
</div>

<!-- Pause Menu -->
<div id="pauseMenu">
    <h2>â¸ PAUSED</h2>
    <button class="pauseBtn" onclick="resumeGame()">â–¶ RESUME</button>
    <button class="pauseBtn" onclick="showSettings()">âš™ï¸ SETTINGS</button>
    <button class="pauseBtn" onclick="showStatsNow()">ğŸ“Š STATS</button>
    <button class="pauseBtn" onclick="location.reload()">ğŸ  MAIN MENU</button>
</div>

<!-- Canvas -->
<canvas id="c"></canvas>

<!-- HUD -->
<div id="hud">
    <div class="card">
        <div class="stat-row">â¤ï¸ Health</div>
        <div class="bar"><div id="hpbar" class="bar-fill" style="background: linear-gradient(90deg,#ff4444,#00ff88);width:100%;"></div></div>
        <div class="stat-row" style="margin-top:6px;">âš¡ Power</div>
        <div id="powerBar" class="bar"><div id="powerbar" class="bar-fill" style="width:100%;"></div></div>
        <div class="stat-row" style="margin-top:4px;font-size:12px;" id="weaponTxt">ğŸ‘Š Fists</div>
    </div>
    <div id="waveInfo">
        <div>Section: <span id="sectionTxt">1</span>/16</div>
        <div>Wave: <span id="waveTxt">1/10</span></div>
        <div id="coins">ğŸ’° 0</div>
        <div style="font-size:12px;color:#aaa;">Enemies: <span id="enemiesLeft">0</span></div>
    </div>
    <div class="card">
        <div class="stat-row">ğŸ”¥ Combo</div>
        <div id="comboCount" style="font-size:22px;color:#ffff00;text-align:center;text-shadow:0 0 10px #ff8800;">x0</div>
        <div class="stat-row" style="margin-top:4px;font-size:12px;" id="modeTxt">STORY</div>
    </div>
</div>

<!-- Combo display big -->
<div id="comboDisplay"></div>

<!-- Hit flash overlay -->
<div id="hitFlash"></div>

<!-- Crosshair -->
<div id="crosshair"></div>

<!-- Achievement popup -->
<div id="achievePopup"><div id="achieveText">ğŸ† Achievement Unlocked!</div></div>

<!-- Stats panel -->
<div id="statsPanel"></div>

<!-- Minimap canvas -->
<canvas id="minimap" width="130" height="30"></canvas>

<!-- Mobile Controls -->
<div id="joystickArea" style="display:none;">
    <div id="joystickBase"><div id="joystickKnob"></div></div>
</div>
<div id="actionBtns" style="display:none;">
    <button class="abtn jump" id="btnJump">ğŸ¦˜</button>
    <button class="abtn punch" id="btnPunch">ğŸ‘Š</button>
    <button class="abtn kick" id="btnKick">ğŸ¦µ</button>
    <button class="abtn block" id="btnBlock">ğŸ›¡</button>
    <button class="abtn dodge" id="btnDodge">ğŸ’¨</button>
    <button class="abtn shoot" id="btnShoot">ğŸ”«</button>
    <button class="abtn special" id="btnSpecial">ğŸ’¥</button>
</div>

<!-- Game Over -->
<div id="gameover">
    <div id="winnerText">DEFEAT! ğŸ’€</div>
    <div id="finalStats"></div>
    <button id="newGame" onclick="location.reload()">ğŸ”„ RETRY</button>
</div>
    <style>
        :root {
            --bg: #000011;
            --panel: rgba(0, 20, 40, 0.92);
            --accent: #00ffff;
            --p1: #00aaff;
            --enemy: #ff4400;
            --boss: #ffaa00;
            --coin: #ffd700;
            --ok: #00ff88;
            --bad: #ff4444;
        }
        *, *::before, *::after { box-sizing: border-box; }
        html, body { margin: 0; height: 100%; background: var(--bg); color: white; font-family: 'Arial Black', Impact, sans-serif; overflow: hidden; touch-action: none; }
        canvas { display: block; width: 100vw; height: 100vh; }

        /* HUD */
        #hud { position: fixed; top: 8px; left: 8px; right: 8px; display: flex; justify-content: space-between; align-items: flex-start; z-index: 1000; pointer-events: none; gap: 8px; }
        .card { background: var(--panel); backdrop-filter: blur(10px); border: 1px solid var(--accent); padding: 10px 14px; border-radius: 12px; box-shadow: 0 0 20px rgba(0,255,255,0.2); min-width: 130px; }
        .stat-row { display: flex; justify-content: space-between; align-items: center; font-size: 13px; gap: 8px; }
        .bar { height: 14px; width: 110px; background: #111; border: 1px solid #333; border-radius: 7px; overflow: hidden; margin-top: 3px; }
        .bar-fill { height: 100%; transition: width 0.3s; border-radius: 6px; box-shadow: 0 0 8px currentColor; }

        #waveInfo { text-align: center; font-size: 15px; font-weight: bold; text-shadow: 0 0 15px var(--accent); flex: 1; }
        #coins { color: var(--coin); text-shadow: 0 0 10px var(--coin); font-size: 18px; }
        #weaponTxt { font-size: 13px; color: #aef; }
        #powerBar .bar-fill { background: linear-gradient(90deg, #ff44ff, #aa00ff); }

        /* Damage numbers */
        .dmgNum { position: fixed; font-size: 22px; font-weight: 900; pointer-events: none; z-index: 1500; text-shadow: 2px 2px 4px #000; animation: floatUp 1s ease-out forwards; }
        @keyframes floatUp { 0%{opacity:1;transform:translateY(0) scale(1)} 100%{opacity:0;transform:translateY(-70px) scale(0.7)} }

        /* Combo counter */
        #comboDisplay { position: fixed; top: 50%; right: 20px; transform: translateY(-50%); font-size: 32px; font-weight: 900; color: #ffff00; text-shadow: 0 0 20px #ff8800; z-index: 1200; pointer-events: none; opacity: 0; transition: opacity 0.3s; }
        #comboDisplay.active { opacity: 1; }

        /* Hit flash overlay */
        #hitFlash { position: fixed; inset: 0; background: rgba(255,0,0,0); pointer-events: none; z-index: 1800; transition: background 0.1s; }

        /* Menus */
        #menu, #shop { position: fixed; inset: 0; background: rgba(0,0,10,0.97); display: none; flex-direction: column; align-items: center; justify-content: center; z-index: 2000; gap: 14px; overflow-y: auto; padding: 20px; }
        #menu.active, #shop.active { display: flex; }
        #menu h1 { font-size: clamp(22px,4vw,42px); text-align: center; text-shadow: 0 0 30px var(--accent); margin: 0; background: linear-gradient(90deg, #00ffff, #ff4400, #ffff00); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        #menu p { font-size: 16px; color: #aaa; text-align: center; }
        .menuBtn { width: clamp(220px,60vw,300px); height: 55px; font-size: 18px; font-weight: bold; border: none; border-radius: 30px; background: linear-gradient(45deg, var(--p1), var(--enemy)); color: white; cursor: pointer; box-shadow: 0 0 20px var(--accent); transition: all 0.2s; }
        .menuBtn:hover { transform: scale(1.05); box-shadow: 0 0 40px var(--accent); }

        /* Shop */
        #shop h2 { font-size: 28px; color: var(--coin); text-shadow: 0 0 20px var(--coin); margin: 0; }
        #shopCoins { font-size: 22px; color: var(--coin); margin: 4px 0 10px; }
        #shopItems { display: grid; grid-template-columns: repeat(auto-fill, minmax(240px,1fr)); gap: 10px; width: 100%; max-width: 820px; }
        .shopBtn { padding: 12px 16px; font-size: 14px; font-weight: bold; border: 1px solid #444; border-radius: 12px; background: rgba(0,20,40,0.9); color: white; cursor: pointer; transition: all 0.2s; text-align: left; }
        .shopBtn:not(:disabled):hover { border-color: var(--coin); box-shadow: 0 0 15px var(--coin); transform: scale(1.02); }
        .shopBtn:disabled { opacity: 0.4; cursor: not-allowed; }
        .shopBtn .item-name { font-size: 15px; color: var(--ok); }
        .shopBtn .item-cost { color: var(--coin); font-size: 13px; }
        .shopBtn .item-desc { font-size: 11px; color: #888; margin-top: 3px; }
        .continueBtn { width: 200px; height: 50px; font-size: 16px; font-weight: bold; border: none; border-radius: 25px; background: var(--ok); color: black; cursor: pointer; box-shadow: 0 0 20px var(--ok); transition: all 0.2s; }
        .continueBtn:hover { transform: scale(1.05); }

        /* Pause menu */
        #pauseMenu { position: fixed; inset: 0; background: rgba(0,0,20,0.92); display: none; flex-direction: column; align-items: center; justify-content: center; z-index: 3000; gap: 16px; }
        #pauseMenu.active { display: flex; }
        #pauseMenu h2 { font-size: 40px; color: var(--accent); text-shadow: 0 0 30px var(--accent); }
        .pauseBtn { width: 220px; height: 50px; font-size: 16px; font-weight: bold; border: 1px solid var(--accent); border-radius: 25px; background: var(--panel); color: white; cursor: pointer; transition: all 0.2s; }
        .pauseBtn:hover { background: var(--accent); color: black; }

        /* Settings */
        #settings { position: fixed; inset: 0; background: rgba(0,0,20,0.95); display: none; flex-direction: column; align-items: center; justify-content: center; z-index: 3500; gap: 14px; overflow-y: auto; padding: 20px; }
        #settings.active { display: flex; }
        #settings h2 { font-size: 30px; color: var(--accent); margin: 0; }
        .settingRow { display: flex; justify-content: space-between; align-items: center; width: 320px; font-size: 15px; }
        .settingRow label { color: #aaa; }
        .settingRow input[type=range] { width: 150px; accent-color: var(--accent); }
        .settingRow input[type=checkbox] { width: 20px; height: 20px; accent-color: var(--accent); cursor: pointer; }

        /* Stats */
        #statsPanel { position: fixed; bottom: 70px; left: 50%; transform: translateX(-50%); background: var(--panel); border: 1px solid var(--accent); border-radius: 12px; padding: 12px 20px; font-size: 13px; z-index: 1100; display: none; pointer-events: none; white-space: nowrap; }
        #statsPanel.active { display: block; }
        #statsPanel div { margin: 2px 0; }

        /* Minimap */
        #minimap { position: fixed; bottom: 70px; right: 10px; width: 130px; height: 30px; background: rgba(0,0,20,0.8); border: 1px solid var(--accent); border-radius: 6px; z-index: 1100; pointer-events: none; }

        /* Mobile controls */
        #controls { position: fixed; bottom: 6px; left: 0; right: 0; display: none; z-index: 1100; user-select: none; }
        #joystickArea { position: fixed; bottom: 10px; left: 10px; width: 130px; height: 130px; z-index: 1200; touch-action: none; }
        #joystickBase { width: 120px; height: 120px; border-radius: 60px; background: rgba(0,150,255,0.2); border: 2px solid rgba(0,200,255,0.5); position: relative; }
        #joystickKnob { width: 50px; height: 50px; border-radius: 25px; background: rgba(0,200,255,0.7); position: absolute; top: 35px; left: 35px; pointer-events: none; }
        #actionBtns { position: fixed; bottom: 10px; right: 10px; display: flex; flex-wrap: wrap; gap: 8px; width: 190px; justify-content: flex-end; z-index: 1200; }
        .abtn { width: 60px; height: 60px; border: none; border-radius: 30px; font-size: 20px; color: white; cursor: pointer; -webkit-tap-highlight-color: transparent; touch-action: none; }
        .abtn.punch { background: rgba(255,50,50,0.8); }
        .abtn.kick { background: rgba(255,100,0,0.8); }
        .abtn.jump { background: rgba(0,150,255,0.8); }
        .abtn.shoot { background: rgba(255,220,0,0.8); display: none; }
        .abtn.special { background: rgba(180,0,255,0.8); }
        .abtn.block { background: rgba(0,200,100,0.8); }
        .abtn.dodge { background: rgba(0,200,200,0.8); }

        /* Crosshair */
        #crosshair { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 30px; height: 30px; border: 2px solid var(--accent); border-radius: 50%; opacity: 0.7; pointer-events: none; z-index: 999; display: none; }
        #crosshair::before, #crosshair::after { content:''; position:absolute; background:var(--accent); }
        #crosshair::before { width:1px; height:14px; left:50%; top:-2px; transform:translateX(-50%); }
        #crosshair::after { width:14px; height:1px; top:50%; left:-2px; transform:translateY(-50%); }

        /* Invincibility flash */
        @keyframes iFrameFlash { 0%,100%{opacity:1} 50%{opacity:0.3} }
        .invincible { animation: iFrameFlash 0.15s infinite; }

        /* Gameover */
        #gameover { position: fixed; inset: 0; background: rgba(0,0,0,0.9); display: none; flex-direction: column; align-items: center; justify-content: center; z-index: 2000; }
        #gameover.active { display: flex; }
        #winnerText { font-size: clamp(28px,5vw,56px); text-shadow: 0 0 20px var(--accent); text-align: center; padding: 0 20px; }
        #finalStats { font-size: 16px; color: #aaa; margin: 12px 0; text-align: center; }
        #newGame { margin-top: 10px; width: 180px; height: 50px; font-size: 18px; font-weight: bold; border: none; border-radius: 25px; background: linear-gradient(45deg, var(--p1), var(--enemy)); color: white; cursor: pointer; box-shadow: 0 0 20px var(--accent); }

        /* Tutorial overlay */
        #tutorial { position: fixed; inset: 0; background: rgba(0,0,20,0.9); display: none; flex-direction: column; align-items: center; justify-content: center; z-index: 4000; gap: 10px; }
        #tutorial.active { display: flex; }
        #tutorial h2 { color: var(--accent); font-size: 28px; margin: 0; }
        .tutRow { font-size: 14px; color: #ccc; background: rgba(255,255,255,0.05); padding: 8px 20px; border-radius: 8px; width: 320px; display: flex; justify-content: space-between; }
        .tutRow span { color: var(--ok); font-weight: bold; }

        /* Loading screen */
        #loading {
            position: fixed; inset: 0; z-index: 9999;
            background: #000011;
            display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 0;
            transition: opacity 0.5s ease;
        }
        #loading.fadeout { opacity: 0; pointer-events: none; }

        /* Scanline overlay */
        #loading::before {
            content: '';
            position: absolute; inset: 0;
            background: repeating-linear-gradient(0deg, transparent, transparent 2px, rgba(0,0,0,0.08) 2px, rgba(0,0,0,0.08) 4px);
            pointer-events: none;
        }

        /* Particles bg */
        #loadBg { position: absolute; inset: 0; overflow: hidden; }
        .loadStar {
            position: absolute; border-radius: 50%;
            animation: starDrift linear infinite;
        }
        @keyframes starDrift {
            from { transform: translateY(100vh) scale(0); opacity: 0; }
            10%  { opacity: 1; }
            90%  { opacity: 0.6; }
            to   { transform: translateY(-10vh) scale(1.5); opacity: 0; }
        }

        #loadContent { position: relative; display: flex; flex-direction: column; align-items: center; gap: 18px; }

        /* Stickman logo */
        #loadStick {
            width: 80px; height: 120px; position: relative;
            animation: stickBounce 0.6s ease-in-out infinite alternate;
        }
        @keyframes stickBounce {
            from { transform: translateY(0) scaleY(1); }
            to   { transform: translateY(-12px) scaleY(1.04); }
        }
        #loadStick svg { width: 100%; height: 100%; }

        /* Glow ring behind stickman */
        #loadRing {
            position: absolute; width: 110px; height: 110px;
            border-radius: 50%;
            border: 2px solid transparent;
            background: radial-gradient(circle, rgba(0,255,255,0.15) 0%, transparent 70%);
            box-shadow: 0 0 40px rgba(0,255,255,0.4), inset 0 0 40px rgba(0,255,255,0.1);
            animation: ringPulse 1.2s ease-in-out infinite;
            top: -10px; left: -15px;
        }
        @keyframes ringPulse {
            0%,100% { transform: scale(1); opacity: 0.7; }
            50%      { transform: scale(1.12); opacity: 1; }
        }

        /* Title */
        #loadTitle {
            font-family: 'Arial Black', Impact, sans-serif;
            font-size: clamp(22px, 5vw, 38px);
            letter-spacing: 2px;
            text-align: center;
            line-height: 1.15;
            background: linear-gradient(90deg, #00ffff 0%, #ff4400 50%, #ffd700 100%);
            background-size: 200% auto;
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            animation: titleShine 1.5s linear infinite;
        }
        @keyframes titleShine {
            from { background-position: 0% center; }
            to   { background-position: 200% center; }
        }
        #loadSub {
            font-size: 12px; color: #556; letter-spacing: 4px;
            text-transform: uppercase; margin-top: -14px;
        }

        /* Bar container */
        #loadBarWrap { display: flex; flex-direction: column; align-items: center; gap: 8px; }
        #loadBar {
            width: min(340px, 80vw); height: 6px;
            background: rgba(255,255,255,0.06);
            border-radius: 3px; overflow: visible; position: relative;
        }
        #loadFill {
            height: 100%; width: 0%;
            background: linear-gradient(90deg, #00ffff, #0044ff, #00ffff);
            background-size: 200% 100%;
            border-radius: 3px;
            transition: width 0.25s cubic-bezier(.4,0,.2,1);
            animation: barShimmer 1s linear infinite;
            box-shadow: 0 0 10px #00ffff, 0 0 20px rgba(0,200,255,0.4);
        }
        @keyframes barShimmer {
            from { background-position: 0% 0; }
            to   { background-position: 200% 0; }
        }
        /* Glow dot at tip */
        #loadFill::after {
            content: '';
            position: absolute; right: -3px; top: 50%;
            transform: translateY(-50%);
            width: 10px; height: 10px; border-radius: 50%;
            background: #fff;
            box-shadow: 0 0 8px #00ffff, 0 0 16px #00ffff;
        }

        #loadStatus {
            font-size: 11px; color: #00ffff; letter-spacing: 3px;
            text-transform: uppercase; opacity: 0.7;
            animation: statusBlink 0.8s ease-in-out infinite;
        }
        @keyframes statusBlink { 0%,100%{opacity:0.5} 50%{opacity:1} }
        #loadPct { font-size: 13px; color: #fff; opacity: 0.5; letter-spacing: 1px; }

        /* Achievement popup */
        #achievePopup { position: fixed; top: 80px; left: 50%; transform: translateX(-50%); background: linear-gradient(90deg,rgba(0,40,0,0.95),rgba(0,80,0,0.95)); border: 1px solid var(--ok); border-radius: 12px; padding: 10px 20px; z-index: 2500; pointer-events: none; display: none; }
        #achievePopup.active { display: block; animation: slideDown 0.4s ease-out; }
        @keyframes slideDown { from{transform:translateX(-50%) translateY(-40px);opacity:0} to{transform:translateX(-50%) translateY(0);opacity:1} }
        #achieveText { font-size: 15px; color: var(--ok); }
    </style>
<script src="https://unpkg.com/three@0.161.0/build/three.min.js"></script>
<script>
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// LOADING SCREEN â€” 3 second timed progress
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const loadStages = [
    { pct: 15,  status: 'Loading engine...' },
    { pct: 35,  status: 'Building arena...' },
    { pct: 55,  status: 'Spawning stickmen...' },
    { pct: 72,  status: 'Loading weapons...' },
    { pct: 88,  status: 'Charging power...' },
    { pct: 100, status: 'Ready to fight!' },
];

// Generate background stars
(function() {
    const bg = document.getElementById('loadBg');
    for(let i = 0; i < 40; i++) {
        const s = document.createElement('div');
        s.className = 'loadStar';
        const size = Math.random() * 4 + 1;
        s.style.cssText = `width:${size}px;height:${size}px;left:${Math.random()*100}%;background:${Math.random()<0.3?'#00ffff':'#ffffff'};opacity:${Math.random()*0.6+0.2};animation-duration:${3+Math.random()*4}s;animation-delay:${Math.random()*3}s;`;
        bg.appendChild(s);
    }
})();

let _loadStage = 0;
const _loadInterval = setInterval(() => {
    if(_loadStage >= loadStages.length) { clearInterval(_loadInterval); return; }
    const stage = loadStages[_loadStage++];
    document.getElementById('loadFill').style.width = stage.pct + '%';
    document.getElementById('loadStatus').textContent = stage.status;
    document.getElementById('loadPct').textContent = stage.pct + '%';
    if(stage.pct >= 100) {
        clearInterval(_loadInterval);
        setTimeout(() => {
            const el = document.getElementById('loading');
            el.classList.add('fadeout');
            setTimeout(() => { el.style.display = 'none'; document.getElementById('menu').classList.add('active'); }, 500);
        }, 300);
    }
}, 500); // 6 stages Ã— 500ms = 3 seconds total

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// SAVE SYSTEM
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let saveData = {};
try {
    const raw = localStorage.getItem('stickmanRageSave');
    if(raw) saveData = JSON.parse(raw);
} catch(e) { saveData = {}; }
function save() {
    try { localStorage.setItem('stickmanRageSave', JSON.stringify(saveData)); } catch(e){}
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// ACHIEVEMENT SYSTEM
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const ACHIEVEMENTS = {
    firstBlood: { name: 'ğŸ©¸ First Blood', desc: 'Kill your first enemy', unlocked: false },
    combo10: { name: 'ğŸ”¥ Combo Master', desc: '10 hit combo', unlocked: false },
    boss1: { name: 'ğŸ‘‘ Boss Slayer', desc: 'Defeat a boss', unlocked: false },
    survive16: { name: 'ğŸ† Champion', desc: 'Complete all 16 sections', unlocked: false },
    rich: { name: 'ğŸ’° Rich Stick', desc: 'Collect 500 coins', unlocked: false },
    section5: { name: 'âš”ï¸ Veteran', desc: 'Reach section 5', unlocked: false },
    dodge5: { name: 'ğŸ’¨ Dodgeball', desc: 'Dodge 5 attacks', unlocked: false },
};
function unlockAchievement(id) {
    if(!ACHIEVEMENTS[id] || ACHIEVEMENTS[id].unlocked) return;
    ACHIEVEMENTS[id].unlocked = true;
    if(!saveData.achievements) saveData.achievements = {};
    saveData.achievements[id] = true;
    save();
    showAchievement(ACHIEVEMENTS[id].name);
}
let achieveTimer = null;
function showAchievement(text) {
    const el = document.getElementById('achievePopup');
    document.getElementById('achieveText').textContent = 'ğŸ† ' + text;
    el.classList.add('active');
    if(achieveTimer) clearTimeout(achieveTimer);
    achieveTimer = setTimeout(() => el.classList.remove('active'), 3000);
}

// Load achievement state
if(saveData.achievements) {
    Object.keys(saveData.achievements).forEach(k => { if(ACHIEVEMENTS[k]) ACHIEVEMENTS[k].unlocked = true; });
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// SETTINGS
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let cfg = {
    musicVol: 50,
    sfxVol: 80,
    shake: true,
    dmgNums: true,
    particles: true,
};
try { const s = localStorage.getItem('srCfg'); if(s) Object.assign(cfg, JSON.parse(s)); } catch(e){}
function saveCfg() { try { localStorage.setItem('srCfg', JSON.stringify(cfg)); } catch(e){} }

document.getElementById('musicVol').value = cfg.musicVol;
document.getElementById('sfxVol').value = cfg.sfxVol;
document.getElementById('shakeEnabled').checked = cfg.shake;
document.getElementById('dmgNumsEnabled').checked = cfg.dmgNums;
document.getElementById('particlesEnabled').checked = cfg.particles;

function setMusicVol(v) { cfg.musicVol = +v; if(bgmGain) bgmGain.gain.value = cfg.musicVol / 1000; }
function setSfxVol(v) { cfg.sfxVol = +v; }
function showSettings() { document.getElementById('settings').classList.add('active'); }
function closeSettings() {
    cfg.shake = document.getElementById('shakeEnabled').checked;
    cfg.dmgNums = document.getElementById('dmgNumsEnabled').checked;
    cfg.particles = document.getElementById('particlesEnabled').checked;
    saveCfg();
    document.getElementById('settings').classList.remove('active');
}
function showTutorial() { document.getElementById('tutorial').classList.add('active'); }
function closeTutorial() { document.getElementById('tutorial').classList.remove('active'); }

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// MOBILE TOGGLE
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let mobileMode = false;
function toggleMobile() {
    mobileMode = !mobileMode;
    document.getElementById('joystickArea').style.display = mobileMode ? 'block' : 'none';
    document.getElementById('actionBtns').style.display = mobileMode ? 'flex' : 'none';
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// STATS TRACKING
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const stats = {
    kills: 0,
    bossKills: 0,
    coinsTotal: 0,
    damageDealt: 0,
    damageTaken: 0,
    dodges: 0,
    shots: 0,
    startTime: Date.now(),
    wavesCleared: 0,
};

function showStatsNow() {
    const el = document.getElementById('statsPanel');
    const mins = Math.floor((Date.now() - stats.startTime) / 60000);
    el.innerHTML = `
        <div>â± Time: ${mins}m</div>
        <div>ğŸ’€ Kills: ${stats.kills}</div>
        <div>ğŸ‘‘ Boss Kills: ${stats.bossKills}</div>
        <div>ğŸ’° Coins Earned: ${stats.coinsTotal}</div>
        <div>âš”ï¸ Damage Dealt: ${Math.floor(stats.damageDealt)}</div>
        <div>ğŸ©¸ Damage Taken: ${Math.floor(stats.damageTaken)}</div>
        <div>ğŸ’¨ Dodges: ${stats.dodges}</div>
        <div>ğŸ”« Shots Fired: ${stats.shots}</div>
        <div>ğŸŒŠ Waves Cleared: ${stats.wavesCleared}</div>
    `;
    el.classList.toggle('active');
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// AUDIO ENGINE
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const audioContext = new (window.AudioContext || window.webkitAudioContext)();
let bgmGain, sfxGain, bgmOsc = null;
function initAudio() {
    bgmGain = audioContext.createGain(); bgmGain.gain.value = cfg.musicVol / 1000; bgmGain.connect(audioContext.destination);
    sfxGain = audioContext.createGain(); sfxGain.gain.value = cfg.sfxVol / 100; sfxGain.connect(audioContext.destination);
}
initAudio();

function tone(freq, dur, type='sine', vol=0.1, dest=sfxGain) {
    if(cfg.sfxVol === 0) return;
    try {
        const o = audioContext.createOscillator(), g = audioContext.createGain();
        o.connect(g); g.connect(dest||sfxGain);
        o.frequency.value = freq; o.type = type; g.gain.setValueAtTime(vol * (cfg.sfxVol/80), audioContext.currentTime);
        g.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + dur);
        o.start(); o.stop(audioContext.currentTime + dur);
    } catch(e){}
}
function playBGM(section) {
    if(bgmOsc) { try { bgmOsc.stop(); } catch(e){} bgmOsc = null; }
    if(cfg.musicVol === 0) return;
    const baseFreqs = [110,130,100,120,140,105,115,125,135,108,118,128,138,148,103,113];
    const freq = baseFreqs[(section-1)%baseFreqs.length];
    bgmOsc = audioContext.createOscillator();
    const lfo = audioContext.createOscillator(), lfoGain = audioContext.createGain();
    lfo.frequency.value = 4; lfoGain.gain.value = 5; lfo.connect(lfoGain); lfoGain.connect(bgmOsc.frequency);
    bgmOsc.frequency.value = freq; bgmOsc.type = 'triangle';
    bgmOsc.connect(bgmGain); lfo.start(); bgmOsc.start();
}
function punchSnd() { tone(320,0.08,'square',0.25); }
function kickSnd() { tone(200,0.12,'sawtooth',0.28); }
function shootSnd() { tone(650,0.05,'square',0.3); tone(400,0.05,'square',0.15); }
function hitSnd() { tone(160,0.08,'square',0.4); }
function coinSnd() { tone(900,0.08,'sine',0.12); setTimeout(()=>tone(1100,0.08,'sine',0.12),60); }
function bossSnd() { tone(80,0.6,'sawtooth',0.5); }
function pickupSnd() { tone(700,0.1,'sine',0.2); }
function dodgeSnd() { tone(500,0.05,'sine',0.15); tone(800,0.05,'sine',0.1); }
function deathSnd() { tone(100,0.4,'sawtooth',0.4); tone(80,0.5,'sawtooth',0.3); }
function comboSnd(c) { tone(400+c*30,0.1,'square',0.2); }

document.addEventListener('click', () => audioContext.resume(), {once:true});
document.addEventListener('keydown', () => audioContext.resume(), {once:true});

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// THREE.JS SETUP
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const canvas = document.getElementById('c');
const renderer = new THREE.WebGLRenderer({ canvas, antialias: true });
renderer.setSize(innerWidth, innerHeight);
renderer.setPixelRatio(Math.min(devicePixelRatio, 2));
renderer.shadowMap.enabled = true;
renderer.shadowMap.type = THREE.PCFSoftShadowMap;

const scene = new THREE.Scene();
scene.fog = new THREE.Fog(0x000011, 40, 160);

const aspect = innerWidth / innerHeight;
const camera = new THREE.OrthographicCamera(-aspect*30, aspect*30, 25, -25, 0.1, 1000);
camera.position.set(0, 10, 40);
camera.lookAt(0, 0, 0);

window.addEventListener('resize', () => {
    const a = innerWidth / innerHeight;
    camera.left=-a*30; camera.right=a*30; camera.updateProjectionMatrix();
    renderer.setSize(innerWidth, innerHeight);
});

// Lighting
const ambient = new THREE.AmbientLight(0x222244, 0.4);
const dirLight = new THREE.DirectionalLight(0x00aaff, 1.6);
dirLight.position.set(-15,20,10); dirLight.castShadow = true;
dirLight.shadow.mapSize.set(1024,1024);
const rimLight = new THREE.DirectionalLight(0xff4400, 0.5);
rimLight.position.set(15,5,-10);
const bossLight = new THREE.PointLight(0xffaa00, 0, 20);
bossLight.position.set(20,5,0);
scene.add(ambient, dirLight, rimLight, bossLight);

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// ARENA
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const arenaGroup = new THREE.Group();

// Ground
const groundMesh = new THREE.Mesh(
    new THREE.PlaneGeometry(62,22),
    new THREE.MeshLambertMaterial({ color: 0x111133 })
);
groundMesh.rotation.x = -Math.PI/2; groundMesh.receiveShadow = true; groundMesh.position.y = -0.1;
arenaGroup.add(groundMesh);

// Ground grid lines
for(let i=-30;i<=30;i+=5) {
    const line = new THREE.Mesh(new THREE.BoxGeometry(0.05,0.02,22), new THREE.MeshBasicMaterial({color:0x222244}));
    line.position.set(i,-0.05,0); arenaGroup.add(line);
}

// Barriers
const barrierMat = new THREE.MeshLambertMaterial({ color: 0x223366 });
[-29,29].forEach(x => {
    const w = new THREE.Mesh(new THREE.BoxGeometry(1,8,22), barrierMat);
    w.position.set(x,4,0); w.castShadow = true; arenaGroup.add(w);
    // Glow effect
    const glow = new THREE.Mesh(new THREE.BoxGeometry(0.1,8,22), new THREE.MeshBasicMaterial({color:0x0044aa,transparent:true,opacity:0.3}));
    glow.position.set(x>0?x-0.5:x+0.5,4,0); arenaGroup.add(glow);
});

// Background scenery
const bgGeo = new THREE.PlaneGeometry(70,40);
const bgMat = new THREE.MeshLambertMaterial({ color: 0x050515 });
const bg = new THREE.Mesh(bgGeo, bgMat);
bg.position.set(0,5,-5); arenaGroup.add(bg);

// Decorative lights on walls
[-28,-14,0,14,28].forEach(x => {
    const light = new THREE.Mesh(new THREE.SphereGeometry(0.3), new THREE.MeshBasicMaterial({color:0x0044ff,transparent:true,opacity:0.8}));
    light.position.set(x,7,-4.5); arenaGroup.add(light);
});

scene.add(arenaGroup);

// Weather particles (rain)
let rainParticles = null, weatherMode = 'none';
function setWeather(mode) {
    weatherMode = mode;
    if(rainParticles) { scene.remove(rainParticles); rainParticles = null; }
    if(mode === 'rain') {
        const geo = new THREE.BufferGeometry();
        const count = 500;
        const pos = new Float32Array(count*3);
        for(let i=0;i<count;i++) { pos[i*3]=rand(-30,30); pos[i*3+1]=rand(0,20); pos[i*3+2]=rand(-5,5); }
        geo.setAttribute('position', new THREE.BufferAttribute(pos,3));
        rainParticles = new THREE.Points(geo, new THREE.PointsMaterial({color:0x8888ff,size:0.1,transparent:true,opacity:0.6}));
        scene.add(rainParticles);
    }
    if(mode==='fog') { scene.fog.near=10; scene.fog.far=60; }
    else { scene.fog.near=40; scene.fog.far=160; }
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// GAME STATE
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let currentSection = 1, currentWave = 1, maxWaves = 10;
let coins = 0;
let player, enemies = [], bosses = [];
let projectiles = [], particles = [], pickups = [], coinsPickups = [];
let gameRunning = false, gamePaused = false, inShop = false;
let shakeTime = 0, shakeX = 0, shakeY = 0;
let keys = {}, mobileKeys = {};
let hasGun = false, gunAmmo = 30;
let upgrades = { health: 100, speed: 8, damage: 1.0, power: 100, defense: 1.0, coinBonus: 1.0 };
let comboCount = 0, comboTimer = 0;
let iFrameTime = 0; // Invincibility frames
let dodgeCooldown = 0, dodging = false, dodgeTime = 0, dodgeDir = 1;
let gameMode = 'story'; // story or survival
let survivalWave = 0;
let killedLastFrame = false;
let totalGameTime = 0;

const STATES = { IDLE:0, WALK:1, PUNCH:2, KICK:3, BLOCK:4, SHOOT:5, DODGE:6, HURT:7, DEAD:8 };

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// HELPERS
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function rand(a,b) { return Math.random()*(b-a)+a; }
function clamp(v,a,b) { return Math.max(a,Math.min(b,v)); }

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// DAMAGE NUMBERS
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function spawnDmgNum(worldX, worldY, value, color='#ff4444', isHeal=false) {
    if(!cfg.dmgNums) return;
    // Convert world to screen
    const vec = new THREE.Vector3(worldX, worldY, 0);
    vec.project(camera);
    const sx = (vec.x * 0.5 + 0.5) * innerWidth;
    const sy = (-vec.y * 0.5 + 0.5) * innerHeight;
    const el = document.createElement('div');
    el.className = 'dmgNum';
    el.textContent = (isHeal?'+':'-') + Math.ceil(value);
    el.style.cssText = `left:${sx-20}px;top:${sy}px;color:${color};`;
    document.body.appendChild(el);
    setTimeout(() => el.remove(), 1000);
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// COMBO SYSTEM
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function addCombo() {
    comboCount++;
    comboTimer = 3.0;
    comboSnd(Math.min(comboCount, 20));
    const el = document.getElementById('comboDisplay');
    el.textContent = comboCount >= 2 ? `x${comboCount} COMBO!` : '';
    el.classList.toggle('active', comboCount >= 2);
    document.getElementById('comboCount').textContent = `x${comboCount}`;
    if(comboCount === 10) unlockAchievement('combo10');
}
function resetCombo() {
    comboCount = 0;
    comboTimer = 0;
    document.getElementById('comboDisplay').classList.remove('active');
    document.getElementById('comboCount').textContent = 'x0';
}
function comboDamageBonus() { return 1 + Math.min(comboCount * 0.05, 1.0); }

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// STICKMAN MODEL
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function makeStickman(color=0x00aaff, scale=1, isBoss=false) {
    const stick = new THREE.Group();

    const head = new THREE.Mesh(new THREE.SphereGeometry(0.45,12,8), new THREE.MeshLambertMaterial({color: isBoss?0xffaa44:0xffddaa}));
    head.position.y=2.2; head.castShadow=true; stick.add(head);

    // Eyes
    const eyeGeo = new THREE.SphereGeometry(0.08,6,6);
    const eyeMat = new THREE.MeshBasicMaterial({color: isBoss?0xff0000:0x222222});
    const eyeL = new THREE.Mesh(eyeGeo, eyeMat); eyeL.position.set(-0.16,0.05,0.42); head.add(eyeL);
    const eyeR = eyeL.clone(); eyeR.position.x=0.16; head.add(eyeR);

    const torso = new THREE.Mesh(new THREE.BoxGeometry(0.42,1.1,0.25), new THREE.MeshLambertMaterial({color}));
    torso.position.y=1.35; torso.castShadow=true; stick.add(torso);

    const armMat = new THREE.MeshLambertMaterial({color: isBoss?0x888888:0x666666});
    const armGeo = new THREE.CylinderGeometry(0.08,0.1,1.4,6);
    const leftArm = new THREE.Mesh(armGeo, armMat);
    leftArm.rotation.z=Math.PI/4; leftArm.position.set(-0.55,1.7,0); leftArm.castShadow=true;
    const gloveL = new THREE.Mesh(new THREE.SphereGeometry(0.16,8,6), new THREE.MeshLambertMaterial({color:isBoss?0x882200:0x222222}));
    gloveL.position.y=-0.67; leftArm.add(gloveL); stick.add(leftArm);
    const rightArm = leftArm.clone(); rightArm.position.x=0.55; rightArm.rotation.z=-Math.PI/4; stick.add(rightArm);

    const legMat = new THREE.MeshLambertMaterial({color: isBoss?0x666666:0x444444});
    const legGeo = new THREE.CylinderGeometry(0.07,0.09,1.6,6);
    const leftLeg = new THREE.Mesh(legGeo, legMat);
    leftLeg.position.set(-0.25,0.3,0); leftLeg.castShadow=true;
    const bootL = new THREE.Mesh(new THREE.BoxGeometry(0.28,0.22,0.32), new THREE.MeshLambertMaterial({color:0x111111}));
    bootL.position.y=-0.85; leftLeg.add(bootL); stick.add(leftLeg);
    const rightLeg = leftLeg.clone(); rightLeg.position.x=0.25; stick.add(rightLeg);

    // Health bar (3D)
    const hbBg = new THREE.Mesh(new THREE.PlaneGeometry(1.2,0.12), new THREE.MeshBasicMaterial({color:0x330000}));
    hbBg.position.y=2.9; hbBg.rotation.y=0; stick.add(hbBg);
    const hbFill = new THREE.Mesh(new THREE.PlaneGeometry(1.2,0.12), new THREE.MeshBasicMaterial({color: isBoss?0xffaa00:0x00ff44}));
    hbFill.position.set(-0,0,0.001); hbBg.add(hbFill);

    const hp = isBoss ? 600+currentSection*60 : 30+currentSection*4+rand(0,20);
    stick.userData = {
        hp, maxHp:hp,
        vx:0, vy:0, facing:1,
        state:STATES.IDLE, stateTime:0,
        block:false, isBoss, isEnemy:true,
        leftArm, rightArm, leftLeg, rightLeg, head, torso,
        jumpCount:0, aiTimer:0,
        hbFill, hbBg,
        invTimer:0,
        deadTimer:0,
        attackCooldown:0,
        specialCooldown:0,
        // Boss special ability cooldown
        bossCastTimer:0,
    };
    stick.scale.set(scale,scale,scale);
    return stick;
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// PLAYER
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
player = makeStickman(0x00aaff, 1.1);
player.position.set(-22, 0, 0);
player.userData.isEnemy = false;
player.userData.hp = upgrades.health;
player.userData.maxHp = upgrades.health;
scene.add(player);

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// PICKUPS
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function spawnPickup(type, pos) {
    let geo, mat, data;
    if(type==='gun') {
        geo=new THREE.BoxGeometry(0.9,0.2,0.35);
        mat=new THREE.MeshLambertMaterial({color:0x778899,emissive:0x334455,emissiveIntensity:0.5});
        data={type:'gun'};
    } else if(type==='health') {
        geo=new THREE.SphereGeometry(0.4,8,6);
        mat=new THREE.MeshLambertMaterial({color:0x00ff88,emissive:0x004422,emissiveIntensity:0.7});
        data={type:'health',amt:30};
    } else if(type==='coin') {
        geo=new THREE.CylinderGeometry(0.15,0.15,0.06,8);
        mat=new THREE.MeshLambertMaterial({color:0xffd700,emissive:0x886600,emissiveIntensity:0.8});
        const val=Math.floor((5+currentSection*2+rand(0,8))*upgrades.coinBonus);
        data={type:'coin',value:val};
    } else if(type==='power') {
        geo=new THREE.OctahedronGeometry(0.32);
        mat=new THREE.MeshLambertMaterial({color:0xff44ff,emissive:0x8800aa,emissiveIntensity:0.8});
        data={type:'power',amt:40};
    } else if(type==='ammo') {
        geo=new THREE.BoxGeometry(0.4,0.3,0.2);
        mat=new THREE.MeshLambertMaterial({color:0xffff44,emissive:0x888800,emissiveIntensity:0.6});
        data={type:'ammo',amt:20};
    }
    const pickup=new THREE.Mesh(geo,mat);
    pickup.position.copy(pos); pickup.position.y=1;
    pickup.userData=Object.assign({bobTime:rand(0,Math.PI*2)},data);
    pickup.castShadow=true;
    scene.add(pickup);
    (type==='coin'?coinsPickups:pickups).push(pickup);
    return pickup;
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// PARTICLES
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function spawnParticles(pos, col, cnt=18) {
    if(!cfg.particles) return;
    for(let i=0;i<cnt;i++) {
        const p=new THREE.Mesh(
            new THREE.SphereGeometry(0.07+rand(0,0.07)),
            new THREE.MeshBasicMaterial({color:col,transparent:true})
        );
        p.position.copy(pos);
        p.userData={vel:new THREE.Vector3(rand(-9,9),rand(3,14),rand(-2,2)),life:1.2+rand(0,0.5)};
        p.material.opacity=1;
        scene.add(p); particles.push(p);
    }
}

function spawnBlood(pos) {
    spawnParticles(pos, 0xaa0000, 12);
    spawnParticles(pos, 0xff4400, 6);
}

function spawnExplosion(pos) {
    spawnParticles(pos, 0xffaa00, 30);
    spawnParticles(pos, 0xff4400, 20);
    spawnParticles(pos, 0xffffff, 10);
    // Screen flash
    document.getElementById('hitFlash').style.background='rgba(255,150,0,0.3)';
    setTimeout(()=>document.getElementById('hitFlash').style.background='',200);
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// PROJECTILES
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function spawnProjectile(pos, vel, type, owner) {
    let col = owner.userData.isEnemy ? 0xff4400 : 0x00aaff;
    let radius = 0.4;
    if(type==='fireball') { col=0xff6600; radius=0.5; }
    if(type==='uppercut') { col=0xffff44; radius=0.3; }
    if(type==='iceball') { col=0x44aaff; radius=0.4; }
    if(type==='lightning') { col=0xffff00; radius=0.35; }

    const proj = new THREE.Mesh(
        new THREE.SphereGeometry(radius,8,6),
        new THREE.MeshLambertMaterial({color:col,emissive:col,emissiveIntensity:0.8})
    );
    proj.position.copy(pos);
    proj.userData={vel,life:3,dmg:(type==='fireball'?15:type==='uppercut'?38:12),owner,type,radius};
    scene.add(proj); projectiles.push(proj);
}

function shootBullet(fromStick) {
    const pos=fromStick.position.clone().add(new THREE.Vector3(fromStick.userData.facing*1.2,1.9,0));
    const bullet=new THREE.Mesh(
        new THREE.SphereGeometry(0.12,6,6),
        new THREE.MeshBasicMaterial({color:0xffff44})
    );
    bullet.position.copy(pos);
    bullet.userData={vel:new THREE.Vector3(fromStick.userData.facing*28,0,0),life:4,dmg:28,owner:fromStick,radius:0.15};
    scene.add(bullet); projectiles.push(bullet);
    stats.shots++;
    shootSnd();
    spawnParticles(pos, 0xffffaa, 4);
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// COIN PICKUP
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function spawnCoin(pos) { spawnPickup('coin', pos); }

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// ENEMY KILL & DEATH ANIMATION
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function killEnemy(enemy) {
    if(enemy.userData.state === STATES.DEAD) return;
    enemy.userData.state = STATES.DEAD;
    enemy.userData.deadTimer = 0;
    spawnBlood(enemy.position.clone().add(new THREE.Vector3(0,1.5,0)));

    if(enemy.userData.isBoss) {
        spawnExplosion(enemy.position.clone().add(new THREE.Vector3(0,2,0)));
        bossLight.intensity = 0;
        coins += Math.floor(50 * upgrades.coinBonus);
        stats.bossKills++;
        unlockAchievement('boss1');
    } else {
        coins += Math.floor(5 * upgrades.coinBonus);
    }

    // Drop coins & items
    for(let i=0;i<(enemy.userData.isBoss?5:1);i++) {
        spawnCoin(enemy.position.clone().add(new THREE.Vector3(rand(-2,2),0,0)));
    }
    if(Math.random() < 0.25) spawnPickup('health', enemy.position.clone());
    if(enemy.userData.isBoss && Math.random() < 0.5) spawnPickup('gun', enemy.position.clone());

    stats.kills++;
    if(stats.kills === 1) unlockAchievement('firstBlood');
    addCombo();
    deathSnd();
    updateUI();
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// WAVE SYSTEM
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function startWave() {
    enemies = []; bosses = [];
    const baseCount = Math.min(2 + Math.floor(currentWave/2) + Math.floor(currentSection/2), 10);
    const isBossWave = currentWave === maxWaves;

    // Difficulty scaling
    const diff = 1 + currentSection * 0.08 + currentWave * 0.03;

    for(let i=0;i<(isBossWave?0:baseCount);i++) {
        const enemy = makeStickman(new THREE.Color().setHSL(rand(0,0.1), 1, 0.5).getHex(), 0.85+rand(0,0.25));
        enemy.position.set(rand(5,26), 0, 0);
        // Scale hp with difficulty
        enemy.userData.hp = Math.floor(enemy.userData.hp * diff);
        enemy.userData.maxHp = enemy.userData.hp;
        scene.add(enemy); enemies.push(enemy);
    }

    if(isBossWave) {
        const boss = makeStickman(0xffaa00, 1.9, true);
        boss.position.set(18, 0, 0);
        boss.userData.hp = Math.floor(boss.userData.hp * diff);
        boss.userData.maxHp = boss.userData.hp;
        scene.add(boss); bosses.push(boss);
        bossLight.intensity = 2;
        bossSnd();
        setWeather(currentSection%3===0?'rain':'none');
        // Boss theme music
        playBGM(currentSection+8);
    } else {
        setWeather('none');
        playBGM(currentSection);
    }

    updateUI();
}

function clearWave() {
    // Clean up dead enemies
    [...enemies,...bosses].forEach(e => scene.remove(e));
    enemies=[]; bosses=[];
    stats.wavesCleared++;

    currentWave++;
    if(currentWave > maxWaves) {
        currentSection++;
        if(currentSection > 16) {
            // Grand victory!
            unlockAchievement('survive16');
            showGameOver('GRAND CHAMPION! YOU WIN! ğŸ†', true);
            return;
        }
        if(currentSection >= 5) unlockAchievement('section5');
        inShop=true;
        document.getElementById('shop').classList.add('active');
        updateShop();
        return;
    }
    // Spawn some pickups between waves
    if(Math.random()<0.4) spawnPickup('health', new THREE.Vector3(rand(-20,20),0,0));
    setTimeout(startWave, 1800);
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// SURVIVAL MODE
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function startSurvivalWave() {
    survivalWave++;
    enemies=[]; bosses=[];
    const count = 2 + Math.floor(survivalWave/2);
    for(let i=0;i<Math.min(count,12);i++) {
        const e = makeStickman(new THREE.Color().setHSL(rand(0,0.15),1,0.5).getHex(), 0.85+rand(0,0.3));
        e.position.set(rand(-25,25),0,0);
        e.userData.hp = Math.floor((20+survivalWave*8)*rand(0.8,1.3));
        e.userData.maxHp = e.userData.hp;
        scene.add(e); enemies.push(e);
    }
    if(survivalWave%5===0) {
        const boss=makeStickman(0xffaa00,1.8,true);
        boss.position.set(18,0,0);
        scene.add(boss); bosses.push(boss);
        bossSnd();
    }
    document.getElementById('modeTxt').textContent = `SURVIVAL W${survivalWave}`;
    updateUI();
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// ENEMY AI
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function updateEnemyAI(stick, dt) {
    const ud = stick.userData;
    if(ud.state===STATES.DEAD) return;

    const px = player.position.x, sx = stick.position.x;
    const dist = Math.abs(sx - px);
    const diff = 1 + currentSection * 0.05;

    ud.aiTimer += dt;
    ud.attackCooldown = Math.max(0, ud.attackCooldown - dt);
    ud.bossCastTimer = Math.max(0, ud.bossCastTimer - dt);

    // Move toward player
    if(dist > 3.5) {
        ud.vx = Math.sign(px - sx) * (4 + currentSection * 0.3) * diff;
        ud.facing = Math.sign(px - sx);
    } else {
        ud.vx *= 0.85;
        // Attack in range
        if(ud.attackCooldown <= 0 && ud.aiTimer > 0.5) {
            const r = Math.random();
            if(r < 0.45) { ud.state=STATES.PUNCH; ud.stateTime=0; ud.attackCooldown=0.8+rand(0,0.5); }
            else if(r < 0.7) { ud.state=STATES.KICK; ud.stateTime=0; ud.attackCooldown=1.0+rand(0,0.5); }
            ud.aiTimer=0;
        }
    }

    // Ranged attack (later waves)
    if(dist > 6 && currentWave > 3 && ud.bossCastTimer<=0) {
        if(Math.random() < 0.008*diff) {
            const type = ud.isBoss && currentSection>8 ? 'lightning' : 'fireball';
            spawnProjectile(
                stick.position.clone().add(new THREE.Vector3(ud.facing,1.8,0)),
                new THREE.Vector3(ud.facing*12,rand(2,5),0), type, stick
            );
            ud.bossCastTimer = 1.5;
        }
    }

    // Boss special: jump slam
    if(ud.isBoss && ud.jumpCount===0 && Math.random()<0.003*diff) {
        ud.vy=18; ud.jumpCount=1;
    }

    // Occasional jump
    if(Math.random()<0.004 && ud.jumpCount<1) { ud.vy=14; ud.jumpCount=1; }
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// PLAYER UPDATE
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function updatePlayer(dt) {
    const ud = player.userData;
    if(ud.state===STATES.DEAD) {
        ud.deadTimer += dt;
        player.rotation.z = Math.min(Math.PI/2, ud.deadTimer*3);
        return;
    }

    // Invincibility frames
    if(iFrameTime > 0) {
        iFrameTime -= dt;
        player.visible = Math.floor(iFrameTime*10)%2===0 ? false : true;
        if(iFrameTime<=0) { player.visible=true; }
    }

    // Dodge
    dodgeCooldown = Math.max(0, dodgeCooldown-dt);
    if(dodging) {
        dodgeTime -= dt;
        ud.vx = dodgeDir * upgrades.speed * 2.5;
        if(dodgeTime<=0) { dodging=false; }
    }

    // Power regen
    if(upgrades.power < 100) upgrades.power = Math.min(100, upgrades.power + 8*dt);

    // Input
    const left  = keys['KeyA'] || keys['ArrowLeft'] || mobileKeys['A'];
    const right = keys['KeyD'] || keys['ArrowRight'] || mobileKeys['D'];
    const jump  = keys['KeyW'] || keys['ArrowUp'] || keys['Space'] || mobileKeys['W'];

    if(!dodging) {
        ud.vx = 0;
        if(left)  { ud.vx = -upgrades.speed; ud.facing=-1; }
        if(right) { ud.vx =  upgrades.speed;  ud.facing=1;  }
    }

    // Jump
    if((jump||mobileKeys['W']) && ud.jumpCount<2) {
        if(!ud._jumpHeld) { ud.vy=15; ud.jumpCount++; ud._jumpHeld=true; }
    } else { ud._jumpHeld=false; }

    // Attack actions (edge-detect to avoid repeat fire)
    if((keys['KeyZ']||mobileKeys['Z']) && ud.state!==STATES.PUNCH) {
        ud.state=STATES.PUNCH; ud.stateTime=0; punchSnd();
    }
    if((keys['KeyX']||mobileKeys['X']) && ud.state!==STATES.KICK) {
        ud.state=STATES.KICK; ud.stateTime=0; kickSnd();
    }

    // Block
    ud.block = !!(keys['KeyC']||mobileKeys['C']);
    if(ud.block) ud.state=STATES.BLOCK;

    // Dodge roll
    if((keys['KeyQ']||mobileKeys['Q']) && dodgeCooldown<=0 && !dodging) {
        dodging=true; dodgeTime=0.35; dodgeCooldown=1.2;
        dodgeDir=ud.facing; iFrameTime=0.35;
        dodgeSnd(); stats.dodges++;
        if(stats.dodges>=5) unlockAchievement('dodge5');
    }

    // Shoot
    if((keys['KeyV']||mobileKeys['V']) && hasGun && gunAmmo>0) {
        if(!ud._shootHeld) { ud.state=STATES.SHOOT; ud.stateTime=0; shootBullet(player); gunAmmo--; ud._shootHeld=true; updateUI(); }
    } else { ud._shootHeld=false; }

    // Special (uppercut)
    if((keys['KeyB']||mobileKeys['B']) && upgrades.power>=30) {
        const pos=player.position.clone().add(new THREE.Vector3(ud.facing,1.6,0));
        spawnProjectile(pos, new THREE.Vector3(ud.facing*16,7,0), 'uppercut', player);
        upgrades.power-=30;
    }

    // State auto-reset
    ud.stateTime += dt;
    if(ud.stateTime>0.55 && ud.state!==STATES.BLOCK && ud.state!==STATES.DEAD) {
        ud.state = (Math.abs(ud.vx)>0.5 ? STATES.WALK : STATES.IDLE);
    }
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// STICKMAN PHYSICS & ANIMATION
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function updateStickman(stick, dt) {
    const ud = stick.userData;
    if(ud.state===STATES.DEAD) return;

    // Physics
    ud.vy -= 28 * dt;
    stick.position.y = Math.max(0, stick.position.y + ud.vy * dt);
    if(stick.position.y <= 0) { ud.vy=0; ud.jumpCount=0; }
    stick.position.x = clamp(stick.position.x + ud.vx * dt, -28, 28);

    // Facing
    stick.rotation.y = ud.facing>0 ? 0 : Math.PI;

    // Health bar
    const hpRatio = clamp(ud.hp/ud.maxHp, 0, 1);
    ud.hbFill.scale.x = hpRatio;
    ud.hbFill.position.x = (hpRatio-1)*0.6;
    ud.hbBg.visible = ud.isEnemy;

    // Animation
    const t = Date.now()/1000;
    const w = Math.abs(ud.vx)>0.5;
    if(ud.state===STATES.WALK||w) {
        ud.leftLeg.rotation.x  = Math.sin(t*12)*1.1;
        ud.rightLeg.rotation.x = Math.sin(t*12+Math.PI)*1.1;
        ud.leftArm.rotation.x  = Math.sin(t*12+Math.PI)*0.5;
        ud.rightArm.rotation.x = Math.sin(t*12)*0.5;
        // Subtle torso bob
        stick.position.y = stick.position.y>0.05 ? stick.position.y : 0.08+Math.abs(Math.sin(t*12))*0.05;
    } else if(ud.state===STATES.IDLE) {
        ud.leftLeg.rotation.x=ud.rightLeg.rotation.x=0;
        ud.leftArm.rotation.x=ud.rightArm.rotation.x=0;
        ud.leftArm.rotation.z=Math.PI/4; ud.rightArm.rotation.z=-Math.PI/4;
        // Idle sway
        stick.rotation.z=Math.sin(t*1.5)*0.02;
    } else if(ud.state===STATES.PUNCH) {
        const pt=ud.stateTime*10;
        ud.rightArm.rotation.x=-1.8+Math.sin(pt)*0.6; ud.rightArm.rotation.z=-0.1;
        ud.torso.rotation.z=Math.sin(pt)*0.2;
    } else if(ud.state===STATES.KICK) {
        const kt=ud.stateTime*10;
        ud.rightLeg.rotation.x=-1.6+Math.sin(kt)*0.5; ud.rightLeg.position.z=Math.sin(kt)*0.5;
    } else if(ud.state===STATES.SHOOT) {
        ud.rightArm.rotation.x=-1.2; ud.rightArm.rotation.z=-0.2;
    } else if(ud.state===STATES.BLOCK) {
        ud.leftArm.rotation.x=ud.rightArm.rotation.x=-0.9;
        ud.leftArm.rotation.z=0.5; ud.rightArm.rotation.z=-0.5;
    } else if(ud.state===STATES.HURT) {
        stick.rotation.z=Math.sin(Date.now()*0.05)*0.2;
    }
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// HIT FLASH
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function playerHitFlash() {
    document.getElementById('hitFlash').style.background='rgba(255,0,0,0.25)';
    setTimeout(()=>document.getElementById('hitFlash').style.background='',120);
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// COLLISIONS
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function checkCollisions(dt) {
    const allEnemies=[...enemies,...bosses].filter(e=>e.userData.state!==STATES.DEAD);

    // Melee
    allEnemies.forEach(enemy=>{
        const ud=enemy.userData;
        const ex=enemy.position.x, px=player.position.x;
        const dist=Math.abs(ex-px);

        // Player attacks enemy
        if(player.userData.state===STATES.PUNCH && dist<2.8 && !ud.block) {
            const dmg=Math.floor((12+currentSection*0.5)*upgrades.damage*comboDamageBonus());
            ud.hp-=dmg; stats.damageDealt+=dmg;
            spawnParticles(enemy.position.clone().add(new THREE.Vector3(0,1.5,0)), 0x00ff88, 10);
            spawnDmgNum(enemy.position.x, enemy.position.y+2.5, dmg, '#00ff88');
            shakeTime=cfg.shake?0.12:0;
            addCombo();
            if(ud.hp<=0) killEnemy(enemy);
        }
        if(player.userData.state===STATES.KICK && dist<3.5 && !ud.block) {
            const dmg=Math.floor((18+currentSection*0.7)*upgrades.damage*comboDamageBonus());
            ud.hp-=dmg; stats.damageDealt+=dmg;
            spawnParticles(enemy.position.clone().add(new THREE.Vector3(0,1.0,0)), 0xffaa00, 8);
            spawnDmgNum(enemy.position.x, enemy.position.y+2.2, dmg, '#ffaa00');
            shakeTime=cfg.shake?0.18:0;
            addCombo();
            if(ud.hp<=0) killEnemy(enemy);
        }

        // Enemy attacks player (no damage during iframes or dodge)
        if(iFrameTime>0 || dodging) return;
        if(ud.state===STATES.PUNCH && dist<2.3 && !player.userData.block) {
            const dmg=Math.floor((8+currentSection)*upgrades.defense);
            player.userData.hp-=dmg; stats.damageTaken+=dmg;
            spawnParticles(player.position.clone().add(new THREE.Vector3(0,1.5,0)), 0xff4444, 8);
            spawnDmgNum(player.position.x, player.position.y+2.5, dmg, '#ff4444');
            playerHitFlash();
            shakeTime=cfg.shake?0.1:0;
            iFrameTime=0.4;
            resetCombo();
            if(player.userData.hp<=0) playerDeath();
        }
        if(ud.state===STATES.KICK && dist<3.0 && !player.userData.block) {
            const dmg=Math.floor((13+currentSection*0.8)*upgrades.defense);
            player.userData.hp-=dmg; stats.damageTaken+=dmg;
            spawnParticles(player.position.clone().add(new THREE.Vector3(0,1.0,0)), 0xff6644, 6);
            spawnDmgNum(player.position.x, player.position.y+2.2, dmg, '#ff6644');
            playerHitFlash();
            shakeTime=cfg.shake?0.15:0;
            iFrameTime=0.4;
            resetCombo();
            if(player.userData.hp<=0) playerDeath();
        }
    });

    // Projectiles
    for(let i=projectiles.length-1;i>=0;i--) {
        const proj=projectiles[i];
        proj.position.addScaledVector(proj.userData.vel,dt);
        proj.userData.life-=dt;
        proj.rotation.z+=dt*10;

        // Enemy projectile hits player
        if(proj.userData.owner?.userData?.isEnemy && iFrameTime<=0 && !dodging) {
            if(proj.position.distanceTo(player.position)<proj.userData.radius+0.8) {
                if(!player.userData.block) {
                    const dmg=Math.floor(proj.userData.dmg*upgrades.defense);
                    player.userData.hp-=dmg; stats.damageTaken+=dmg;
                    spawnParticles(player.position, 0xff4444, 10);
                    spawnDmgNum(player.position.x,player.position.y+2,dmg,'#ff4444');
                    playerHitFlash();
                    shakeTime=cfg.shake?0.2:0;
                    iFrameTime=0.5;
                    resetCombo();
                    if(player.userData.hp<=0) playerDeath();
                }
                scene.remove(proj); projectiles.splice(i,1); continue;
            }
        }

        // Player projectile hits enemy
        let removed=false;
        for(const e of allEnemies) {
            if(!proj.userData.owner?.userData?.isEnemy && proj.userData.owner!==e) {
                if(proj.position.distanceTo(e.position)<proj.userData.radius+0.9) {
                    const dmg=Math.floor(proj.userData.dmg*upgrades.damage);
                    e.userData.hp-=dmg; stats.damageDealt+=dmg;
                    spawnParticles(e.position.clone().add(new THREE.Vector3(0,1.5,0)), 0x00ff88, 8);
                    spawnDmgNum(e.position.x,e.position.y+2,dmg,'#00ff88');
                    addCombo();
                    if(e.userData.hp<=0) killEnemy(e);
                    scene.remove(proj); projectiles.splice(i,1); removed=true; break;
                }
            }
        }
        if(removed) continue;

        if(proj.userData.life<=0 || Math.abs(proj.position.x)>36) {
            scene.remove(proj); projectiles.splice(i,1);
        }
    }

    // Pickups
    const allPickups=[...pickups,...coinsPickups];
    for(let i=allPickups.length-1;i>=0;i--) {
        const pu=allPickups[i];
        pu.userData.bobTime+=dt*3;
        pu.position.y=1+Math.sin(pu.userData.bobTime)*0.3;
        pu.rotation.y+=dt*2;
        if(pu.position.distanceTo(player.position)<2.2) {
            const t=pu.userData.type;
            if(t==='gun') { hasGun=true; gunAmmo=30; document.getElementById('btnShoot').style.display='block'; document.getElementById('crosshair').style.display='block'; document.getElementById('weaponTxt').textContent='ğŸ”« Gun (30)'; pickupSnd(); }
            else if(t==='health') { const h=Math.min(player.userData.maxHp,player.userData.hp+pu.userData.amt); spawnDmgNum(player.position.x,player.position.y+2.5,pu.userData.amt,'#00ff88',true); player.userData.hp=h; pickupSnd(); }
            else if(t==='coin') { coins+=pu.userData.value; stats.coinsTotal+=pu.userData.value; coinSnd(); spawnDmgNum(pu.position.x,pu.position.y+1,pu.userData.value,'#ffd700',true); if(stats.coinsTotal>=500) unlockAchievement('rich'); }
            else if(t==='power') { upgrades.power=Math.min(100,upgrades.power+pu.userData.amt); pickupSnd(); }
            else if(t==='ammo') { gunAmmo+=pu.userData.amt; pickupSnd(); }
            scene.remove(pu);
            if(coinsPickups.includes(pu)) coinsPickups.splice(coinsPickups.indexOf(pu),1);
            else pickups.splice(pickups.indexOf(pu),1);
            updateUI();
        }
    }

    // Particles
    for(let i=particles.length-1;i>=0;i--) {
        const p=particles[i];
        p.position.addScaledVector(p.userData.vel,dt);
        p.userData.vel.y-=28*dt;
        p.userData.life-=dt;
        p.material.opacity=Math.max(0,p.userData.life/1.5);
        if(p.userData.life<=0) { scene.remove(p); particles.splice(i,1); }
    }

    // Rain update
    if(rainParticles) {
        const pos=rainParticles.geometry.attributes.position.array;
        for(let i=1;i<pos.length;i+=3) {
            pos[i]-=20*dt;
            if(pos[i]<-1) pos[i]=20;
        }
        rainParticles.geometry.attributes.position.needsUpdate=true;
    }

    // Wave clear check
    const alive=enemies.filter(e=>e.userData.state!==STATES.DEAD).length
               +bosses.filter(b=>b.userData.state!==STATES.DEAD).length;
    if(alive===0 && !killedLastFrame) {
        killedLastFrame=true;
        if(gameMode==='survival') setTimeout(()=>{ killedLastFrame=false; startSurvivalWave(); },1500);
        else setTimeout(()=>{ killedLastFrame=false; clearWave(); },1500);
    }
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// PLAYER DEATH
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function playerDeath() {
    player.userData.state=STATES.DEAD;
    player.userData.hp=0;
    gameRunning=false;
    deathSnd();
    spawnExplosion(player.position.clone().add(new THREE.Vector3(0,1,0)));
    setTimeout(()=>showGameOver('DEFEATED! ğŸ’€', false), 1200);
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// UI
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function updateUI() {
    const hpRatio=clamp(player.userData.hp/player.userData.maxHp,0,1);
    document.getElementById('hpbar').style.width=hpRatio*100+'%';
    document.getElementById('hpbar').style.background=hpRatio<0.25?'#ff2200':hpRatio<0.5?'#ffaa00':'linear-gradient(90deg,#ff4444,#00ff88)';
    document.getElementById('powerbar').style.width=clamp(upgrades.power,0,100)+'%';
    document.getElementById('sectionTxt').textContent=currentSection;
    document.getElementById('waveTxt').textContent=`${currentWave}/${maxWaves}`;
    const aliveE=enemies.filter(e=>e.userData.state!==STATES.DEAD).length+bosses.filter(b=>b.userData.state!==STATES.DEAD).length;
    document.getElementById('enemiesLeft').textContent=aliveE;
    document.getElementById('coins').textContent=`ğŸ’° ${coins}`;
    if(hasGun) document.getElementById('weaponTxt').textContent=`ğŸ”« Gun (${gunAmmo})`;
    else document.getElementById('weaponTxt').textContent='ğŸ‘Š Fists';
    if(gunAmmo<=0 && hasGun) { hasGun=false; document.getElementById('btnShoot').style.display='none'; document.getElementById('crosshair').style.display='none'; }
}

function showGameOver(text, win) {
    document.getElementById('winnerText').textContent=text;
    const mins=Math.floor((Date.now()-stats.startTime)/60000);
    document.getElementById('finalStats').innerHTML=`
        Kills: ${stats.kills} | Coins: ${stats.coinsTotal}<br>
        Section ${currentSection} | Wave ${currentWave}<br>
        Time: ${mins}m | Combo Max: ${comboCount}
    `;
    document.getElementById('gameover').classList.add('active');
    gameRunning=false;
    save();
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// SHOP SYSTEM
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const shopItemsDef = [
    {id:'health',    name:'Max Health +60',     cost:50,  desc:'Increases max HP and restores fully',   effect:()=>{ upgrades.health+=60; player.userData.maxHp=upgrades.health; player.userData.hp=upgrades.health; }},
    {id:'speed',     name:'Speed +1',            cost:80,  desc:'Move faster across the arena',         effect:()=>upgrades.speed+=1},
    {id:'damage',    name:'Damage +25%',         cost:100, desc:'All attacks deal more damage',         effect:()=>upgrades.damage+=0.25},
    {id:'defense',   name:'Defense +20%',        cost:90,  desc:'Take less damage from attacks',        effect:()=>upgrades.defense=Math.max(0.1,upgrades.defense-0.2)},
    {id:'coinbonus', name:'Coin Magnet +20%',    cost:60,  desc:'Earn more coins from all sources',    effect:()=>upgrades.coinBonus+=0.2},
    {id:'gunammo',   name:'Gun + Ammo (x50)',    cost:40,  desc:'Refill gun with 50 ammo',              effect:()=>{ gunAmmo=50; hasGun=true; document.getElementById('btnShoot').style.display='block'; document.getElementById('crosshair').style.display='block'; }},
    {id:'fullheal',  name:'Full Restore',        cost:120, desc:'Restore all HP and power',             effect:()=>{ player.userData.hp=player.userData.maxHp; upgrades.power=100; }},
    {id:'power',     name:'Power Upgrade +20',   cost:70,  desc:'Increase max power for specials',      effect:()=>{ upgrades.power=100; }},
    {id:'sellgun',   name:'Super Ammo (x100)',   cost:60,  desc:'100 shots, no reload needed',          effect:()=>{ gunAmmo=100; hasGun=true; document.getElementById('btnShoot').style.display='block'; document.getElementById('crosshair').style.display='block'; }},
];

function updateShop() {
    document.getElementById('shopCoinAmt').textContent=coins;
    const c=document.getElementById('shopItems');
    c.innerHTML='';
    shopItemsDef.forEach(item=>{
        const btn=document.createElement('button');
        btn.className='shopBtn';
        btn.disabled=coins<item.cost;
        btn.innerHTML=`<div class="item-name">${item.name}</div><div class="item-cost">ğŸ’° ${item.cost}</div><div class="item-desc">${item.desc}</div>`;
        btn.onclick=()=>{
            if(coins>=item.cost){ coins-=item.cost; item.effect(); updateShop(); updateUI(); coinSnd(); }
        };
        c.appendChild(btn);
    });
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// PAUSE SYSTEM
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function pauseGame() {
    if(!gameRunning||inShop) return;
    gamePaused=true; gameRunning=false;
    document.getElementById('pauseMenu').classList.add('active');
}
function resumeGame() {
    gamePaused=false; gameRunning=true;
    document.getElementById('pauseMenu').classList.remove('active');
    document.getElementById('settings').classList.remove('active');
    document.getElementById('statsPanel').classList.remove('active');
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// INPUT
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.addEventListener('keydown', e=>{
    keys[e.code]=true;
    if(e.code==='KeyP'||e.code==='Escape') {
        if(gamePaused) resumeGame(); else pauseGame();
    }
    if(e.code==='KeyR'&&!gameRunning) location.reload();
    e.preventDefault();
}, {passive:false});
document.addEventListener('keyup', e=>{ keys[e.code]=false; });

// Combo timer in update loop
function updateComboTimer(dt) {
    if(comboCount>0) {
        comboTimer-=dt;
        if(comboTimer<=0) resetCombo();
    }
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// MINIMAP
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const minimapCanvas=document.getElementById('minimap');
const mmCtx=minimapCanvas.getContext('2d');
function drawMinimap() {
    mmCtx.clearRect(0,0,130,30);
    mmCtx.fillStyle='rgba(0,0,20,0.8)'; mmCtx.fillRect(0,0,130,30);
    const toMM=x=>((x+29)/58)*120+5;
    // Player
    mmCtx.fillStyle='#00aaff'; mmCtx.fillRect(toMM(player.position.x)-3,12,6,6);
    // Enemies
    [...enemies,...bosses].forEach(e=>{
        if(e.userData.state===STATES.DEAD) return;
        mmCtx.fillStyle=e.userData.isBoss?'#ffaa00':'#ff4400';
        mmCtx.fillRect(toMM(e.position.x)-2,14,4,4);
    });
    // Pickups
    pickups.forEach(p=>{ mmCtx.fillStyle='#00ff88'; mmCtx.fillRect(toMM(p.position.x)-1,16,2,2); });
    coinsPickups.forEach(p=>{ mmCtx.fillStyle='#ffd700'; mmCtx.fillRect(toMM(p.position.x)-1,16,2,2); });
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// MOBILE JOYSTICK
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const joystickBase=document.getElementById('joystickBase');
const joystickKnob=document.getElementById('joystickKnob');
let joyActive=false, joyId=-1, joyBaseX=0,joyBaseY=0;
joystickBase.addEventListener('touchstart',e=>{
    const t=e.touches[0];
    joyActive=true; joyId=t.identifier;
    const r=joystickBase.getBoundingClientRect();
    joyBaseX=r.left+r.width/2; joyBaseY=r.top+r.height/2;
},{passive:true});
document.addEventListener('touchmove',e=>{
    for(let t of e.touches) {
        if(t.identifier===joyId) {
            const dx=clamp(t.clientX-joyBaseX,-50,50);
            const dy=clamp(t.clientY-joyBaseY,-50,50);
            joystickKnob.style.left=(35+dx)+'px'; joystickKnob.style.top=(35+dy)+'px';
            mobileKeys['A']=dx<-10; mobileKeys['D']=dx>10;
        }
    }
},{passive:true});
document.addEventListener('touchend',e=>{
    for(let t of e.changedTouches) {
        if(t.identifier===joyId) {
            joyActive=false; mobileKeys['A']=false; mobileKeys['D']=false;
            joystickKnob.style.left='35px'; joystickKnob.style.top='35px';
        }
    }
});

// Mobile action buttons
function bindBtn(id, key) {
    const el=document.getElementById(id);
    el.addEventListener('touchstart',e=>{mobileKeys[key]=true;e.preventDefault();},{passive:false});
    el.addEventListener('touchend',e=>{mobileKeys[key]=false;e.preventDefault();},{passive:false});
    el.addEventListener('touchcancel',e=>{mobileKeys[key]=false;},{passive:true});
}
bindBtn('btnJump','W'); bindBtn('btnPunch','Z'); bindBtn('btnKick','X');
bindBtn('btnBlock','C'); bindBtn('btnDodge','Q'); bindBtn('btnShoot','V'); bindBtn('btnSpecial','B');

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// GAME START
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.startGame = function(mode) {
    gameMode = mode;
    document.getElementById('menu').classList.remove('active');
    document.getElementById('modeTxt').textContent = mode.toUpperCase();
    audioContext.resume();
    gameRunning=true;
    stats.startTime=Date.now();
    if(mode==='survival') {
        survivalWave=0;
        startSurvivalWave();
    } else {
        startWave();
    }
};

window.continueStory = function() {
    document.getElementById('shop').classList.remove('active');
    inShop=false; currentWave=1;
    // Spawn pickups between sections
    for(let i=0;i<3;i++) spawnPickup(['health','ammo','power'][i%3], new THREE.Vector3(rand(-18,18),0,0));
    startWave();
    gameRunning=true;
};

window.toggleMobile = toggleMobile;
window.showSettings = showSettings;
window.closeSettings = closeSettings;
window.showTutorial = showTutorial;
window.closeTutorial = closeTutorial;
window.resumeGame = resumeGame;
window.showStatsNow = showStatsNow;

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// AMBIENT LIGHTING CHANGES
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function updateAmbientLighting(section) {
    const colors=[0x222244,0x332211,0x112233,0x221133,0x113322,0x332200,0x221144,0x113311];
    ambient.color.setHex(colors[(section-1)%colors.length]);
    const playerColors=[0x00aaff,0xaa6600,0x00ffaa,0xaa00ff,0x00ffff,0xff6600,0x0088ff,0xffaa00];
    dirLight.color.setHex(playerColors[(section-1)%playerColors.length]);
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// CAMERA SHAKE
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function applyShake(dt) {
    if(shakeTime>0) {
        shakeX=Math.sin(Date.now()*0.05)*(shakeTime*3);
        shakeY=Math.cos(Date.now()*0.07)*(shakeTime*2);
        shakeTime-=dt;
    } else { shakeX*=0.85; shakeY*=0.85; }
    camera.position.set(shakeX, 10+shakeY, 40);
    camera.lookAt(shakeX*0.1, shakeY*0.1, 0);
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// MAIN LOOP
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let lastTime=0;
function animate(time) {
    requestAnimationFrame(animate);
    const dt=Math.min(0.05,(time-(lastTime||time))/1000);
    lastTime=time;

    if(gameRunning && !gamePaused) {
        totalGameTime+=dt;
        updatePlayer(dt);
        [...enemies,...bosses].forEach(e=>{
            if(e.userData.state!==STATES.DEAD) {
                updateEnemyAI(e, dt);
                updateStickman(e, dt);
            } else {
                // Death animation
                e.userData.deadTimer=(e.userData.deadTimer||0)+dt;
                e.rotation.z=Math.min(Math.PI/2, e.userData.deadTimer*4);
                e.position.y=Math.max(-1, e.position.y-5*dt);
                if(e.userData.deadTimer>1.2) {
                    // Remove from scene completely
                    scene.remove(e);
                    enemies=enemies.filter(x=>x!==e);
                    bosses=bosses.filter(x=>x!==e);
                }
            }
        });
        updateStickman(player, dt);
        checkCollisions(dt);
        updateComboTimer(dt);
        applyShake(dt);
        updateAmbientLighting(currentSection);

        // Update UI periodically
        if(Math.floor(totalGameTime*20)%4===0) {
            updateUI();
            drawMinimap();
        }
    } else {
        applyShake(dt);
    }

    renderer.render(scene, camera);
}

requestAnimationFrame(animate);

console.log('ğŸ¦¾ Stickman Rage: Arena Fury 3D - Enhanced Edition Loaded!');
</script>
</body>
</html>
