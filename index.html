<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Stickman Rage: Arena Fury</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
html,body{width:100%;height:100%;overflow:hidden;background:#000;font-family:'Arial Black',Impact,sans-serif;touch-action:none;user-select:none}
canvas{display:block}

.screen{position:fixed;inset:0;display:none;flex-direction:column;align-items:center;justify-content:center;z-index:100;gap:14px;padding:20px;overflow-y:auto}
.screen.show{display:flex}
#loadScreen{background:#000011;z-index:200}
#menuScreen{background:rgba(0,0,15,0.97)}
#shopScreen{background:rgba(0,0,15,0.97)}
#pauseScreen{background:rgba(0,0,20,0.93)}
#settingsScreen{background:rgba(0,0,20,0.96)}
#tutScreen{background:rgba(0,0,20,0.95)}
#gameoverScreen{background:rgba(0,0,0,0.92)}

#loadScreen::before{content:'';position:absolute;inset:0;background:repeating-linear-gradient(0deg,transparent,transparent 2px,rgba(0,0,0,0.07) 2px,rgba(0,0,0,0.07) 4px);pointer-events:none}
#loadBg{position:absolute;inset:0;overflow:hidden;pointer-events:none}
.lstar{position:absolute;border-radius:50%;animation:starDrift linear infinite}
@keyframes starDrift{from{transform:translateY(100vh) scale(0);opacity:0}10%{opacity:1}90%{opacity:.6}to{transform:translateY(-10vh) scale(1.5);opacity:0}}
#loadContent{position:relative;display:flex;flex-direction:column;align-items:center;gap:18px}
#loadStick{width:80px;height:110px;animation:stickBounce .6s ease-in-out infinite alternate}
@keyframes stickBounce{from{transform:translateY(0)}to{transform:translateY(-12px)}}
#loadRing{position:absolute;width:110px;height:110px;border-radius:50%;background:radial-gradient(circle,rgba(0,255,255,.18) 0%,transparent 70%);box-shadow:0 0 40px rgba(0,255,255,.4);animation:ringPulse 1.2s ease-in-out infinite;top:-10px;left:-15px}
@keyframes ringPulse{0%,100%{transform:scale(1);opacity:.7}50%{transform:scale(1.12);opacity:1}}
#loadTitle{font-size:clamp(22px,5vw,36px);letter-spacing:2px;text-align:center;line-height:1.2;background:linear-gradient(90deg,#00ffff 0%,#ff4400 50%,#ffd700 100%);background-size:200% auto;-webkit-background-clip:text;-webkit-text-fill-color:transparent;animation:titleShine 1.5s linear infinite}
@keyframes titleShine{from{background-position:0% center}to{background-position:200% center}}
#loadSub{font-size:11px;color:#556;letter-spacing:4px;text-transform:uppercase;margin-top:-10px}
#loadBarWrap{display:flex;flex-direction:column;align-items:center;gap:8px}
#loadBar{width:min(340px,80vw);height:6px;background:rgba(255,255,255,.06);border-radius:3px;overflow:visible;position:relative}
#loadFill{height:100%;width:0%;background:linear-gradient(90deg,#00ffff,#0044ff,#00ffff);background-size:200% 100%;border-radius:3px;transition:width .25s cubic-bezier(.4,0,.2,1);animation:barShimmer 1s linear infinite;box-shadow:0 0 10px #00ffff,0 0 20px rgba(0,200,255,.4);position:relative}
#loadFill::after{content:'';position:absolute;right:-4px;top:50%;transform:translateY(-50%);width:10px;height:10px;border-radius:50%;background:#fff;box-shadow:0 0 8px #00ffff,0 0 16px #00ffff}
@keyframes barShimmer{from{background-position:0% 0}to{background-position:200% 0}}
#loadStatus{font-size:11px;color:#00ffff;letter-spacing:3px;text-transform:uppercase;opacity:.7;animation:sBlink .8s ease-in-out infinite}
@keyframes sBlink{0%,100%{opacity:.4}50%{opacity:1}}
#loadPct{font-size:12px;color:#fff;opacity:.5}
#loadScreen.fadeout{opacity:0;transition:opacity .5s;pointer-events:none}

#menuScreen h1{font-size:clamp(20px,4vw,38px);text-align:center;background:linear-gradient(90deg,#00ffff,#ff4400,#ffd700);-webkit-background-clip:text;-webkit-text-fill-color:transparent;margin:0}
#menuScreen p{font-size:13px;color:#777;text-align:center;margin:0}
.mbtn{width:clamp(220px,55vw,290px);height:52px;font-size:16px;font-weight:900;border:none;border-radius:28px;background:linear-gradient(45deg,#0077ee,#ee2200);color:#fff;cursor:pointer;box-shadow:0 0 18px rgba(0,180,255,.4);transition:all .2s}
.mbtn:hover,.mbtn:active{transform:scale(1.05);box-shadow:0 0 32px rgba(0,220,255,.7)}

#shopScreen h2{font-size:24px;color:#ffd700;text-shadow:0 0 18px #ffd700;margin:0}
#shopCoinsLbl{font-size:18px;color:#ffd700;margin:0}
#shopItems{display:grid;grid-template-columns:repeat(auto-fill,minmax(230px,1fr));gap:10px;width:100%;max-width:800px}
.shbtn{padding:12px 14px;border:1px solid #333;border-radius:12px;background:rgba(0,12,30,.9);color:#fff;cursor:pointer;text-align:left;transition:all .2s}
.shbtn:not(:disabled):hover{border-color:#ffd700;box-shadow:0 0 14px #ffd700;transform:scale(1.02)}
.shbtn:disabled{opacity:.35;cursor:not-allowed}
.sn{font-size:14px;color:#00ff88}
.sc{font-size:12px;color:#ffd700;margin-top:2px}
.sd{font-size:11px;color:#555;margin-top:2px}
.cbtn{width:200px;height:46px;font-size:15px;font-weight:900;border:none;border-radius:23px;background:#00ff88;color:#000;cursor:pointer;box-shadow:0 0 16px #00ff88;transition:all .2s}
.cbtn:hover{transform:scale(1.05)}

#pauseScreen h2,#settingsScreen h2{font-size:32px;color:#00ffff;text-shadow:0 0 22px #00ffff;margin:0}
.pbtn{width:220px;height:46px;font-size:14px;font-weight:700;border:1px solid #00ffff;border-radius:23px;background:rgba(0,18,38,.9);color:#fff;cursor:pointer;transition:all .2s}
.pbtn:hover,.pbtn:active{background:#00ffff;color:#000}
.srow{display:flex;justify-content:space-between;align-items:center;width:300px;font-size:14px}
.srow label{color:#aaa}
.srow input[type=range]{width:140px;accent-color:#00ffff}
.srow input[type=checkbox]{width:18px;height:18px;accent-color:#00ffff;cursor:pointer}

#tutScreen h2{color:#00ffff;font-size:24px;margin:0}
.trow{font-size:13px;color:#ccc;background:rgba(255,255,255,.05);padding:7px 16px;border-radius:8px;width:300px;display:flex;justify-content:space-between}
.trow span{color:#00ff88;font-weight:700}

#goTitle{font-size:clamp(26px,5vw,50px);text-shadow:0 0 20px #00ffff;text-align:center;padding:0 16px;color:#fff}
#goStats{font-size:14px;color:#777;margin:8px 0;text-align:center;line-height:1.9}
#retryBtn{width:175px;height:46px;font-size:16px;font-weight:900;border:none;border-radius:23px;background:linear-gradient(45deg,#0077ee,#ee2200);color:#fff;cursor:pointer;box-shadow:0 0 16px #00ffff}

#hud{position:fixed;top:0;left:0;width:100%;pointer-events:none;z-index:50;display:none}
#hud.show{display:flex;justify-content:space-between;align-items:flex-start;gap:8px;padding:8px}
.hcard{background:rgba(0,12,36,.88);backdrop-filter:blur(6px);border:1px solid rgba(0,200,255,.35);padding:8px 12px;border-radius:11px;box-shadow:0 0 14px rgba(0,200,255,.12);min-width:115px;font-size:12px;color:#fff}
.blbl{color:#999;font-size:10px;margin-bottom:2px}
.bbar{height:11px;background:#080818;border-radius:6px;overflow:hidden;margin-bottom:4px}
.bfill{height:100%;border-radius:6px;transition:width .22s}
#hpFill{background:linear-gradient(90deg,#f30,#0f0)}
#pwFill{background:linear-gradient(90deg,#f4f,#80f)}
#midHud{text-align:center;flex:1;font-size:13px;font-weight:700;text-shadow:0 0 10px #00ffff;line-height:1.65;color:#fff}
#coinsHud{color:#ffd700;text-shadow:0 0 8px #ffd700;font-size:15px}
#comboHud{color:#ff0;font-size:18px;font-weight:900;text-shadow:0 0 14px #f80;min-height:24px}

#joyWrap{position:fixed;bottom:12px;left:12px;width:120px;height:120px;display:none;z-index:60;touch-action:none}
#joyBase{width:116px;height:116px;border-radius:58px;background:rgba(0,130,255,.18);border:2px solid rgba(0,190,255,.42);position:relative}
#joyKnob{width:46px;height:46px;border-radius:23px;background:rgba(0,190,255,.6);position:absolute;top:35px;left:35px;pointer-events:none}
#actionBtns{position:fixed;bottom:10px;right:8px;display:none;flex-wrap:wrap;gap:7px;width:180px;justify-content:flex-end;z-index:60}
.abtn{width:54px;height:54px;border:none;border-radius:27px;font-size:17px;color:#fff;cursor:pointer;-webkit-tap-highlight-color:transparent;touch-action:none;font-weight:700}
.ab-jump{background:rgba(0,130,255,.85)}
.ab-punch{background:rgba(210,35,35,.85)}
.ab-kick{background:rgba(210,100,0,.85)}
.ab-block{background:rgba(0,170,80,.85)}
.ab-dodge{background:rgba(0,170,170,.85)}
.ab-shoot{background:rgba(210,190,0,.85);display:none}
.ab-special{background:rgba(150,0,210,.85)}

#hitFlash{position:fixed;inset:0;background:transparent;pointer-events:none;z-index:80;transition:background .08s}
#achieveBox{position:fixed;top:68px;left:50%;transform:translateX(-50%);background:linear-gradient(90deg,rgba(0,38,0,.97),rgba(0,65,0,.97));border:1px solid #00ff88;border-radius:12px;padding:9px 20px;z-index:90;pointer-events:none;display:none;white-space:nowrap}
#achieveBox.show{display:block;animation:slideD .4s ease-out}
@keyframes slideD{from{transform:translateX(-50%) translateY(-34px);opacity:0}to{transform:translateX(-50%) translateY(0);opacity:1}}
#achieveTxt{font-size:13px;color:#00ff88}
#minimap{position:fixed;bottom:62px;right:8px;pointer-events:none;z-index:50}
#statsBox{position:fixed;bottom:56px;left:50%;transform:translateX(-50%);background:rgba(0,12,36,.95);border:1px solid #00ffff;border-radius:12px;padding:11px 18px;font-size:11px;z-index:55;display:none;pointer-events:none;white-space:nowrap;line-height:1.9;color:#ccc}
#statsBox.show{display:block}
.dmg{position:fixed;font-size:20px;font-weight:900;pointer-events:none;z-index:85;text-shadow:1px 1px 3px #000;animation:floatUp .9s ease-out forwards}
@keyframes floatUp{0%{opacity:1;transform:translateY(0) scale(1)}100%{opacity:0;transform:translateY(-62px) scale(.7)}}
</style>
</head>
<body>

<canvas id="c"></canvas>

<!-- LOADING -->
<div id="loadScreen" class="screen show">
  <div id="loadBg"></div>
  <div id="loadContent">
    <div style="position:relative">
      <div id="loadRing"></div>
      <div id="loadStick">
        <svg viewBox="0 0 80 110" width="80" height="110">
          <circle cx="40" cy="14" r="13" fill="#ffddaa" stroke="#00ffff" stroke-width="1.5"/>
          <circle cx="35" cy="12" r="2.2" fill="#222"/><circle cx="45" cy="12" r="2.2" fill="#222"/>
          <rect x="34" y="28" width="13" height="28" rx="4" fill="#00aaff"/>
          <line x1="34" y1="33" x2="14" y2="52" stroke="#555" stroke-width="5" stroke-linecap="round"/>
          <line x1="47" y1="33" x2="68" y2="40" stroke="#555" stroke-width="5" stroke-linecap="round"/>
          <circle cx="68" cy="40" r="6" fill="#222"/>
          <line x1="37" y1="56" x2="24" y2="86" stroke="#444" stroke-width="5" stroke-linecap="round"/>
          <line x1="44" y1="56" x2="57" y2="86" stroke="#444" stroke-width="5" stroke-linecap="round"/>
          <rect x="16" y="84" width="15" height="7" rx="3" fill="#111"/>
          <rect x="51" y="84" width="15" height="7" rx="3" fill="#111"/>
          <path d="M60 8 L76 24 L66 22 L72 44" stroke="#00ffff" stroke-width="2" stroke-linecap="round" opacity=".9"/>
        </svg>
      </div>
    </div>
    <div id="loadTitle">STICKMAN RAGE<br>ARENA FURY</div>
    <div id="loadSub">16 sections &nbsp;â€¢&nbsp; boss fights &nbsp;â€¢&nbsp; guns</div>
    <div id="loadBarWrap">
      <div id="loadBar"><div id="loadFill"></div></div>
      <div style="display:flex;justify-content:space-between;width:min(340px,80vw)">
        <div id="loadStatus">Initializing...</div>
        <div id="loadPct">0%</div>
      </div>
    </div>
  </div>
</div>

<!-- MENU -->
<div id="menuScreen" class="screen">
  <h1>ğŸ¦¾ STICKMAN RAGE: ARENA FURY ğŸ¦¾</h1>
  <p>16 Sections â€¢ 10 Waves Each â€¢ Boss Fights â€¢ Guns â€¢ Shop â€¢ Coins</p>
  <button class="mbtn" id="btnStory">ğŸš€ STORY MODE</button>
  <button class="mbtn" id="btnSurv">â™¾ï¸ SURVIVAL MODE</button>
  <button class="mbtn" id="btnTut">ğŸ“– TUTORIAL</button>
  <button class="mbtn" id="btnMob">ğŸ“± MOBILE CONTROLS</button>
  <button class="mbtn" id="btnSet">âš™ï¸ SETTINGS</button>
  <p style="font-size:11px;color:#444;margin-top:4px">Press P to pause â€¢ Progress auto-saves</p>
</div>

<!-- TUTORIAL -->
<div id="tutScreen" class="screen">
  <h2>ğŸ® HOW TO PLAY</h2>
  <div class="trow"><div>Move</div><span>A/D or â†â†’</span></div>
  <div class="trow"><div>Jump (double jump!)</div><span>W / Space / â†‘</span></div>
  <div class="trow"><div>Punch</div><span>Z</span></div>
  <div class="trow"><div>Kick</div><span>X</span></div>
  <div class="trow"><div>Block</div><span>C</span></div>
  <div class="trow"><div>Dodge Roll</div><span>Q</span></div>
  <div class="trow"><div>Shoot (armed)</div><span>V</span></div>
  <div class="trow"><div>Special Attack</div><span>B</span></div>
  <div class="trow"><div>Pause</div><span>P / Esc</span></div>
  <button class="cbtn" id="btnCloseTut">GOT IT âœ…</button>
</div>

<!-- SETTINGS -->
<div id="settingsScreen" class="screen">
  <h2>âš™ï¸ SETTINGS</h2>
  <div class="srow"><label>SFX Volume</label><input type="range" id="sfxVol" min="0" max="100" value="80"></div>
  <div class="srow"><label>Screen Shake</label><input type="checkbox" id="shakeOn" checked></div>
  <div class="srow"><label>Damage Numbers</label><input type="checkbox" id="dmgOn" checked></div>
  <div class="srow"><label>Particles</label><input type="checkbox" id="partOn" checked></div>
  <button class="cbtn" id="btnSaveSet">SAVE âœ…</button>
</div>

<!-- SHOP -->
<div id="shopScreen" class="screen">
  <h2>ğŸ›’ WORKSHOP â€” SECTION COMPLETE!</h2>
  <div id="shopCoinsLbl">ğŸ’° <span id="shopCoins">0</span></div>
  <div id="shopItems"></div>
  <br>
  <button class="cbtn" id="btnContinue">NEXT SECTION â¡ï¸</button>
</div>

<!-- PAUSE -->
<div id="pauseScreen" class="screen">
  <h2>â¸ PAUSED</h2>
  <button class="pbtn" id="btnResume">â–¶ RESUME</button>
  <button class="pbtn" id="btnPauseSet">âš™ï¸ SETTINGS</button>
  <button class="pbtn" id="btnStats">ğŸ“Š STATS</button>
  <button class="pbtn" onclick="location.reload()">ğŸ  MAIN MENU</button>
</div>

<!-- GAME OVER -->
<div id="gameoverScreen" class="screen">
  <div id="goTitle">DEFEAT! ğŸ’€</div>
  <div id="goStats"></div>
  <button id="retryBtn" onclick="location.reload()">ğŸ”„ RETRY</button>
</div>

<!-- HUD -->
<div id="hud">
  <div class="hcard" style="min-width:135px">
    <div class="blbl">â¤ï¸ Health</div>
    <div class="bbar"><div class="bfill" id="hpFill" style="width:100%"></div></div>
    <div class="blbl">âš¡ Power</div>
    <div class="bbar"><div class="bfill" id="pwFill" style="width:100%"></div></div>
    <div id="weapHud" style="font-size:11px;color:#adf;margin-top:3px">ğŸ‘Š Fists</div>
  </div>
  <div id="midHud">
    <div>Section <span id="secHud">1</span>/16 &nbsp; Wave <span id="waveHud">1</span>/10</div>
    <div id="coinsHud">ğŸ’° 0</div>
    <div id="comboHud"></div>
  </div>
  <div class="hcard" style="min-width:90px;text-align:right">
    <div style="font-size:10px;color:#888">Enemies</div>
    <div id="enemHud" style="font-size:20px;color:#f43;text-shadow:0 0 8px #f43">0</div>
    <div id="modHud" style="font-size:9px;color:#444">STORY</div>
  </div>
</div>

<!-- OVERLAYS -->
<div id="hitFlash"></div>
<div id="achieveBox"><div id="achieveTxt">ğŸ† Achievement!</div></div>
<canvas id="minimap" width="130" height="26"></canvas>
<div id="statsBox"></div>

<!-- MOBILE -->
<div id="joyWrap">
  <div id="joyBase"><div id="joyKnob"></div></div>
</div>
<div id="actionBtns">
  <button class="abtn ab-jump"    id="ab-jump">ğŸ¦˜</button>
  <button class="abtn ab-punch"   id="ab-punch">ğŸ‘Š</button>
  <button class="abtn ab-kick"    id="ab-kick">ğŸ¦µ</button>
  <button class="abtn ab-block"   id="ab-block">ğŸ›¡</button>
  <button class="abtn ab-dodge"   id="ab-dodge">ğŸ’¨</button>
  <button class="abtn ab-shoot"   id="ab-shoot">ğŸ”«</button>
  <button class="abtn ab-special" id="ab-special">ğŸ’¥</button>
</div>

<script>
'use strict';

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const rand = (a,b) => Math.random()*(b-a)+a;
const clamp = (v,a,b) => Math.max(a,Math.min(b,v));

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// LOADING â€” 3 seconds
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
(function initLoader(){
  const bg = document.getElementById('loadBg');
  for(let i=0;i<40;i++){
    const s = document.createElement('div');
    s.className = 'lstar';
    const sz = rand(1,4);
    s.style.cssText = `width:${sz}px;height:${sz}px;left:${rand(0,100)}%;` +
      `background:${Math.random()<.3?'#00ffff':'#fff'};` +
      `animation-duration:${rand(3,7)}s;animation-delay:${rand(0,3)}s`;
    bg.appendChild(s);
  }
  const stages = [
    {p:15, s:'Loading engine...'},
    {p:32, s:'Building arena...'},
    {p:52, s:'Spawning stickmen...'},
    {p:70, s:'Loading weapons...'},
    {p:88, s:'Charging power...'},
    {p:100,s:'Ready to fight!'},
  ];
  let i = 0;
  const iv = setInterval(()=>{
    if(i >= stages.length){ clearInterval(iv); return; }
    const st = stages[i++];
    document.getElementById('loadFill').style.width  = st.p + '%';
    document.getElementById('loadStatus').textContent = st.s;
    document.getElementById('loadPct').textContent    = st.p + '%';
    if(st.p >= 100){
      clearInterval(iv);
      setTimeout(()=>{
        const el = document.getElementById('loadScreen');
        el.classList.add('fadeout');
        setTimeout(()=>{ el.remove(); showScreen('menuScreen'); }, 500);
      }, 300);
    }
  }, 500);
})();

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SCREEN HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const SCREENS = ['menuScreen','shopScreen','pauseScreen','settingsScreen','tutScreen','gameoverScreen'];
function showScreen(id){ document.getElementById(id).classList.add('show'); }
function hideScreen(id){ document.getElementById(id).classList.remove('show'); }
function onlyScreen(id){ SCREENS.forEach(s=>hideScreen(s)); if(id) showScreen(id); }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SETTINGS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let cfg = {sfx:80, shake:true, dmg:true, parts:true};
try{ const s=localStorage.getItem('srCfg3'); if(s) Object.assign(cfg,JSON.parse(s)); }catch(e){}

document.getElementById('sfxVol').value  = cfg.sfx;
document.getElementById('shakeOn').checked = cfg.shake;
document.getElementById('dmgOn').checked   = cfg.dmg;
document.getElementById('partOn').checked  = cfg.parts;

function saveSettings(){
  cfg.sfx   = +document.getElementById('sfxVol').value;
  cfg.shake  = document.getElementById('shakeOn').checked;
  cfg.dmg    = document.getElementById('dmgOn').checked;
  cfg.parts  = document.getElementById('partOn').checked;
  try{ localStorage.setItem('srCfg3',JSON.stringify(cfg)); }catch(e){}
  hideScreen('settingsScreen');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// BUTTON WIRING  â€” all done with JS, no inline onclick
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
document.getElementById('btnStory') .addEventListener('click', ()=> startGame('story'));
document.getElementById('btnSurv')  .addEventListener('click', ()=> startGame('survival'));
document.getElementById('btnTut')   .addEventListener('click', ()=> showScreen('tutScreen'));
document.getElementById('btnMob')   .addEventListener('click', ()=> toggleMobileControls());
document.getElementById('btnSet')   .addEventListener('click', ()=> showScreen('settingsScreen'));
document.getElementById('btnCloseTut').addEventListener('click', ()=> hideScreen('tutScreen'));
document.getElementById('btnSaveSet') .addEventListener('click', saveSettings);
document.getElementById('btnContinue').addEventListener('click', continueGame);
document.getElementById('btnResume')  .addEventListener('click', resumeGame);
document.getElementById('btnPauseSet').addEventListener('click', ()=>{ hideScreen('pauseScreen'); showScreen('settingsScreen'); });
document.getElementById('btnStats')   .addEventListener('click', toggleStats);

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ACHIEVEMENTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const ACH = {
  firstBlood:{ name:'ğŸ©¸ First Blood' },
  combo10:   { name:'ğŸ”¥ Combo x10' },
  boss1:     { name:'ğŸ‘‘ Boss Slayer' },
  win:       { name:'ğŸ† CHAMPION!' },
  rich:      { name:'ğŸ’° Rich Stick (500 coins)' },
  dodge5:    { name:'ğŸ’¨ Untouchable (5 dodges)' },
};
const unlockedAch = {};
try{ const a=localStorage.getItem('srAch3'); if(a) Object.assign(unlockedAch,JSON.parse(a)); }catch(e){}

let achTimer = null;
function unlock(id){
  if(!ACH[id]||unlockedAch[id]) return;
  unlockedAch[id] = true;
  try{ localStorage.setItem('srAch3',JSON.stringify(unlockedAch)); }catch(e){}
  const el = document.getElementById('achieveBox');
  document.getElementById('achieveTxt').textContent = 'ğŸ† '+ACH[id].name;
  el.classList.add('show');
  clearTimeout(achTimer);
  achTimer = setTimeout(()=> el.classList.remove('show'), 3000);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// AUDIO
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let actx = null;
function getACtx(){
  if(!actx) actx = new(window.AudioContext||window.webkitAudioContext)();
  if(actx.state==='suspended') actx.resume();
  return actx;
}
function beep(freq,dur,type='square',vol=0.15){
  if(!cfg.sfx) return;
  try{
    const ac=getACtx(), o=ac.createOscillator(), g=ac.createGain();
    o.connect(g); g.connect(ac.destination);
    o.frequency.value=freq; o.type=type;
    g.gain.setValueAtTime(vol*(cfg.sfx/80), ac.currentTime);
    g.gain.exponentialRampToValueAtTime(0.001, ac.currentTime+dur);
    o.start(); o.stop(ac.currentTime+dur);
  }catch(e){}
}
const snd = {
  punch:   ()=> beep(310,.08,'square',.22),
  kick:    ()=> beep(200,.12,'sawtooth',.26),
  shoot:   ()=>{ beep(660,.05,'square',.28); beep(390,.05,'square',.12); },
  coin:    ()=>{ beep(880,.07,'sine',.12); setTimeout(()=>beep(1100,.07,'sine',.12),55); },
  pickup:  ()=> beep(700,.1,'sine',.18),
  boss:    ()=> beep(80,.6,'sawtooth',.45),
  death:   ()=> beep(100,.4,'sawtooth',.35),
  dodge:   ()=>{ beep(500,.05,'sine',.14); beep(800,.05,'sine',.1); },
  combo:   c => beep(400+c*24,.08,'square',.18),
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CANVAS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const canvas = document.getElementById('c');
const ctx    = canvas.getContext('2d');
function resize(){ canvas.width=innerWidth; canvas.height=innerHeight; }
resize();
window.addEventListener('resize', resize);

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CONSTANTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const FLOOR  = ()=> canvas.height - 110;
const LWALL  = 32;
const RWALL  = ()=> canvas.width - 32;
const BGCOLS = ['#0a0a1f','#18080a','#050f12','#0d0020','#050f08'];

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// GAME STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let gRunning=false, gPaused=false, gMode='story';
let section=1, wave=1, maxWaves=10;
let coins=0, totalCoins=0;
let upg = {hp:100, spd:5, dmg:1, def:1, coinMult:1, power:100};
let hasGun=false, gunAmmo=0;
let comboCount=0, comboTimer=0;
let shakeX=0, shakeY=0, shakeT=0;
let iframeT=0, dodgeT=0, dodgeCd=0, dodging=false, dodgeDir=1;
let mobileOn=false;
let survWave=0, killedLastFrame=false, totalTime=0;
const gStats = {kills:0,bossKills:0,dmgDealt:0,dmgTaken:0,dodges:0,shots:0,waves:0,start:Date.now()};

let player, enemies=[], bosses=[], particles=[], projectiles=[], pickups=[];

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INPUT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const keys={}, mk={};
document.addEventListener('keydown', e=>{
  keys[e.code]=true;
  if(e.code==='Escape'||e.code==='KeyP'){
    if(gRunning&&!gPaused) pauseGame();
    else if(gPaused) resumeGame();
  }
  if(gRunning && ['Space','ArrowUp','ArrowDown','ArrowLeft','ArrowRight'].includes(e.code))
    e.preventDefault();
},{passive:false});
document.addEventListener('keyup', e=>{ keys[e.code]=false; });

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MOBILE JOYSTICK
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function toggleMobileControls(){
  mobileOn = !mobileOn;
  document.getElementById('joyWrap').style.display    = mobileOn ? 'block' : 'none';
  document.getElementById('actionBtns').style.display = mobileOn ? 'flex'  : 'none';
}

(function setupJoy(){
  const base=document.getElementById('joyBase');
  const knob=document.getElementById('joyKnob');
  let jid=-1, jbx=0, jby=0;
  base.addEventListener('touchstart',e=>{
    const t=e.touches[0]; jid=t.identifier;
    const r=base.getBoundingClientRect();
    jbx=r.left+r.width/2; jby=r.top+r.height/2;
    e.preventDefault();
  },{passive:false});
  document.addEventListener('touchmove',e=>{
    for(const t of e.touches){
      if(t.identifier===jid){
        const dx=clamp(t.clientX-jbx,-46,46);
        const dy=clamp(t.clientY-jby,-46,46);
        knob.style.left=(35+dx)+'px'; knob.style.top=(35+dy)+'px';
        mk.A=dx<-10; mk.D=dx>10;
      }
    }
  },{passive:true});
  document.addEventListener('touchend',e=>{
    for(const t of e.changedTouches){
      if(t.identifier===jid){
        jid=-1; mk.A=mk.D=false;
        knob.style.left='35px'; knob.style.top='35px';
      }
    }
  });
})();

function bindBtn(id,k){
  const el=document.getElementById(id); if(!el)return;
  el.addEventListener('touchstart',e=>{mk[k]=true; e.preventDefault();},{passive:false});
  el.addEventListener('touchend',  ()=> mk[k]=false);
  el.addEventListener('touchcancel',()=>mk[k]=false);
  el.addEventListener('mousedown', ()=> mk[k]=true);
  el.addEventListener('mouseup',   ()=> mk[k]=false);
}
bindBtn('ab-jump','W'); bindBtn('ab-punch','Z'); bindBtn('ab-kick','X');
bindBtn('ab-block','C'); bindBtn('ab-dodge','Q'); bindBtn('ab-shoot','V');
bindBtn('ab-special','B');

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ENTITY FACTORIES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const ST={IDLE:0,WALK:1,PUNCH:2,KICK:3,BLOCK:4,SHOOT:5,DEAD:6};

function makePlayer(){
  return { x:140,y:0,vx:0,vy:0,
    hp:upg.hp, maxHp:upg.hp,
    facing:1, state:ST.IDLE, stateT:0,
    jumpCount:0, block:false, isEnemy:false, isBoss:false,
    deadT:0, invT:0, animT:0,
    _jHeld:false, _sHeld:false };
}

function makeEnemy(x, isBoss=false){
  const diff  = 1 + section*.08 + wave*.03;
  const baseHp = isBoss ? 600+section*60 : 30+section*4+rand(0,20);
  const hp     = Math.floor(baseHp*diff);
  return { x, y:0, vx:0, vy:0,
    hp, maxHp:hp,
    facing:-1, state:ST.IDLE, stateT:0,
    jumpCount:0, block:false, isEnemy:true, isBoss,
    deadT:0, aiTimer:0, atkCd:0, castCd:0, animT:0,
    color: isBoss?'#ffaa00':`hsl(${rand(0,28)},100%,55%)`,
    sc: isBoss ? 1.4 : 0.85+rand(0,.25) };
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PHYSICS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function physics(e, dt){
  e.vy -= 30*dt;
  e.y  += e.vy*dt;
  if(e.y<=0){ e.y=0; e.vy=0; e.jumpCount=0; }
  const hw = (e.isBoss?14:10)*(e.sc||1);
  e.x = clamp(e.x + e.vx*dt, LWALL+hw, RWALL()-hw);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PLAYER UPDATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function updatePlayer(dt){
  const p=player;
  if(p.state===ST.DEAD){ p.deadT+=dt; return; }
  p.animT+=dt;
  if(p.invT>0) p.invT-=dt;
  if(dodgeCd>0) dodgeCd-=dt;
  upg.power = Math.min(100, (upg.power||0)+8*dt);

  if(dodging){ dodgeT-=dt; p.vx=dodgeDir*upg.spd*2.5; if(dodgeT<=0) dodging=false; }

  const L = keys['KeyA']||keys['ArrowLeft']||mk.A;
  const R = keys['KeyD']||keys['ArrowRight']||mk.D;
  const J = keys['KeyW']||keys['ArrowUp']||keys['Space']||mk.W;

  if(!dodging){ p.vx=0; if(L){p.vx=-upg.spd;p.facing=-1;} if(R){p.vx=upg.spd;p.facing=1;} }

  if(J&&!p._jHeld&&p.jumpCount<2){ p.vy=14; p.jumpCount++; p._jHeld=true; }
  if(!J) p._jHeld=false;

  if((keys['KeyZ']||mk.Z)&&p.state!==ST.PUNCH){ p.state=ST.PUNCH; p.stateT=0; snd.punch(); }
  if((keys['KeyX']||mk.X)&&p.state!==ST.KICK ){ p.state=ST.KICK;  p.stateT=0; snd.kick();  }
  p.block = !!(keys['KeyC']||mk.C);
  if(p.block) p.state=ST.BLOCK;

  if((keys['KeyQ']||mk.Q)&&dodgeCd<=0&&!dodging){
    dodging=true; dodgeT=0.35; dodgeCd=1.2; dodgeDir=p.facing;
    p.invT=0.35; snd.dodge(); gStats.dodges++;
    if(gStats.dodges>=5) unlock('dodge5');
  }

  if((keys['KeyV']||mk.V)&&hasGun&&gunAmmo>0&&!p._sHeld){
    p.state=ST.SHOOT; p.stateT=0;
    spawnProj(p.x+p.facing*22, p.y+48, p.facing*24, 0, 28+section, p, '#ffff33');
    gunAmmo--; p._sHeld=true; gStats.shots++; snd.shoot(); updateHUD();
  }
  if(!(keys['KeyV']||mk.V)) p._sHeld=false;

  if((keys['KeyB']||mk.B)&&(upg.power||0)>=30){
    spawnProj(p.x+p.facing*22,p.y+45,p.facing*16,6,38,p,'#00ffff');
    upg.power-=30;
  }

  p.stateT+=dt;
  if(p.stateT>0.5&&p.state!==ST.BLOCK&&p.state!==ST.DEAD)
    p.state = Math.abs(p.vx)>0.5 ? ST.WALK : ST.IDLE;

  if(gunAmmo<=0&&hasGun){ hasGun=false; document.getElementById('ab-shoot').style.display='none'; }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ENEMY AI
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function updateEnemy(e, dt){
  if(e.state===ST.DEAD){ e.deadT+=dt; return; }
  e.animT+=dt; e.atkCd=Math.max(0,e.atkCd-dt); e.castCd=Math.max(0,e.castCd-dt);
  e.aiTimer+=dt;
  const diff  = 1+section*.05;
  const dist  = Math.abs(e.x-player.x);

  if(dist>55){
    e.vx = Math.sign(player.x-e.x)*(3.5+section*.22)*diff;
    e.facing = Math.sign(player.x-e.x)||1;
    e.state=ST.WALK;
  } else {
    e.vx*=.82;
    if(e.atkCd<=0&&e.aiTimer>0.4){
      const r=Math.random();
      if(r<.45){ e.state=ST.PUNCH; e.stateT=0; e.atkCd=.85+rand(0,.4); }
      else if(r<.7){ e.state=ST.KICK; e.stateT=0; e.atkCd=1.05+rand(0,.4); }
      e.aiTimer=0;
    }
  }
  if(dist>110&&e.castCd<=0&&Math.random()<.008*diff){
    spawnProj(e.x+e.facing*20,e.y+40,e.facing*11,rand(2,5),14+section,e,e.isBoss?'#ff8800':'#ff4400');
    e.castCd=1.5;
  }
  if(Math.random()<.003&&e.jumpCount<1){ e.vy=13; e.jumpCount=1; }
  if(e.isBoss&&Math.random()<.002*diff&&e.jumpCount<1){ e.vy=18; e.jumpCount=1; }

  e.stateT+=dt;
  if(e.stateT>0.5&&e.state!==ST.DEAD)
    e.state = Math.abs(e.vx)>0.5 ? ST.WALK : ST.IDLE;
  e.facing = Math.sign(player.x-e.x)||e.facing;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PARTICLES / PROJECTILES / PICKUPS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function spawnParts(x,y,col,n=16){
  if(!cfg.parts)return;
  for(let i=0;i<n;i++)
    particles.push({x,y,vx:rand(-7,7),vy:rand(-12,3),life:rand(.6,1.2),maxLife:1.2,col});
}

function spawnProj(x,y,vx,vy,dmg,owner,col){
  projectiles.push({x,y,vx,vy,dmg,owner,col,life:3});
}

function spawnPickup(type,x){
  const p={type,x,y:0,bobT:rand(0,Math.PI*2)};
  if(type==='coin')  p.val=Math.floor((5+section*2+rand(0,8))*upg.coinMult);
  if(type==='health')p.amt=30;
  if(type==='ammo')  p.amt=20;
  if(type==='power') p.amt=40;
  pickups.push(p);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// COMBAT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function checkCombat(dt){
  const allE=[...enemies,...bosses].filter(e=>e.state!==ST.DEAD);
  const p=player;

  allE.forEach(e=>{
    const dist=Math.abs(p.x-e.x);
    // Player â†’ Enemy
    if(p.state===ST.PUNCH&&dist<58&&!e.block){
      const d=Math.floor((12+section*.5)*upg.dmg*comboMult());
      e.hp-=d; gStats.dmgDealt+=d;
      spawnParts(e.x,e.y+38,'#00ff88',10); dmgNum(e.x,e.y+40,d,'#00ff88');
      shakeT=cfg.shake?.1:0; addCombo();
      if(e.hp<=0) killEnemy(e);
    }
    if(p.state===ST.KICK&&dist<70&&!e.block){
      const d=Math.floor((18+section*.7)*upg.dmg*comboMult());
      e.hp-=d; gStats.dmgDealt+=d;
      spawnParts(e.x,e.y+28,'#ffaa00',8); dmgNum(e.x,e.y+30,d,'#ffaa00');
      shakeT=cfg.shake?.18:0; addCombo();
      if(e.hp<=0) killEnemy(e);
    }
    // Enemy â†’ Player
    if(p.invT>0||dodging) return;
    if(e.state===ST.PUNCH&&dist<47&&!p.block){
      const d=Math.floor((8+section)*upg.def);
      p.hp-=d; gStats.dmgTaken+=d;
      spawnParts(p.x,p.y+38,'#ff4444',8); dmgNum(p.x,p.y+40,d,'#ff4444');
      flashHit(); shakeT=cfg.shake?.1:0;
      p.invT=0.45; resetCombo(); if(p.hp<=0) killPlayer();
    }
    if(e.state===ST.KICK&&dist<60&&!p.block){
      const d=Math.floor((13+section*.8)*upg.def);
      p.hp-=d; gStats.dmgTaken+=d;
      spawnParts(p.x,p.y+30,'#ff6644',7); dmgNum(p.x,p.y+32,d,'#ff6644');
      flashHit(); shakeT=cfg.shake?.15:0;
      p.invT=0.45; resetCombo(); if(p.hp<=0) killPlayer();
    }
  });

  // Projectiles
  for(let i=projectiles.length-1;i>=0;i--){
    const pr=projectiles[i];
    pr.x+=pr.vx*dt; pr.y+=pr.vy*dt; pr.life-=dt;

    if(pr.owner.isEnemy&&p.invT<=0&&!dodging){
      if(Math.abs(pr.x-p.x)<30&&Math.abs(pr.y-(p.y+40))<42&&!p.block){
        const d=Math.floor(pr.dmg*upg.def);
        p.hp-=d; gStats.dmgTaken+=d;
        spawnParts(p.x,p.y+38,'#ff4444',10); dmgNum(p.x,p.y+40,d,'#ff4444');
        flashHit(); shakeT=cfg.shake?.2:0; p.invT=0.5; resetCombo();
        if(p.hp<=0) killPlayer();
        projectiles.splice(i,1); continue;
      }
    }
    if(!pr.owner.isEnemy){
      let hit=false;
      for(const e of allE){
        if(Math.abs(pr.x-e.x)<32&&Math.abs(pr.y-(e.y+40))<46){
          const d=Math.floor(pr.dmg*upg.dmg);
          e.hp-=d; gStats.dmgDealt+=d;
          spawnParts(e.x,e.y+38,'#00ff88',8); dmgNum(e.x,e.y+40,d,'#00ff88');
          addCombo(); if(e.hp<=0) killEnemy(e);
          hit=true; break;
        }
      }
      if(hit){ projectiles.splice(i,1); continue; }
    }
    if(pr.life<=0||pr.x<LWALL||pr.x>RWALL()){ projectiles.splice(i,1); }
  }

  // Pickups
  for(let i=pickups.length-1;i>=0;i--){
    const pu=pickups[i];
    pu.bobT+=dt*3;
    if(Math.abs(pu.x-p.x)<38){
      if(pu.type==='coin')  { coins+=pu.val; totalCoins+=pu.val; snd.coin(); dmgNum(pu.x,10,pu.val,'#ffd700',true); if(totalCoins>=500)unlock('rich'); }
      if(pu.type==='health'){ const h=Math.min(p.maxHp,p.hp+pu.amt); p.hp=h; snd.pickup(); dmgNum(p.x,p.y+40,pu.amt,'#00ff88',true); }
      if(pu.type==='gun')   { hasGun=true; gunAmmo=30; document.getElementById('ab-shoot').style.display='block'; snd.pickup(); }
      if(pu.type==='ammo')  { gunAmmo+=pu.amt; snd.pickup(); }
      if(pu.type==='power') { upg.power=Math.min(100,(upg.power||0)+pu.amt); snd.pickup(); }
      pickups.splice(i,1); updateHUD();
    }
  }

  // Wave clear
  const alive = [...enemies,...bosses].filter(e=>e.state!==ST.DEAD).length;
  if(alive===0&&!killedLastFrame){
    killedLastFrame=true;
    setTimeout(()=>{ killedLastFrame=false; gMode==='survival' ? nextSurvivalWave() : waveCleared(); }, 1600);
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// KILL / DEATH
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function killEnemy(e){
  if(e.state===ST.DEAD) return;
  e.state=ST.DEAD; e.deadT=0;
  spawnParts(e.x,e.y+40,e.isBoss?'#ffaa00':'#ff4444',e.isBoss?30:16);
  const cv=Math.floor((e.isBoss?50:5)*upg.coinMult);
  coins+=cv; totalCoins+=cv;
  for(let i=0;i<(e.isBoss?4:1);i++) spawnPickup('coin',e.x+rand(-30,30));
  if(Math.random()<.25) spawnPickup('health',e.x);
  if(e.isBoss&&Math.random()<.5) spawnPickup('gun',e.x);
  gStats.kills++; if(e.isBoss){gStats.bossKills++;unlock('boss1');}
  if(gStats.kills===1) unlock('firstBlood');
  addCombo(); snd.death(); shakeT=cfg.shake?(e.isBoss?.4:.15):0;
  updateHUD();
}

function killPlayer(){
  if(player.state===ST.DEAD) return;
  player.state=ST.DEAD; player.hp=0; player.deadT=0;
  gRunning=false; snd.death();
  setTimeout(()=>showGameOver(false), 1400);
}

function flashHit(){
  const el=document.getElementById('hitFlash');
  el.style.background='rgba(255,0,0,0.22)';
  setTimeout(()=> el.style.background='', 110);
}

function dmgNum(x,y,val,col,heal=false){
  if(!cfg.dmg) return;
  const FY=FLOOR();
  const el=document.createElement('div');
  el.className='dmg';
  el.textContent=(heal?'+':'-')+Math.ceil(val);
  el.style.cssText=`left:${x-18}px;top:${FY-y-20}px;color:${col}`;
  document.body.appendChild(el);
  setTimeout(()=>el.remove(), 900);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// COMBO
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function addCombo(){ comboCount++; comboTimer=3; snd.combo(Math.min(comboCount,14)); if(comboCount>=10)unlock('combo10'); updateHUD(); }
function resetCombo(){ comboCount=0; comboTimer=0; updateHUD(); }
function comboMult(){ return 1+Math.min(comboCount*.05,1); }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// WAVE SYSTEM
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function startWave(){
  enemies=[]; bosses=[]; projectiles=[]; killedLastFrame=false;
  const isBoss=wave===maxWaves;
  if(!isBoss){
    const cnt=Math.min(2+Math.floor(wave/2)+Math.floor(section/2),10);
    for(let i=0;i<cnt;i++) enemies.push(makeEnemy(rand(canvas.width*.5,RWALL()-50)));
  } else {
    bosses.push(makeEnemy(canvas.width*.7,true)); snd.boss();
  }
  if(wave===1) for(let i=0;i<2;i++) spawnPickup(i?'ammo':'health',rand(LWALL+60,RWALL()-60));
  updateHUD();
}

function waveCleared(){
  gStats.waves++;
  wave++;
  if(wave>maxWaves){
    section++;
    if(section>16){ unlock('win'); showGameOver(true); return; }
    wave=1; openShop(); return;
  }
  if(Math.random()<.4) spawnPickup('health',rand(LWALL+60,RWALL()-60));
  setTimeout(startWave,1600);
  updateHUD();
}

function nextSurvivalWave(){
  survWave++;
  enemies=[]; bosses=[]; projectiles=[]; killedLastFrame=false;
  const cnt=Math.min(2+Math.floor(survWave/2),14);
  for(let i=0;i<cnt;i++) enemies.push(makeEnemy(rand(canvas.width*.45,RWALL()-50)));
  if(survWave%5===0){ bosses.push(makeEnemy(canvas.width*.7,true)); snd.boss(); }
  document.getElementById('modHud').textContent=`SURV W${survWave}`;
  updateHUD();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SHOP
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const shopDefs=[
  {name:'Max Health +60',   cost:50,  desc:'Restore + increase max HP',  fn:()=>{upg.hp+=60;player.maxHp=upg.hp;player.hp=upg.hp;}},
  {name:'Speed +1',         cost:80,  desc:'Move faster',                fn:()=> upg.spd+=1},
  {name:'Damage +25%',      cost:100, desc:'All attacks hit harder',     fn:()=> upg.dmg+=.25},
  {name:'Defense +20%',     cost:90,  desc:'Take less damage',           fn:()=> upg.def=Math.max(.1,upg.def-.2)},
  {name:'Coin Bonus +20%',  cost:60,  desc:'Earn more coins',            fn:()=> upg.coinMult+=.2},
  {name:'Gun + 50 Ammo',    cost:40,  desc:'Arm yourself with a gun',    fn:()=>{gunAmmo=50;hasGun=true;document.getElementById('ab-shoot').style.display='block';}},
  {name:'Full Restore',     cost:120, desc:'Restore all HP & power',     fn:()=>{player.hp=player.maxHp;upg.power=100;}},
  {name:'Ammo x100',        cost:60,  desc:'100 shots loaded',           fn:()=>{gunAmmo=100;hasGun=true;document.getElementById('ab-shoot').style.display='block';}},
  {name:'Power Restore',    cost:70,  desc:'Full special power',         fn:()=> upg.power=100},
];

function openShop(){
  gRunning=false;
  document.getElementById('shopCoins').textContent=coins;
  const c=document.getElementById('shopItems'); c.innerHTML='';
  shopDefs.forEach(s=>{
    const btn=document.createElement('button');
    btn.className='shbtn'; btn.disabled=coins<s.cost;
    btn.innerHTML=`<div class="sn">${s.name}</div><div class="sc">ğŸ’° ${s.cost}</div><div class="sd">${s.desc}</div>`;
    btn.addEventListener('click',()=>{
      if(coins<s.cost)return;
      coins-=s.cost; s.fn(); snd.coin();
      document.getElementById('shopCoins').textContent=coins;
      document.querySelectorAll('.shbtn').forEach(b=>{
        const cost=parseInt(b.querySelector('.sc').textContent.replace(/\D/g,''));
        b.disabled=coins<cost;
      });
      updateHUD();
    });
    c.appendChild(btn);
  });
  showScreen('shopScreen');
}

function continueGame(){
  hideScreen('shopScreen');
  for(let i=0;i<3;i++) spawnPickup(['health','ammo','power'][i%3],rand(LWALL+60,RWALL()-60));
  gRunning=true; startWave();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PAUSE / RESUME
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function pauseGame(){
  if(!gRunning||gPaused) return;
  gPaused=true; gRunning=false; showScreen('pauseScreen');
}
function resumeGame(){
  gPaused=false; gRunning=true;
  hideScreen('pauseScreen'); hideScreen('settingsScreen');
  document.getElementById('statsBox').classList.remove('show');
}

function toggleStats(){
  const el=document.getElementById('statsBox');
  const mins=Math.floor((Date.now()-gStats.start)/60000);
  el.innerHTML=`â± ${mins}m &nbsp; ğŸ’€ Kills: ${gStats.kills} &nbsp; ğŸ‘‘ Bosses: ${gStats.bossKills}<br>âš”ï¸ Dealt: ${Math.floor(gStats.dmgDealt)} &nbsp; ğŸ©¸ Taken: ${Math.floor(gStats.dmgTaken)}<br>ğŸ’¨ Dodges: ${gStats.dodges} &nbsp; ğŸ”« Shots: ${gStats.shots} &nbsp; ğŸŒŠ Waves: ${gStats.waves}`;
  el.classList.toggle('show');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// GAME OVER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showGameOver(win){
  const mins=Math.floor((Date.now()-gStats.start)/60000);
  document.getElementById('goTitle').textContent = win ? 'ğŸ† YOU WIN! CHAMPION!' : 'DEFEATED! ğŸ’€';
  document.getElementById('goStats').innerHTML  =
    `Kills: ${gStats.kills} &nbsp; Coins: ${totalCoins} &nbsp; Section ${section}<br>Time: ${mins}m`;
  onlyScreen('gameoverScreen');
  document.getElementById('hud').classList.remove('show');
  try{ localStorage.setItem('srSave',JSON.stringify({section,coins,upg})); }catch(e){}
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// HUD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function updateHUD(){
  const p=player;
  const hr=clamp(p.hp/p.maxHp,0,1);
  document.getElementById('hpFill').style.width=hr*100+'%';
  document.getElementById('hpFill').style.background=hr<.25?'#f22':hr<.5?'linear-gradient(90deg,#f22,#ff0)':'linear-gradient(90deg,#f22,#0f0)';
  document.getElementById('pwFill').style.width=clamp(upg.power||0,0,100)+'%';
  document.getElementById('secHud').textContent=section;
  document.getElementById('waveHud').textContent=wave;
  document.getElementById('coinsHud').textContent='ğŸ’° '+coins;
  document.getElementById('weapHud').textContent=hasGun?`ğŸ”« Gun (${gunAmmo})`:'ğŸ‘Š Fists';
  document.getElementById('comboHud').textContent=comboCount>=2?`x${comboCount} COMBO!`:'';
  const alive=[...enemies,...bosses].filter(e=>e.state!==ST.DEAD).length;
  document.getElementById('enemHud').textContent=alive;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MINIMAP
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function drawMinimap(){
  const mc=document.getElementById('minimap');
  const mx=mc.getContext('2d');
  const mw=130,mh=26;
  mx.clearRect(0,0,mw,mh);
  mx.fillStyle='rgba(0,5,20,.85)'; mx.fillRect(0,0,mw,mh);
  mx.strokeStyle='rgba(0,180,255,.4)'; mx.lineWidth=1; mx.strokeRect(0,0,mw,mh);
  const W=RWALL()-LWALL;
  const toM=x=>((x-LWALL)/W)*(mw-12)+6;
  mx.fillStyle='#0af'; mx.fillRect(toM(player.x)-3,10,7,7);
  [...enemies,...bosses].forEach(e=>{
    if(e.state===ST.DEAD)return;
    mx.fillStyle=e.isBoss?'#ffaa00':'#f33';
    mx.fillRect(toM(e.x)-2,12,5,5);
  });
  pickups.forEach(pu=>{
    mx.fillStyle=pu.type==='coin'?'#ffd700':'#0f8';
    mx.fillRect(toM(pu.x)-1,15,3,3);
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DRAW
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function drawArena(){
  const FY=FLOOR(), W=canvas.width, H=canvas.height;
  const bg=ctx.createLinearGradient(0,0,0,H);
  bg.addColorStop(0,'#00000a'); bg.addColorStop(.65,BGCOLS[(section-1)%BGCOLS.length]); bg.addColorStop(1,'#000005');
  ctx.fillStyle=bg; ctx.fillRect(0,0,W,H);
  // Grid
  ctx.strokeStyle='rgba(40,40,90,.25)'; ctx.lineWidth=1;
  for(let x=0;x<W;x+=80){ctx.beginPath();ctx.moveTo(x,0);ctx.lineTo(x,H);ctx.stroke();}
  for(let y=0;y<H;y+=60){ctx.beginPath();ctx.moveTo(0,y);ctx.lineTo(W,y);ctx.stroke();}
  // Floor
  const fg=ctx.createLinearGradient(0,FY,0,FY+80);
  fg.addColorStop(0,'#181830'); fg.addColorStop(1,'#080818');
  ctx.fillStyle=fg; ctx.fillRect(0,FY,W,H-FY);
  ctx.strokeStyle='rgba(0,180,255,.55)'; ctx.lineWidth=2;
  ctx.beginPath(); ctx.moveTo(LWALL,FY); ctx.lineTo(RWALL(),FY); ctx.stroke();
  // Walls
  ctx.fillStyle='rgba(0,50,140,.45)'; ctx.fillRect(0,0,LWALL,H); ctx.fillRect(RWALL(),0,W-RWALL(),H);
  ctx.fillStyle='rgba(0,100,255,.6)'; ctx.fillRect(LWALL-2,0,3,H); ctx.fillRect(RWALL()-1,0,3,H);
  // Ceiling lights
  const lxs=[LWALL+12, ...Array.from({length:4},(_,i)=>LWALL+(RWALL()-LWALL)/5*(i+1)), RWALL()-12];
  lxs.forEach(lx=>{
    const r=ctx.createRadialGradient(lx,22,0,lx,22,38);
    r.addColorStop(0,'rgba(0,140,255,.38)'); r.addColorStop(1,'transparent');
    ctx.fillStyle=r; ctx.fillRect(lx-38,0,76,60);
    ctx.fillStyle='rgba(120,180,255,.9)'; ctx.beginPath(); ctx.arc(lx,7,3.5,0,Math.PI*2); ctx.fill();
  });
}

function drawStick(e, isPlayer){
  const FY=FLOOR();
  const cx=e.x, cy=FY-e.y;
  ctx.save();
  ctx.translate(cx,cy);
  if(e.facing<0) ctx.scale(-1,1);
  const sc=e.sc||1; ctx.scale(sc,sc);
  // Iframe flicker
  if(isPlayer&&e.invT>0&&Math.floor(e.invT*10)%2===0){ ctx.restore(); return; }
  if(e.state===ST.DEAD){
    ctx.rotate(Math.min(Math.PI/2,e.deadT*3));
    ctx.globalAlpha=Math.max(0,1-e.deadT*.7);
  }
  const bCol=isPlayer?'#0088ff':e.color||'#ff3300';
  const lCol=isPlayer?'#004488':'#550000';
  const gCol=isPlayer?'#002040':'#220000';
  const t=e.animT;
  let llR=0,rlR=0,laR=0,raR=0;
  if(e.state===ST.WALK||Math.abs(e.vx)>.4){ llR=Math.sin(t*8)*.9; rlR=Math.sin(t*8+Math.PI)*.9; laR=Math.sin(t*8+Math.PI)*.45; raR=Math.sin(t*8)*.45; }
  if(e.state===ST.PUNCH){ raR=-1.5+Math.sin(e.stateT*28)*.4; }
  if(e.state===ST.KICK) { rlR=-1.3+Math.sin(e.stateT*22)*.4; }
  if(e.state===ST.BLOCK){ laR=raR=-0.8; }
  if(e.state===ST.SHOOT){ raR=-1.0; }
  ctx.lineCap='round';
  // Left leg
  ctx.save(); ctx.translate(-7,-3); ctx.rotate(llR);
  ctx.strokeStyle=lCol; ctx.lineWidth=7;
  ctx.beginPath(); ctx.moveTo(0,0); ctx.lineTo(0,28); ctx.stroke();
  ctx.fillStyle='#111'; ctx.fillRect(-5,25,13,7); ctx.restore();
  // Right leg
  ctx.save(); ctx.translate(7,-3); ctx.rotate(rlR);
  ctx.strokeStyle=lCol; ctx.lineWidth=7;
  ctx.beginPath(); ctx.moveTo(0,0); ctx.lineTo(0,28); ctx.stroke();
  ctx.fillStyle='#111'; ctx.fillRect(-5,25,13,7); ctx.restore();
  // Torso
  ctx.fillStyle=bCol; ctx.fillRect(-8,-44,16,44);
  // Left arm
  ctx.save(); ctx.translate(-8,-38); ctx.rotate(laR-.28);
  ctx.strokeStyle=lCol; ctx.lineWidth=6;
  ctx.beginPath(); ctx.moveTo(0,0); ctx.lineTo(-10,22); ctx.stroke();
  ctx.fillStyle=gCol; ctx.beginPath(); ctx.arc(-10,22,6,0,Math.PI*2); ctx.fill(); ctx.restore();
  // Right arm
  ctx.save(); ctx.translate(8,-38); ctx.rotate(raR+.28);
  ctx.strokeStyle=lCol; ctx.lineWidth=6;
  ctx.beginPath(); ctx.moveTo(0,0); ctx.lineTo(10,22); ctx.stroke();
  ctx.fillStyle=gCol; ctx.beginPath(); ctx.arc(10,22,6,0,Math.PI*2); ctx.fill(); ctx.restore();
  // Head
  ctx.fillStyle='#ffddaa'; ctx.beginPath(); ctx.arc(0,-52,12,0,Math.PI*2); ctx.fill();
  if(e.isBoss){ ctx.strokeStyle='#ff4400'; ctx.lineWidth=2; ctx.beginPath(); ctx.arc(0,-52,12,0,Math.PI*2); ctx.stroke(); }
  ctx.fillStyle=e.isBoss?'#f00':'#333';
  ctx.beginPath(); ctx.arc(-5,-54,2.8,0,Math.PI*2); ctx.fill();
  ctx.beginPath(); ctx.arc(5,-54,2.8,0,Math.PI*2); ctx.fill();
  // Enemy HP bar
  if(e.isEnemy&&e.state!==ST.DEAD){
    const bw=46*sc,bh=4,ratio=clamp(e.hp/e.maxHp,0,1);
    ctx.fillStyle='#300'; ctx.fillRect(-bw/2,-70*sc,bw,bh);
    ctx.fillStyle=ratio>.5?'#0f0':ratio>.25?'#ff0':'#f00';
    ctx.fillRect(-bw/2,-70*sc,bw*ratio,bh);
  }
  ctx.restore();
}

function drawProjectiles(){
  const FY=FLOOR();
  projectiles.forEach(pr=>{
    ctx.save();
    ctx.shadowColor=pr.col; ctx.shadowBlur=14;
    ctx.fillStyle=pr.col;
    ctx.beginPath(); ctx.arc(pr.x,FY-pr.y,9,0,Math.PI*2); ctx.fill();
    ctx.restore();
  });
}

function drawPickups(){
  const FY=FLOOR();
  const t=Date.now()/1000;
  pickups.forEach(pu=>{
    const sy=FY-10+Math.sin(pu.bobT+t*3)*6;
    ctx.save(); ctx.translate(pu.x,sy); ctx.rotate(t*1.5); ctx.shadowBlur=14;
    if(pu.type==='coin'){
      ctx.shadowColor='#ffd700'; ctx.fillStyle='#ffd700';
      ctx.beginPath(); ctx.arc(0,0,8,0,Math.PI*2); ctx.fill();
      ctx.fillStyle='#886600'; ctx.font='bold 8px Arial'; ctx.textAlign='center'; ctx.fillText('$',0,3);
    } else if(pu.type==='health'){
      ctx.shadowColor='#00ff88'; ctx.fillStyle='#00ff88';
      ctx.fillRect(-8,-2,16,5); ctx.fillRect(-2,-8,5,16);
    } else if(pu.type==='gun'){
      ctx.shadowColor='#aaa'; ctx.fillStyle='#778';
      ctx.fillRect(-12,-3,22,6); ctx.fillStyle='#445'; ctx.fillRect(-2,0,5,7);
    } else if(pu.type==='ammo'){
      ctx.shadowColor='#ff0'; ctx.fillStyle='#ff0';
      ctx.fillRect(-6,-8,12,16);
    } else if(pu.type==='power'){
      ctx.shadowColor='#f4f'; ctx.fillStyle='#f4f';
      ctx.beginPath();
      for(let i=0;i<6;i++){const a=i/6*Math.PI*2; ctx.lineTo(Math.cos(a)*9,Math.sin(a)*9);}
      ctx.closePath(); ctx.fill();
    }
    ctx.restore();
  });
}

function drawParticles(){
  const FY=FLOOR();
  ctx.save();
  particles.forEach(p=>{
    ctx.globalAlpha=Math.max(0,p.life/p.maxLife);
    ctx.fillStyle=p.col;
    ctx.beginPath(); ctx.arc(p.x,FY-p.y,3+ctx.globalAlpha*3,0,Math.PI*2); ctx.fill();
  });
  ctx.globalAlpha=1; ctx.restore();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// GAME START
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function startGame(mode){
  getACtx(); // resume AudioContext on user gesture
  gMode=mode; gRunning=true; gPaused=false;
  gStats.start=Date.now(); gStats.kills=0; gStats.bossKills=0;
  gStats.dmgDealt=0; gStats.dmgTaken=0; gStats.dodges=0; gStats.shots=0; gStats.waves=0;
  section=1; wave=1; coins=0; totalCoins=0; hasGun=false; gunAmmo=0;
  comboCount=0; comboTimer=0; totalTime=0; survWave=0;
  upg={hp:100,spd:5,dmg:1,def:1,coinMult:1,power:100};
  enemies=[]; bosses=[]; projectiles=[]; particles=[]; pickups=[];
  player=makePlayer();
  onlyScreen(null);
  document.getElementById('hud').classList.add('show');
  document.getElementById('modHud').textContent=mode.toUpperCase();
  document.getElementById('ab-shoot').style.display='none';
  if(mode==='survival') nextSurvivalWave();
  else startWave();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MAIN LOOP
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let last=0;
function loop(ts){
  requestAnimationFrame(loop);
  const dt=Math.min(.05,(ts-last)/1000); last=ts;

  if(!gRunning||gPaused){
    // Still render background when paused
    ctx.fillStyle='#000011'; ctx.fillRect(0,0,canvas.width,canvas.height);
    return;
  }
  totalTime+=dt;

  // Update player
  updatePlayer(dt); physics(player,dt);

  // Update enemies
  const allE=[...enemies,...bosses];
  allE.forEach(e=>{ if(e.state!==ST.DEAD){updateEnemy(e,dt);physics(e,dt);}else{e.deadT+=dt;} });
  // Cull very-dead enemies
  enemies=enemies.filter(e=>!(e.state===ST.DEAD&&e.deadT>2));
  bosses=bosses.filter(e=>!(e.state===ST.DEAD&&e.deadT>2));

  // Particles
  particles.forEach(p=>{ p.x+=p.vx*dt; p.y+=p.vy*dt; p.vy-=25*dt; p.life-=dt; });
  particles=particles.filter(p=>p.life>0);

  // Combo timer
  if(comboCount>0){ comboTimer-=dt; if(comboTimer<=0) resetCombo(); }

  // Camera shake
  if(shakeT>0){ shakeX=Math.sin(ts*.06)*shakeT*4; shakeY=Math.cos(ts*.09)*shakeT*3; shakeT-=dt; }
  else{ shakeX*=.78; shakeY*=.78; }

  checkCombat(dt);

  // Render
  ctx.save(); ctx.translate(shakeX,shakeY);
  drawArena(); drawPickups(); drawProjectiles(); drawParticles();
  allE.forEach(e=>{ if(!(e.state===ST.DEAD&&e.deadT>1.6)) drawStick(e,false); });
  if(!(player.state===ST.DEAD&&player.deadT>1.6)) drawStick(player,true);
  ctx.restore();

  // Periodic HUD + minimap
  if(Math.floor(totalTime*20)%4===0){ updateHUD(); drawMinimap(); }
}

requestAnimationFrame(loop);
console.log('ğŸ¦¾ Stickman Rage â€” pure Canvas 2D, zero dependencies!');
</script>
</body>
</html>
