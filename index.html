<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Stickman Rage: Arena Fury</title>
<link href="https://fonts.googleapis.com/css2?family=Black+Ops+One&family=Rajdhani:wght@400;600;700&display=swap" rel="stylesheet">
</head>
<body>
<canvas id="bgCanvas"></canvas>
<canvas id="c"></canvas>

<!-- LOADING -->
<div id="loadScreen" class="screen show">
  <div id="loadBg"></div>
  <div id="loadContent">
    <div style="position:relative">
      <div id="loadRing"></div>
      <div id="loadStick">
        <svg viewBox="0 0 90 120" width="90" height="120">
          <!-- Glow aura -->
          <defs>
            <radialGradient id="headGlow" cx="50%" cy="50%" r="50%">
              <stop offset="0%" stop-color="#00e5ff" stop-opacity="0.4"/>
              <stop offset="100%" stop-color="transparent" stop-opacity="0"/>
            </radialGradient>
            <filter id="glow"><feGaussianBlur stdDeviation="2.5" result="blur"/><feMerge><feMergeNode in="blur"/><feMergeNode in="SourceGraphic"/></feMerge></filter>
          </defs>
          <!-- Body glow -->
          <ellipse cx="45" cy="55" rx="22" ry="38" fill="url(#headGlow)"/>
          <!-- Head -->
          <circle cx="45" cy="14" r="13" fill="#ffeedd" filter="url(#glow)"/>
          <circle cx="45" cy="14" r="13" fill="none" stroke="#00e5ff" stroke-width="1.5" opacity=".7"/>
          <!-- Eyes with glow -->
          <circle cx="40" cy="12" r="2.5" fill="#1a1a2e"/>
          <circle cx="50" cy="12" r="2.5" fill="#1a1a2e"/>
          <circle cx="40.8" cy="11.2" r=".9" fill="#00e5ff" opacity=".9"/>
          <circle cx="50.8" cy="11.2" r=".9" fill="#00e5ff" opacity=".9"/>
          <!-- Smile -->
          <path d="M41 17 Q45 20 49 17" stroke="#cc8866" stroke-width="1.2" fill="none" stroke-linecap="round"/>
          <!-- Torso -->
          <rect x="37" y="28" width="16" height="32" rx="5" fill="#0066cc"/>
          <line x1="45" y1="28" x2="45" y2="60" stroke="#004499" stroke-width="1.5" opacity=".5"/>
          <!-- Belt -->
          <rect x="34" y="54" width="22" height="5" rx="2" fill="#003388"/>
          <!-- Left arm -->
          <line x1="37" y1="33" x2="16" y2="54" stroke="#445" stroke-width="6" stroke-linecap="round"/>
          <circle cx="16" cy="54" r="6.5" fill="#ffeedd" stroke="#00e5ff" stroke-width="1"/>
          <!-- Right arm (holding gun) -->
          <line x1="53" y1="33" x2="74" y2="44" stroke="#445" stroke-width="6" stroke-linecap="round"/>
          <circle cx="74" cy="44" r="6.5" fill="#ffeedd"/>
          <rect x="72" y="40" width="18" height="7" rx="2" fill="#223"/>
          <rect x="75" y="47" width="6" height="8" rx="1" fill="#334"/>
          <!-- Muzzle flash -->
          <circle cx="90" cy="43" r="5" fill="#ffd600" opacity=".9"/>
          <circle cx="90" cy="43" r="3" fill="#fff" opacity=".9"/>
          <!-- Left leg -->
          <line x1="41" y1="60" x2="30" y2="92" stroke="#334" stroke-width="6" stroke-linecap="round"/>
          <rect x="22" y="90" width="16" height="7" rx="3" fill="#111"/>
          <!-- Right leg -->
          <line x1="49" y1="60" x2="62" y2="92" stroke="#334" stroke-width="6" stroke-linecap="round"/>
          <rect x="56" y="90" width="16" height="7" rx="3" fill="#111"/>
          <!-- Energy bolt -->
          <path d="M62 8 L80 26 L68 24 L76 48" stroke="#00e5ff" stroke-width="2.2" stroke-linecap="round" opacity=".85" filter="url(#glow)"/>
        </svg>
      </div>
    </div>
    <div id="loadTitle">STICKMAN RAGE<br>ARENA FURY</div>
    <div id="loadSub">16 sections &nbsp;â€¢&nbsp; boss fights &nbsp;â€¢&nbsp; guns &nbsp;â€¢&nbsp; three.js</div>
    <div style="display:flex;flex-direction:column;align-items:center;gap:8px">
      <div id="loadBar"><div id="loadFill"></div></div>
      <div style="display:flex;justify-content:space-between;width:min(360px,82vw)">
        <div id="loadStatus">Initializing...</div>
        <div id="loadPct">0%</div>
      </div>
    </div>
  </div>
</div>

<!-- MENU -->
<div id="menuScreen" class="screen">
  <h1>ğŸ¦¾ STICKMAN RAGE: ARENA FURY ğŸ¦¾</h1>
  <p>16 Sections &nbsp;â€¢&nbsp; 10 Waves &nbsp;â€¢&nbsp; Boss Fights &nbsp;â€¢&nbsp; Guns &nbsp;â€¢&nbsp; Shop</p>
  <button class="mbtn" id="btnStory">ğŸš€ STORY MODE</button>
  <button class="mbtn" id="btnSurv">â™¾ï¸ SURVIVAL MODE</button>
  <button class="mbtn" id="btnTut">ğŸ“– TUTORIAL</button>
  <button class="mbtn" id="btnMob">ğŸ“± MOBILE CONTROLS</button>
  <button class="mbtn" id="btnSet">âš™ï¸ SETTINGS</button>
  <p style="font-size:11px;color:#333;margin-top:4px;letter-spacing:.5px">Press P to pause &nbsp;â€¢&nbsp; Progress auto-saves</p>
</div>

<!-- TUTORIAL -->
<div id="tutScreen" class="screen">
  <h2>ğŸ® HOW TO PLAY</h2>
  <div class="trow"><div>Move</div><span>A/D or â†â†’</span></div>
  <div class="trow"><div>Jump (double jump!)</div><span>W / Space / â†‘</span></div>
  <div class="trow"><div>Punch</div><span>Z</span></div>
  <div class="trow"><div>Kick</div><span>X</span></div>
  <div class="trow"><div>Block</div><span>C</span></div>
  <div class="trow"><div>Dodge Roll</div><span>Q</span></div>
  <div class="trow"><div>Shoot (armed)</div><span>V</span></div>
  <div class="trow"><div>Special Attack</div><span>B</span></div>
  <div class="trow"><div>Pause</div><span>P / Esc</span></div>
  <button class="cbtn" id="btnCloseTut">GOT IT âœ…</button>
</div>

<!-- SETTINGS -->
<div id="settingsScreen" class="screen">
  <h2>âš™ï¸ SETTINGS</h2>
  <div class="srow"><label>SFX Volume</label><input type="range" id="sfxVol" min="0" max="100" value="80"></div>
  <div class="srow"><label>Screen Shake</label><input type="checkbox" id="shakeOn" checked></div>
  <div class="srow"><label>Damage Numbers</label><input type="checkbox" id="dmgOn" checked></div>
  <div class="srow"><label>Particles</label><input type="checkbox" id="partOn" checked></div>
  <button class="cbtn" id="btnSaveSet">SAVE âœ…</button>
</div>

<!-- SHOP -->
<div id="shopScreen" class="screen">
  <h2>ğŸ›’ WORKSHOP â€” SECTION COMPLETE!</h2>
  <div id="shopCoinsLbl">ğŸ’° <span id="shopCoins">0</span></div>
  <div id="shopItems"></div>
  <br>
  <button class="cbtn" id="btnContinue">NEXT SECTION â¡ï¸</button>
</div>

<!-- PAUSE -->
<div id="pauseScreen" class="screen">
  <h2>â¸ PAUSED</h2>
  <button class="pbtn" id="btnResume">â–¶ RESUME</button>
  <button class="pbtn" id="btnPauseSet">âš™ï¸ SETTINGS</button>
  <button class="pbtn" id="btnStats">ğŸ“Š STATS</button>
  <button class="pbtn" onclick="location.reload()">ğŸ  MAIN MENU</button>
</div>

<!-- GAME OVER -->
<div id="gameoverScreen" class="screen">
  <div id="goTitle">DEFEAT! ğŸ’€</div>
  <div id="goStats"></div>
  <button id="retryBtn" onclick="location.reload()">ğŸ”„ RETRY</button>
</div>

<!-- HUD -->
<div id="hud">
  <div class="hcard" style="min-width:140px">
    <div class="blbl">â¤ï¸ Health</div>
    <div class="bbar"><div class="bfill" id="hpFill" style="width:100%"></div></div>
    <div class="blbl">âš¡ Power</div>
    <div class="bbar"><div class="bfill" id="pwFill" style="width:100%"></div></div>
    <div id="weapHud">ğŸ‘Š Fists</div>
  </div>
  <div id="midHud">
    <div>Section <span id="secHud">1</span>/16 &nbsp; Wave <span id="waveHud">1</span>/10</div>
    <div id="coinsHud">ğŸ’° 0</div>
    <div id="comboHud"></div>
  </div>
  <div class="hcard" style="min-width:95px;text-align:right">
    <div style="font-size:10px;color:#556;letter-spacing:.8px;text-transform:uppercase;font-weight:600">Enemies</div>
    <div id="enemHud" style="font-size:22px;color:#ff4433;text-shadow:0 0 10px #ff4433;font-family:'Black Ops One',sans-serif">0</div>
    <div id="modHud" style="font-size:9px;color:#334;letter-spacing:1px;font-weight:600">STORY</div>
  </div>
</div>

<!-- FX OVERLAYS -->
<div id="hitFlash"></div>
<div id="achieveBox"><div id="achieveTxt">ğŸ† Achievement!</div></div>
<canvas id="minimap" width="134" height="28"></canvas>
<div id="statsBox"></div>

<!-- MOBILE -->
<div id="joyWrap">
  <div id="joyBase"><div id="joyKnob"></div></div>
</div>
<div id="actionBtns">
  <button class="abtn ab-jump"    id="ab-jump">ğŸ¦˜</button>
  <button class="abtn ab-punch"   id="ab-punch">ğŸ‘Š</button>
  <button class="abtn ab-kick"    id="ab-kick">ğŸ¦µ</button>
  <button class="abtn ab-block"   id="ab-block">ğŸ›¡</button>
  <button class="abtn ab-dodge"   id="ab-dodge">ğŸ’¨</button>
  <button class="abtn ab-shoot"   id="ab-shoot">ğŸ”«</button>
  <button class="abtn ab-special" id="ab-special">ğŸ’¥</button>
</div>
<style>
*{margin:0;padding:0;box-sizing:border-box}
html,body{width:100%;height:100%;overflow:hidden;background:#000;font-family:'Rajdhani',sans-serif;touch-action:none;user-select:none}
canvas{display:block}
#bgCanvas{position:fixed;inset:0;z-index:0;pointer-events:none}
#c{position:fixed;inset:0;z-index:1}

.screen{position:fixed;inset:0;display:none;flex-direction:column;align-items:center;justify-content:center;z-index:100;gap:14px;padding:20px;overflow-y:auto}
.screen.show{display:flex}
#loadScreen{background:#00000f;z-index:200}
#menuScreen{background:rgba(0,0,12,0.85);backdrop-filter:blur(18px)}
#shopScreen{background:rgba(0,0,12,0.92);backdrop-filter:blur(18px)}
#pauseScreen{background:rgba(0,0,18,0.88);backdrop-filter:blur(22px)}
#settingsScreen{background:rgba(0,0,18,0.92);backdrop-filter:blur(18px)}
#tutScreen{background:rgba(0,0,18,0.92);backdrop-filter:blur(18px)}
#gameoverScreen{background:rgba(0,0,0,0.88);backdrop-filter:blur(22px)}

/* LOAD */
#loadBg{position:absolute;inset:0;overflow:hidden;pointer-events:none}
.lstar{position:absolute;border-radius:50%;animation:starDrift linear infinite}
@keyframes starDrift{from{transform:translateY(100vh) scale(0);opacity:0}10%{opacity:1}90%{opacity:.5}to{transform:translateY(-10vh) scale(1.5);opacity:0}}
#loadContent{position:relative;display:flex;flex-direction:column;align-items:center;gap:18px}
#loadStick{width:90px;height:120px;animation:stickFloat 1.2s ease-in-out infinite alternate}
@keyframes stickFloat{from{transform:translateY(0) rotate(-2deg)}to{transform:translateY(-14px) rotate(2deg)}}
#loadRing{position:absolute;width:130px;height:130px;border-radius:50%;background:radial-gradient(circle,rgba(0,200,255,.12) 0%,transparent 70%);box-shadow:0 0 60px rgba(0,180,255,.35),inset 0 0 30px rgba(0,180,255,.1);animation:ringPulse 1.8s ease-in-out infinite;top:-15px;left:-20px}
@keyframes ringPulse{0%,100%{transform:scale(1);opacity:.6}50%{transform:scale(1.1);opacity:1}}
#loadTitle{font-family:'Black Ops One',sans-serif;font-size:clamp(24px,5vw,42px);letter-spacing:3px;text-align:center;line-height:1.2;background:linear-gradient(135deg,#00e5ff 0%,#ff3d00 45%,#ffd600 100%);background-size:200% auto;-webkit-background-clip:text;-webkit-text-fill-color:transparent;animation:titleShine 2s linear infinite;filter:drop-shadow(0 0 20px rgba(0,200,255,.5))}
@keyframes titleShine{from{background-position:0% center}to{background-position:200% center}}
#loadSub{font-size:12px;color:#445;letter-spacing:5px;text-transform:uppercase;font-weight:600}
#loadBar{width:min(360px,82vw);height:5px;background:rgba(255,255,255,.05);border-radius:3px;overflow:visible;position:relative}
#loadFill{height:100%;width:0%;background:linear-gradient(90deg,#00e5ff,#0057ff,#00e5ff);background-size:200% 100%;border-radius:3px;transition:width .3s cubic-bezier(.4,0,.2,1);animation:barShimmer .9s linear infinite;box-shadow:0 0 12px #00d5ff}
#loadFill::after{content:'';position:absolute;right:-5px;top:50%;transform:translateY(-50%);width:11px;height:11px;border-radius:50%;background:#fff;box-shadow:0 0 8px #00e5ff,0 0 18px #00a0ff}
@keyframes barShimmer{from{background-position:0% 0}to{background-position:200% 0}}
#loadStatus{font-size:12px;color:#00e5ff;letter-spacing:3px;text-transform:uppercase;opacity:.7;animation:sBlink .9s ease-in-out infinite}
@keyframes sBlink{0%,100%{opacity:.3}50%{opacity:1}}
#loadPct{font-size:12px;color:#fff;opacity:.4}
#loadScreen.fadeout{opacity:0;transition:opacity .6s;pointer-events:none}

/* MENU */
#menuScreen h1{font-family:'Black Ops One',sans-serif;font-size:clamp(20px,4vw,40px);text-align:center;background:linear-gradient(135deg,#00e5ff,#ff3d00,#ffd600);-webkit-background-clip:text;-webkit-text-fill-color:transparent;filter:drop-shadow(0 0 18px rgba(0,200,255,.6));margin:0}
#menuScreen p{font-size:13px;color:#556;text-align:center;margin:0;letter-spacing:1px}
.mbtn{width:clamp(230px,58vw,300px);height:54px;font-family:'Black Ops One',sans-serif;font-size:15px;letter-spacing:2px;border:none;border-radius:30px;background:linear-gradient(135deg,#0060cc,#cc2200);color:#fff;cursor:pointer;box-shadow:0 0 22px rgba(0,160,255,.35),0 4px 20px rgba(0,0,0,.6);transition:all .25s;position:relative;overflow:hidden}
.mbtn::before{content:'';position:absolute;inset:0;background:linear-gradient(135deg,rgba(255,255,255,.15),transparent);border-radius:30px}
.mbtn:hover{transform:translateY(-2px) scale(1.03);box-shadow:0 0 38px rgba(0,200,255,.6),0 8px 30px rgba(0,0,0,.7)}
.mbtn:active{transform:scale(.97)}

/* SHOP */
#shopScreen h2{font-family:'Black Ops One',sans-serif;font-size:26px;color:#ffd600;text-shadow:0 0 22px #ffd600;margin:0;letter-spacing:2px}
#shopCoinsLbl{font-size:20px;color:#ffd600;font-weight:700;letter-spacing:1px}
#shopItems{display:grid;grid-template-columns:repeat(auto-fill,minmax(230px,1fr));gap:10px;width:100%;max-width:820px}
.shbtn{padding:14px 16px;border:1px solid rgba(255,255,255,.08);border-radius:14px;background:rgba(0,10,28,.9);color:#fff;cursor:pointer;text-align:left;transition:all .22s;backdrop-filter:blur(8px)}
.shbtn:not(:disabled):hover{border-color:#ffd600;box-shadow:0 0 18px rgba(255,214,0,.35);transform:translateY(-2px)}
.shbtn:disabled{opacity:.3;cursor:not-allowed}
.sn{font-size:14px;color:#00e5ff;font-weight:700;letter-spacing:.5px}
.sc{font-size:12px;color:#ffd600;margin-top:3px;font-weight:600}
.sd{font-size:11px;color:#445;margin-top:3px;letter-spacing:.3px}
.cbtn{width:210px;height:48px;font-family:'Black Ops One',sans-serif;font-size:14px;letter-spacing:1.5px;border:none;border-radius:24px;background:linear-gradient(135deg,#00c060,#00804a);color:#fff;cursor:pointer;box-shadow:0 0 18px rgba(0,200,100,.4);transition:all .22s}
.cbtn:hover{transform:scale(1.05);box-shadow:0 0 30px rgba(0,220,120,.6)}

/* PAUSE / SETTINGS */
#pauseScreen h2,#settingsScreen h2{font-family:'Black Ops One',sans-serif;font-size:34px;color:#00e5ff;text-shadow:0 0 26px #00e5ff;margin:0;letter-spacing:3px}
.pbtn{width:230px;height:48px;font-family:'Rajdhani',sans-serif;font-size:15px;font-weight:700;letter-spacing:1.5px;border:1px solid rgba(0,200,255,.35);border-radius:24px;background:rgba(0,16,40,.8);color:#fff;cursor:pointer;transition:all .22s}
.pbtn:hover{background:#00e5ff;color:#000;box-shadow:0 0 24px #00e5ff}
.srow{display:flex;justify-content:space-between;align-items:center;width:310px;font-size:14px}
.srow label{color:#889;font-weight:600;letter-spacing:.5px}
.srow input[type=range]{width:145px;accent-color:#00e5ff}
.srow input[type=checkbox]{width:18px;height:18px;accent-color:#00e5ff;cursor:pointer}

/* TUTORIAL */
#tutScreen h2{font-family:'Black Ops One',sans-serif;color:#00e5ff;font-size:26px;margin:0;letter-spacing:2px;text-shadow:0 0 18px #00e5ff}
.trow{font-size:13px;color:#ccc;background:rgba(255,255,255,.04);padding:8px 18px;border-radius:10px;width:310px;display:flex;justify-content:space-between;border:1px solid rgba(255,255,255,.06);letter-spacing:.3px}
.trow span{color:#00ff88;font-weight:700}

/* GAMEOVER */
#goTitle{font-family:'Black Ops One',sans-serif;font-size:clamp(28px,5vw,54px);text-shadow:0 0 24px #00e5ff;text-align:center;padding:0 16px;color:#fff;letter-spacing:3px}
#goStats{font-size:15px;color:#667;margin:8px 0;text-align:center;line-height:2;letter-spacing:.5px}
#retryBtn{width:190px;height:50px;font-family:'Black Ops One',sans-serif;font-size:15px;letter-spacing:2px;border:none;border-radius:25px;background:linear-gradient(135deg,#0060cc,#cc2200);color:#fff;cursor:pointer;box-shadow:0 0 22px rgba(0,200,255,.45)}

/* HUD */
#hud{position:fixed;top:0;left:0;width:100%;pointer-events:none;z-index:50;display:none}
#hud.show{display:flex;justify-content:space-between;align-items:flex-start;gap:8px;padding:10px}
.hcard{background:rgba(0,8,28,.82);backdrop-filter:blur(10px);border:1px solid rgba(0,180,255,.22);padding:10px 14px;border-radius:14px;box-shadow:0 0 18px rgba(0,180,255,.08),inset 0 1px 0 rgba(255,255,255,.04);min-width:120px;font-size:12px;color:#fff}
.blbl{color:#667;font-size:10px;margin-bottom:3px;letter-spacing:.8px;text-transform:uppercase;font-weight:600}
.bbar{height:10px;background:rgba(255,255,255,.05);border-radius:5px;overflow:hidden;margin-bottom:5px}
.bfill{height:100%;border-radius:5px;transition:width .28s}
#hpFill{background:linear-gradient(90deg,#ff2200,#44ff00)}
#pwFill{background:linear-gradient(90deg,#cc00ff,#6600ff)}
#midHud{text-align:center;flex:1;font-size:13px;font-weight:700;text-shadow:0 0 10px #00e5ff;line-height:1.75;color:#fff;letter-spacing:.5px}
#coinsHud{color:#ffd600;text-shadow:0 0 10px #ffd600;font-size:16px;font-weight:700}
#comboHud{color:#ff0;font-size:20px;font-weight:900;text-shadow:0 0 18px #f80,0 0 35px #f80;min-height:26px;font-family:'Black Ops One',sans-serif;letter-spacing:1px}
#weapHud{font-size:11px;color:#88ccff;margin-top:4px;letter-spacing:.3px}

/* MOBILE */
#joyWrap{position:fixed;bottom:14px;left:14px;width:124px;height:124px;display:none;z-index:60;touch-action:none}
#joyBase{width:120px;height:120px;border-radius:60px;background:rgba(0,120,255,.14);border:2px solid rgba(0,180,255,.35);position:relative;backdrop-filter:blur(6px)}
#joyKnob{width:48px;height:48px;border-radius:24px;background:radial-gradient(circle,rgba(0,200,255,.75),rgba(0,100,200,.55));position:absolute;top:36px;left:36px;pointer-events:none;box-shadow:0 0 12px rgba(0,180,255,.5)}
#actionBtns{position:fixed;bottom:12px;right:10px;display:none;flex-wrap:wrap;gap:8px;width:185px;justify-content:flex-end;z-index:60}
.abtn{width:56px;height:56px;border:none;border-radius:28px;font-size:18px;color:#fff;cursor:pointer;-webkit-tap-highlight-color:transparent;touch-action:none;font-weight:700;backdrop-filter:blur(6px);box-shadow:0 4px 14px rgba(0,0,0,.5)}
.ab-jump   {background:rgba(0,110,220,.88)}
.ab-punch  {background:rgba(200,30,30,.88)}
.ab-kick   {background:rgba(200,95,0,.88)}
.ab-block  {background:rgba(0,155,70,.88)}
.ab-dodge  {background:rgba(0,155,155,.88)}
.ab-shoot  {background:rgba(200,180,0,.88);display:none}
.ab-special{background:rgba(140,0,200,.88)}

/* FX */
#hitFlash{position:fixed;inset:0;background:transparent;pointer-events:none;z-index:80;transition:background .1s}
#achieveBox{position:fixed;top:72px;left:50%;transform:translateX(-50%);background:rgba(0,22,0,.96);border:1px solid #00ff88;border-radius:14px;padding:10px 22px;z-index:90;pointer-events:none;display:none;white-space:nowrap;backdrop-filter:blur(10px);box-shadow:0 0 28px rgba(0,255,136,.3)}
#achieveBox.show{display:block;animation:slideD .4s cubic-bezier(.175,.885,.32,1.275)}
@keyframes slideD{from{transform:translateX(-50%) translateY(-40px);opacity:0}to{transform:translateX(-50%) translateY(0);opacity:1}}
#achieveTxt{font-size:13px;color:#00ff88;font-weight:700;letter-spacing:.5px}
#minimap{position:fixed;bottom:66px;right:10px;pointer-events:none;z-index:50;border-radius:8px;overflow:hidden}
#statsBox{position:fixed;bottom:58px;left:50%;transform:translateX(-50%);background:rgba(0,8,28,.94);border:1px solid rgba(0,200,255,.3);border-radius:14px;padding:12px 20px;font-size:11px;z-index:55;display:none;pointer-events:none;white-space:nowrap;line-height:2;color:#889;backdrop-filter:blur(10px);letter-spacing:.3px}
#statsBox.show{display:block}
.dmg{position:fixed;font-family:'Black Ops One',sans-serif;font-size:22px;font-weight:900;pointer-events:none;z-index:85;text-shadow:2px 2px 4px rgba(0,0,0,.8);animation:floatUp 1s ease-out forwards}
@keyframes floatUp{0%{opacity:1;transform:translateY(0) scale(1)}50%{transform:translateY(-35px) scale(1.1)}100%{opacity:0;transform:translateY(-70px) scale(.7)}}

/* Shoot muzzle flash */
.muzzle{position:fixed;pointer-events:none;z-index:83;border-radius:50%;animation:muzzlePop .12s ease-out forwards}
@keyframes muzzlePop{0%{transform:scale(0);opacity:1}100%{transform:scale(2.5);opacity:0}}
</style>
<!-- THREE.JS CDN -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>

<script>
'use strict';

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// THREE.JS BACKGROUND
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
(function initThreeBg(){
  const bgc = document.getElementById('bgCanvas');
  const renderer = new THREE.WebGLRenderer({ canvas: bgc, antialias: true, alpha: true });
  renderer.setSize(innerWidth, innerHeight);
  renderer.setPixelRatio(Math.min(devicePixelRatio, 2));
  const scene = new THREE.Scene();
  const camera = new THREE.PerspectiveCamera(75, innerWidth / innerHeight, 0.1, 500);
  camera.position.z = 60;

  // â”€â”€ Starfield
  const starGeo = new THREE.BufferGeometry();
  const starCnt = 2200;
  const starPos = new Float32Array(starCnt * 3);
  const starSizes = new Float32Array(starCnt);
  for (let i = 0; i < starCnt; i++) {
    starPos[i*3]   = (Math.random() - .5) * 400;
    starPos[i*3+1] = (Math.random() - .5) * 300;
    starPos[i*3+2] = (Math.random() - .5) * 300;
    starSizes[i]   = Math.random() * 2.5 + .4;
  }
  starGeo.setAttribute('position', new THREE.BufferAttribute(starPos, 3));
  starGeo.setAttribute('size',     new THREE.BufferAttribute(starSizes, 1));
  const starMat = new THREE.PointsMaterial({ color: 0xffffff, sizeAttenuation: true, transparent: true, opacity: .72 });
  starMat.size = 0.9;
  scene.add(new THREE.Points(starGeo, starMat));

  // â”€â”€ Floating neon orbs
  const orbData = [];
  const orbColors = [0x00e5ff, 0xff3d00, 0xffd600, 0x7700ff, 0x00ff88];
  for (let i = 0; i < 18; i++) {
    const geo = new THREE.SphereGeometry(Math.random() * 2.2 + .6, 16, 16);
    const col = orbColors[i % orbColors.length];
    const mat = new THREE.MeshBasicMaterial({ color: col, transparent: true, opacity: .18 + Math.random() * .14 });
    const mesh = new THREE.Mesh(geo, mat);
    mesh.position.set((Math.random()-.5)*120, (Math.random()-.5)*80, -30 - Math.random()*60);
    scene.add(mesh);
    // Glow ring around orb
    const rGeo = new THREE.RingGeometry(mesh.geometry.parameters.radius * 1.4, mesh.geometry.parameters.radius * 2.2, 32);
    const rMat = new THREE.MeshBasicMaterial({ color: col, transparent: true, opacity: .08, side: THREE.DoubleSide });
    const ring = new THREE.Mesh(rGeo, rMat);
    mesh.add(ring);
    orbData.push({ mesh, speed: Math.random()*.0028 + .0008, amp: Math.random()*12+4, phase: Math.random()*Math.PI*2, rotSpd: (Math.random()-.5)*.02 });
  }

  // â”€â”€ Grid floor
  const gridHelper = new THREE.GridHelper(260, 32, 0x001133, 0x000d22);
  gridHelper.position.y = -40;
  gridHelper.rotation.x = Math.PI * .04;
  scene.add(gridHelper);

  // â”€â”€ Geometric floating shapes (icosahedra)
  const shapeData = [];
  for (let i = 0; i < 8; i++) {
    const geo = new THREE.IcosahedronGeometry(Math.random()*3.5+1.2, 0);
    const col = orbColors[i % orbColors.length];
    const mat = new THREE.MeshBasicMaterial({ color: col, wireframe: true, transparent: true, opacity: .12 });
    const mesh = new THREE.Mesh(geo, mat);
    mesh.position.set((Math.random()-.5)*160, (Math.random()-.5)*90, -50 - Math.random()*50);
    scene.add(mesh);
    shapeData.push({ mesh, rx: (Math.random()-.5)*.018, ry: (Math.random()-.5)*.014, rz: (Math.random()-.5)*.01 });
  }

  // â”€â”€ Energy columns (vertical lines)
  const colData = [];
  for (let i = 0; i < 5; i++) {
    const pts = [];
    const x = (i - 2) * 22;
    for (let j = 0; j < 40; j++) pts.push(new THREE.Vector3(x + (Math.random()-.5)*.6, j * 2.2 - 44, -35));
    const geo = new THREE.BufferGeometry().setFromPoints(pts);
    const mat = new THREE.LineBasicMaterial({ color: orbColors[i], transparent: true, opacity: .22 });
    const line = new THREE.Line(geo, mat);
    scene.add(line);
    colData.push({ line, phase: Math.random()*Math.PI*2, mat });
  }

  // â”€â”€ Resize
  window.addEventListener('resize', () => {
    renderer.setSize(innerWidth, innerHeight);
    camera.aspect = innerWidth / innerHeight;
    camera.updateProjectionMatrix();
  });

  let bgTime = 0;
  function animBg() {
    requestAnimationFrame(animBg);
    bgTime += .012;
    camera.position.y  = Math.sin(bgTime * .18) * 2.5;
    camera.position.x  = Math.cos(bgTime * .12) * 1.5;
    starMat.opacity    = .55 + Math.sin(bgTime * .4) * .12;
    orbData.forEach(o => {
      o.mesh.position.y += Math.sin(bgTime * o.speed * 80 + o.phase) * o.amp * .0005;
      o.mesh.rotation.y += o.rotSpd;
      o.mesh.material.opacity = .12 + Math.sin(bgTime * 1.2 + o.phase) * .06;
    });
    shapeData.forEach(s => {
      s.mesh.rotation.x += s.rx;
      s.mesh.rotation.y += s.ry;
      s.mesh.rotation.z += s.rz;
    });
    colData.forEach((c, i) => {
      c.mat.opacity = .12 + Math.sin(bgTime * 2 + c.phase) * .1;
    });
    gridHelper.rotation.z = Math.sin(bgTime * .06) * .015;
    renderer.render(scene, camera);
  }
  animBg();
  window._bgScene = scene;
  window._bgOrbs  = orbData;
})();

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const rand = (a,b) => Math.random()*(b-a)+a;
const clamp = (v,a,b) => Math.max(a, Math.min(b, v));

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// LOADING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
(function initLoader(){
  const bg = document.getElementById('loadBg');
  for(let i=0;i<50;i++){
    const s = document.createElement('div');
    s.className='lstar';
    const sz = rand(1,3.5);
    s.style.cssText=`width:${sz}px;height:${sz}px;left:${rand(0,100)}%;`+
      `background:${Math.random()<.3?'#00e5ff':'#fff'};`+
      `animation-duration:${rand(4,8)}s;animation-delay:${rand(0,4)}s`;
    bg.appendChild(s);
  }
  const stages=[
    {p:12,s:'Booting engine...'},
    {p:28,s:'Building arena...'},
    {p:48,s:'Sculpting stickmen...'},
    {p:65,s:'Loading weapons...'},
    {p:82,s:'Charging Three.js...'},
    {p:100,s:'READY TO FIGHT!'},
  ];
  let i=0;
  const iv=setInterval(()=>{
    if(i>=stages.length){clearInterval(iv);return;}
    const st=stages[i++];
    document.getElementById('loadFill').style.width=st.p+'%';
    document.getElementById('loadStatus').textContent=st.s;
    document.getElementById('loadPct').textContent=st.p+'%';
    if(st.p>=100){
      clearInterval(iv);
      setTimeout(()=>{
        const el=document.getElementById('loadScreen');
        el.classList.add('fadeout');
        setTimeout(()=>{ el.remove(); showScreen('menuScreen'); },600);
      },350);
    }
  },500);
})();

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SCREEN HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const SCREENS=['menuScreen','shopScreen','pauseScreen','settingsScreen','tutScreen','gameoverScreen'];
function showScreen(id){ document.getElementById(id).classList.add('show'); }
function hideScreen(id){ document.getElementById(id).classList.remove('show'); }
function onlyScreen(id){ SCREENS.forEach(s=>hideScreen(s)); if(id) showScreen(id); }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SETTINGS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let cfg={sfx:80,shake:true,dmg:true,parts:true};
try{const s=localStorage.getItem('srCfg4');if(s)Object.assign(cfg,JSON.parse(s));}catch(e){}
document.getElementById('sfxVol').value=cfg.sfx;
document.getElementById('shakeOn').checked=cfg.shake;
document.getElementById('dmgOn').checked=cfg.dmg;
document.getElementById('partOn').checked=cfg.parts;
function saveSettings(){
  cfg.sfx=+document.getElementById('sfxVol').value;
  cfg.shake=document.getElementById('shakeOn').checked;
  cfg.dmg=document.getElementById('dmgOn').checked;
  cfg.parts=document.getElementById('partOn').checked;
  try{localStorage.setItem('srCfg4',JSON.stringify(cfg));}catch(e){}
  hideScreen('settingsScreen');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// BUTTON WIRING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
document.getElementById('btnStory')   .addEventListener('click',()=>startGame('story'));
document.getElementById('btnSurv')    .addEventListener('click',()=>startGame('survival'));
document.getElementById('btnTut')     .addEventListener('click',()=>showScreen('tutScreen'));
document.getElementById('btnMob')     .addEventListener('click',toggleMobileControls);
document.getElementById('btnSet')     .addEventListener('click',()=>showScreen('settingsScreen'));
document.getElementById('btnCloseTut').addEventListener('click',()=>hideScreen('tutScreen'));
document.getElementById('btnSaveSet') .addEventListener('click',saveSettings);
document.getElementById('btnContinue').addEventListener('click',continueGame);
document.getElementById('btnResume')  .addEventListener('click',resumeGame);
document.getElementById('btnPauseSet').addEventListener('click',()=>{hideScreen('pauseScreen');showScreen('settingsScreen');});
document.getElementById('btnStats')   .addEventListener('click',toggleStats);

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ACHIEVEMENTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const ACH={firstBlood:{name:'ğŸ©¸ First Blood'},combo10:{name:'ğŸ”¥ Combo x10'},boss1:{name:'ğŸ‘‘ Boss Slayer'},win:{name:'ğŸ† CHAMPION!'},rich:{name:'ğŸ’° Rich Stick (500 coins)'},dodge5:{name:'ğŸ’¨ Untouchable (5 dodges)'}};
const unlockedAch={};
try{const a=localStorage.getItem('srAch4');if(a)Object.assign(unlockedAch,JSON.parse(a));}catch(e){}
let achTimer=null;
function unlock(id){
  if(!ACH[id]||unlockedAch[id])return;
  unlockedAch[id]=true;
  try{localStorage.setItem('srAch4',JSON.stringify(unlockedAch));}catch(e){}
  const el=document.getElementById('achieveBox');
  document.getElementById('achieveTxt').textContent='ğŸ† '+ACH[id].name;
  el.classList.add('show');
  clearTimeout(achTimer);
  achTimer=setTimeout(()=>el.classList.remove('show'),3200);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// AUDIO
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let actx=null;
function getACtx(){ if(!actx)actx=new(window.AudioContext||window.webkitAudioContext)(); if(actx.state==='suspended')actx.resume(); return actx; }
function beep(freq,dur,type='square',vol=.15){
  if(!cfg.sfx)return;
  try{
    const ac=getACtx(),o=ac.createOscillator(),g=ac.createGain();
    o.connect(g);g.connect(ac.destination);
    o.frequency.value=freq;o.type=type;
    g.gain.setValueAtTime(vol*(cfg.sfx/80),ac.currentTime);
    g.gain.exponentialRampToValueAtTime(.001,ac.currentTime+dur);
    o.start();o.stop(ac.currentTime+dur);
  }catch(e){}
}
function beepChord(freqs,dur,type='sine',vol=.12){
  freqs.forEach((f,i)=>setTimeout(()=>beep(f,dur,type,vol),i*18));
}
const snd={
  punch:   ()=>{ beep(320,.06,'square',.24); beep(180,.08,'sawtooth',.12); },
  kick:    ()=>{ beep(190,.1,'sawtooth',.28); beep(120,.12,'sawtooth',.15); },
  shoot:   ()=>{ beep(700,.04,'square',.3); beep(420,.07,'square',.14); beep(280,.1,'sawtooth',.08); },
  coin:    ()=>{ beepChord([880,1100,1320],.09,'sine',.14); },
  pickup:  ()=>beep(720,.12,'sine',.2),
  boss:    ()=>{ beep(60,.8,'sawtooth',.5); beep(90,.6,'sawtooth',.25); },
  death:   ()=>{ beep(110,.5,'sawtooth',.38); beep(80,.4,'sawtooth',.2); },
  dodge:   ()=>{ beep(520,.06,'sine',.16); beep(840,.07,'sine',.1); },
  combo:   c=>beep(400+c*28,.09,'square',.2),
  special: ()=>{ beepChord([300,600,900],.3,'square',.18); },
  block:   ()=>beep(200,.06,'square',.15),
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CANVAS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const canvas=document.getElementById('c');
const ctx=canvas.getContext('2d');
function resize(){ canvas.width=innerWidth; canvas.height=innerHeight; }
resize();
window.addEventListener('resize',resize);

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CONSTANTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const FLOOR=()=>canvas.height-115;
const LWALL=40;
const RWALL=()=>canvas.width-40;
const BGTHEMES=[
  {sky:'#00001a',floor:'#182030',line:'#00e5ff',accent:'#0044aa'},
  {sky:'#1a0000',floor:'#301018',line:'#ff3d00',accent:'#aa1100'},
  {sky:'#00100a',floor:'#162822',line:'#00ff88',accent:'#006640'},
  {sky:'#100018',floor:'#201030',line:'#aa44ff',accent:'#550088'},
  {sky:'#0a0a00',floor:'#282010',line:'#ffd600',accent:'#886600'},
];

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// GAME STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let gRunning=false,gPaused=false,gMode='story';
let section=1,wave=1,maxWaves=10;
let coins=0,totalCoins=0;
let upg={hp:100,spd:5,dmg:1,def:1,coinMult:1,power:100};
let hasGun=false,gunAmmo=0;
let comboCount=0,comboTimer=0;
let shakeX=0,shakeY=0,shakeT=0;
let iframeT=0,dodgeT=0,dodgeCd=0,dodging=false,dodgeDir=1;
let mobileOn=false,survWave=0,killedLastFrame=false,totalTime=0;
const gStats={kills:0,bossKills:0,dmgDealt:0,dmgTaken:0,dodges:0,shots:0,waves:0,start:Date.now()};
let player,enemies=[],bosses=[],particles=[],projectiles=[],pickups=[];
// Background parallax layers
let bgStars=[];
for(let i=0;i<80;i++) bgStars.push({x:rand(0,1),y:rand(0,1),r:rand(.5,2.2),s:rand(.05,.3),t:rand(0,Math.PI*2)});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INPUT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const keys={},mk={};
document.addEventListener('keydown',e=>{
  keys[e.code]=true;
  if(e.code==='Escape'||e.code==='KeyP'){
    if(gRunning&&!gPaused)pauseGame();
    else if(gPaused)resumeGame();
  }
  if(gRunning&&['Space','ArrowUp','ArrowDown','ArrowLeft','ArrowRight'].includes(e.code))e.preventDefault();
},{passive:false});
document.addEventListener('keyup',e=>keys[e.code]=false);

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MOBILE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function toggleMobileControls(){
  mobileOn=!mobileOn;
  document.getElementById('joyWrap').style.display=mobileOn?'block':'none';
  document.getElementById('actionBtns').style.display=mobileOn?'flex':'none';
}
(function setupJoy(){
  const base=document.getElementById('joyBase'),knob=document.getElementById('joyKnob');
  let jid=-1,jbx=0,jby=0;
  base.addEventListener('touchstart',e=>{const t=e.touches[0];jid=t.identifier;const r=base.getBoundingClientRect();jbx=r.left+r.width/2;jby=r.top+r.height/2;e.preventDefault();},{passive:false});
  document.addEventListener('touchmove',e=>{for(const t of e.touches)if(t.identifier===jid){const dx=clamp(t.clientX-jbx,-46,46),dy=clamp(t.clientY-jby,-46,46);knob.style.left=(36+dx)+'px';knob.style.top=(36+dy)+'px';mk.A=dx<-10;mk.D=dx>10;}},{passive:true});
  document.addEventListener('touchend',e=>{for(const t of e.changedTouches)if(t.identifier===jid){jid=-1;mk.A=mk.D=false;knob.style.left='36px';knob.style.top='36px';}});
})();
function bindBtn(id,k){
  const el=document.getElementById(id);if(!el)return;
  el.addEventListener('touchstart',e=>{mk[k]=true;e.preventDefault();},{passive:false});
  el.addEventListener('touchend',()=>mk[k]=false);
  el.addEventListener('touchcancel',()=>mk[k]=false);
  el.addEventListener('mousedown',()=>mk[k]=true);
  el.addEventListener('mouseup',()=>mk[k]=false);
}
bindBtn('ab-jump','W');bindBtn('ab-punch','Z');bindBtn('ab-kick','X');
bindBtn('ab-block','C');bindBtn('ab-dodge','Q');bindBtn('ab-shoot','V');bindBtn('ab-special','B');

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ENTITY FACTORIES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const ST={IDLE:0,WALK:1,PUNCH:2,KICK:3,BLOCK:4,SHOOT:5,DEAD:6,DODGE:7,HURT:8};

function makePlayer(){
  return{x:150,y:0,vx:0,vy:0,hp:upg.hp,maxHp:upg.hp,facing:1,state:ST.IDLE,stateT:0,
    jumpCount:0,block:false,isEnemy:false,isBoss:false,deadT:0,invT:0,animT:0,
    _jHeld:false,_sHeld:false,shootFlash:0,hurtT:0,trailPts:[]};
}

function makeEnemy(x,isBoss=false){
  const diff=1+section*.09+wave*.04;
  const baseHp=isBoss?620+section*65:32+section*5+rand(0,22);
  const hp=Math.floor(baseHp*diff);
  const palette=[
    {body:'#cc2200',limb:'#881100',boots:'#111',skin:'#ffccaa'},
    {body:'#0044cc',limb:'#002288',boots:'#111',skin:'#ffddcc'},
    {body:'#226600',limb:'#114400',boots:'#111',skin:'#ffeecc'},
    {body:'#8800cc',limb:'#440088',boots:'#111',skin:'#ffeedd'},
    {body:'#cc5500',limb:'#882200',boots:'#111',skin:'#ffd0aa'},
  ];
  const pal=isBoss?{body:'#ff6600',limb:'#cc2200',boots:'#111',skin:'#ffaa88'}:palette[Math.floor(rand(0,palette.length))];
  return{x,y:0,vx:0,vy:0,hp,maxHp:hp,facing:-1,state:ST.IDLE,stateT:0,
    jumpCount:0,block:false,isEnemy:true,isBoss,deadT:0,aiTimer:0,atkCd:0,castCd:0,
    animT:0,pal,sc:isBoss?1.45:.85+rand(0,.28),hurtT:0,trailPts:[]};
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PHYSICS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function physics(e,dt){
  e.vy-=32*dt;
  e.y+=e.vy*dt;
  if(e.y<=0){e.y=0;e.vy=0;e.jumpCount=0;}
  const hw=(e.isBoss?14:10)*(e.sc||1);
  e.x=clamp(e.x+e.vx*dt,LWALL+hw,RWALL()-hw);
  // Trail for dodge / special
  if((dodging&&!e.isEnemy)||e.state===ST.DODGE){
    e.trailPts.unshift({x:e.x,y:e.y,t:Date.now()});
    if(e.trailPts.length>8)e.trailPts.pop();
  } else {
    e.trailPts=[];
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PLAYER UPDATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function updatePlayer(dt){
  const p=player;
  if(p.state===ST.DEAD){p.deadT+=dt;return;}
  p.animT+=dt;
  if(p.invT>0)p.invT-=dt;
  if(p.hurtT>0)p.hurtT-=dt;
  if(dodgeCd>0)dodgeCd-=dt;
  upg.power=Math.min(100,(upg.power||0)+9*dt);

  if(dodging){dodgeT-=dt;p.vx=dodgeDir*upg.spd*2.8;p.state=ST.DODGE;if(dodgeT<=0){dodging=false;}}

  const L=keys['KeyA']||keys['ArrowLeft']||mk.A;
  const R=keys['KeyD']||keys['ArrowRight']||mk.D;
  const J=keys['KeyW']||keys['ArrowUp']||keys['Space']||mk.W;

  if(!dodging){p.vx=0;if(L){p.vx=-upg.spd;p.facing=-1;}if(R){p.vx=upg.spd;p.facing=1;}}
  if(J&&!p._jHeld&&p.jumpCount<2){p.vy=15;p.jumpCount++;p._jHeld=true;}
  if(!J)p._jHeld=false;

  if((keys['KeyZ']||mk.Z)&&p.state!==ST.PUNCH){p.state=ST.PUNCH;p.stateT=0;snd.punch();}
  if((keys['KeyX']||mk.X)&&p.state!==ST.KICK){p.state=ST.KICK;p.stateT=0;snd.kick();}
  const blocking=(keys['KeyC']||mk.C);
  p.block=blocking;
  if(blocking&&p.state!==ST.PUNCH&&p.state!==ST.KICK){p.state=ST.BLOCK;snd.block();}

  if((keys['KeyQ']||mk.Q)&&dodgeCd<=0&&!dodging){
    dodging=true;dodgeT=.38;dodgeCd=1.2;dodgeDir=p.facing;
    p.invT=.38;snd.dodge();gStats.dodges++;
    spawnParts(p.x,p.y+40,'#00e5ff',12,'trail');
    if(gStats.dodges>=5)unlock('dodge5');
  }

  if((keys['KeyV']||mk.V)&&hasGun&&gunAmmo>0&&!p._sHeld){
    p.state=ST.SHOOT;p.stateT=0;p.shootFlash=.18;
    spawnProj(p.x+p.facing*24,p.y+50,p.facing*26,0,30+section,p,'#ffd600');
    gunAmmo--;p._sHeld=true;gStats.shots++;snd.shoot();
    muzzleFlash(p.x+p.facing*24,p.y+50);updateHUD();
  }
  if(!(keys['KeyV']||mk.V))p._sHeld=false;
  if(p.shootFlash>0)p.shootFlash-=dt;

  if((keys['KeyB']||mk.B)&&(upg.power||0)>=30){
    spawnProj(p.x+p.facing*24,p.y+48,p.facing*18,7,42,p,'#00e5ff');
    spawnParts(p.x,p.y+44,'#7700ff',20,'burst');
    upg.power-=30;snd.special();
  }

  p.stateT+=dt;
  if(p.stateT>.55&&p.state!==ST.BLOCK&&p.state!==ST.DEAD&&p.state!==ST.DODGE)
    p.state=Math.abs(p.vx)>.5?ST.WALK:ST.IDLE;
  if(gunAmmo<=0&&hasGun){hasGun=false;document.getElementById('ab-shoot').style.display='none';}
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ENEMY AI
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function updateEnemy(e,dt){
  if(e.state===ST.DEAD){e.deadT+=dt;return;}
  e.animT+=dt;e.atkCd=Math.max(0,e.atkCd-dt);e.castCd=Math.max(0,e.castCd-dt);
  e.aiTimer+=dt;if(e.hurtT>0)e.hurtT-=dt;
  const diff=1+section*.06,dist=Math.abs(e.x-player.x);

  if(dist>58){
    e.vx=Math.sign(player.x-e.x)*(3.8+section*.24)*diff;
    e.facing=Math.sign(player.x-e.x)||1;e.state=ST.WALK;
  } else {
    e.vx*=.8;
    if(e.atkCd<=0&&e.aiTimer>.38){
      const r=Math.random();
      if(r<.44){e.state=ST.PUNCH;e.stateT=0;e.atkCd=.9+rand(0,.45);}
      else if(r<.7){e.state=ST.KICK;e.stateT=0;e.atkCd=1.1+rand(0,.45);}
      e.aiTimer=0;
    }
  }
  if(dist>100&&e.castCd<=0&&Math.random()<.009*diff){
    spawnProj(e.x+e.facing*22,e.y+44,e.facing*12,rand(2,5),15+section,e,e.isBoss?'#ff6600':'#ff2200');
    e.castCd=1.6;
  }
  if(Math.random()<.003&&e.jumpCount<1){e.vy=14;e.jumpCount=1;}
  if(e.isBoss&&Math.random()<.0025*diff&&e.jumpCount<1){e.vy=20;e.jumpCount=1;}
  e.stateT+=dt;
  if(e.stateT>.55&&e.state!==ST.DEAD)
    e.state=Math.abs(e.vx)>.5?ST.WALK:ST.IDLE;
  e.facing=Math.sign(player.x-e.x)||e.facing;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PARTICLES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function spawnParts(x,y,col,n=18,type='normal'){
  if(!cfg.parts)return;
  for(let i=0;i<n;i++){
    const angle=rand(0,Math.PI*2);
    const spd=type==='burst'?rand(6,14):type==='trail'?rand(1,4):rand(2,8);
    particles.push({x,y,vx:Math.cos(angle)*spd,vy:Math.sin(angle)*spd,
      life:rand(.5,1.3),maxLife:1.3,col,size:rand(2,type==='burst'?6:4),type});
  }
}

function spawnProj(x,y,vx,vy,dmg,owner,col){
  projectiles.push({x,y,vx,vy,dmg,owner,col,life:3,trail:[],glow:1});
}

function spawnPickup(type,x){
  const p={type,x,y:0,bobT:rand(0,Math.PI*2),animT:0};
  if(type==='coin') p.val=Math.floor((6+section*2.5+rand(0,10))*upg.coinMult);
  if(type==='health')p.amt=32;
  if(type==='ammo')  p.amt=22;
  if(type==='power') p.amt=45;
  pickups.push(p);
}

function muzzleFlash(x,y){
  const FY=FLOOR();
  const el=document.createElement('div');
  el.className='muzzle';
  el.style.cssText=`left:${x-14}px;top:${FY-y-14}px;width:28px;height:28px;`+
    `background:radial-gradient(circle,#fff 0%,#ffd600 40%,transparent 70%);`+
    `box-shadow:0 0 16px #ffd600,0 0 30px rgba(255,214,0,.5);`;
  document.body.appendChild(el);
  setTimeout(()=>el.remove(),130);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// COMBAT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function checkCombat(dt){
  const allE=[...enemies,...bosses].filter(e=>e.state!==ST.DEAD);
  const p=player;

  allE.forEach(e=>{
    const dist=Math.abs(p.x-e.x);
    if(p.state===ST.PUNCH&&dist<60&&!e.block){
      const d=Math.floor((14+section*.6)*upg.dmg*comboMult());
      e.hp-=d;gStats.dmgDealt+=d;
      spawnParts(e.x,e.y+38,'#00ff88',12);dmgNum(e.x,e.y+40,d,'#00ff88');
      e.hurtT=.15;shakeT=cfg.shake?.1:0;addCombo();
      if(e.hp<=0)killEnemy(e);
    }
    if(p.state===ST.KICK&&dist<72&&!e.block){
      const d=Math.floor((20+section*.8)*upg.dmg*comboMult());
      e.hp-=d;gStats.dmgDealt+=d;
      spawnParts(e.x,e.y+28,'#ffaa00',10,'burst');dmgNum(e.x,e.y+30,d,'#ffaa00');
      e.hurtT=.22;shakeT=cfg.shake?.2:0;addCombo();
      if(e.hp<=0)killEnemy(e);
    }
    if(p.invT>0||dodging)return;
    if(e.state===ST.PUNCH&&dist<50&&!p.block){
      const d=Math.floor((9+section)*upg.def);
      p.hp-=d;gStats.dmgTaken+=d;
      spawnParts(p.x,p.y+38,'#ff4444',10);dmgNum(p.x,p.y+40,d,'#ff4444');
      p.hurtT=.18;flashHit();shakeT=cfg.shake?.12:0;
      p.invT=.48;resetCombo();if(p.hp<=0)killPlayer();
    }
    if(e.state===ST.KICK&&dist<64&&!p.block){
      const d=Math.floor((15+section*.9)*upg.def);
      p.hp-=d;gStats.dmgTaken+=d;
      spawnParts(p.x,p.y+30,'#ff6644',9,'burst');dmgNum(p.x,p.y+32,d,'#ff6644');
      p.hurtT=.22;flashHit();shakeT=cfg.shake?.18:0;
      p.invT=.48;resetCombo();if(p.hp<=0)killPlayer();
    }
  });

  for(let i=projectiles.length-1;i>=0;i--){
    const pr=projectiles[i];
    pr.trail.unshift({x:pr.x,y:pr.y});
    if(pr.trail.length>7)pr.trail.pop();
    pr.x+=pr.vx*dt;pr.y+=pr.vy*dt;pr.life-=dt;

    if(pr.owner.isEnemy&&p.invT<=0&&!dodging){
      if(Math.abs(pr.x-p.x)<32&&Math.abs(pr.y-(p.y+42))<44&&!p.block){
        const d=Math.floor(pr.dmg*upg.def);
        p.hp-=d;gStats.dmgTaken+=d;
        spawnParts(p.x,p.y+38,'#ff4444',14,'burst');dmgNum(p.x,p.y+40,d,'#ff4444');
        flashHit();shakeT=cfg.shake?.22:0;p.invT=.52;p.hurtT=.18;resetCombo();
        if(p.hp<=0)killPlayer();
        projectiles.splice(i,1);continue;
      }
    }
    if(!pr.owner.isEnemy){
      let hit=false;
      for(const e of allE){
        if(Math.abs(pr.x-e.x)<34&&Math.abs(pr.y-(e.y+42))<48){
          const d=Math.floor(pr.dmg*upg.dmg);
          e.hp-=d;gStats.dmgDealt+=d;
          spawnParts(e.x,e.y+38,'#00ff88',10,'burst');dmgNum(e.x,e.y+40,d,'#00ff88');
          e.hurtT=.18;addCombo();if(e.hp<=0)killEnemy(e);
          hit=true;break;
        }
      }
      if(hit){projectiles.splice(i,1);continue;}
    }
    if(pr.life<=0||pr.x<LWALL||pr.x>RWALL()){projectiles.splice(i,1);}
  }

  for(let i=pickups.length-1;i>=0;i--){
    const pu=pickups[i];
    pu.bobT+=dt*3;pu.animT+=dt;
    if(Math.abs(pu.x-p.x)<40){
      if(pu.type==='coin'){coins+=pu.val;totalCoins+=pu.val;snd.coin();dmgNum(pu.x,10,pu.val,'#ffd600',true);if(totalCoins>=500)unlock('rich');}
      if(pu.type==='health'){p.hp=Math.min(p.maxHp,p.hp+pu.amt);snd.pickup();dmgNum(p.x,p.y+40,pu.amt,'#00ff88',true);}
      if(pu.type==='gun'){hasGun=true;gunAmmo=32;document.getElementById('ab-shoot').style.display='block';snd.pickup();}
      if(pu.type==='ammo'){gunAmmo+=pu.amt;snd.pickup();}
      if(pu.type==='power'){upg.power=Math.min(100,(upg.power||0)+pu.amt);snd.pickup();}
      pickups.splice(i,1);updateHUD();
    }
  }

  const alive=[...enemies,...bosses].filter(e=>e.state!==ST.DEAD).length;
  if(alive===0&&!killedLastFrame){
    killedLastFrame=true;
    setTimeout(()=>{killedLastFrame=false;gMode==='survival'?nextSurvivalWave():waveCleared();},1700);
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// KILL / DEATH
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function killEnemy(e){
  if(e.state===ST.DEAD)return;
  e.state=ST.DEAD;e.deadT=0;
  spawnParts(e.x,e.y+44,e.isBoss?'#ff6600':'#ff2200',e.isBoss?35:18,'burst');
  const cv=Math.floor((e.isBoss?55:6)*upg.coinMult);
  coins+=cv;totalCoins+=cv;
  for(let i=0;i<(e.isBoss?5:1);i++)spawnPickup('coin',e.x+rand(-35,35));
  if(Math.random()<.28)spawnPickup('health',e.x);
  if(e.isBoss&&Math.random()<.55)spawnPickup('gun',e.x);
  gStats.kills++;if(e.isBoss){gStats.bossKills++;unlock('boss1');}
  if(gStats.kills===1)unlock('firstBlood');
  addCombo();snd.death();shakeT=cfg.shake?(e.isBoss?.45:.18):0;updateHUD();
}

function killPlayer(){
  if(player.state===ST.DEAD)return;
  player.state=ST.DEAD;player.hp=0;player.deadT=0;
  gRunning=false;snd.death();
  spawnParts(player.x,player.y+44,'#ff2200',30,'burst');
  setTimeout(()=>showGameOver(false),1600);
}

function flashHit(){
  const el=document.getElementById('hitFlash');
  el.style.background='rgba(255,0,0,0.18)';
  setTimeout(()=>el.style.background='',120);
}

function dmgNum(x,y,val,col,heal=false){
  if(!cfg.dmg)return;
  const FY=FLOOR();
  const el=document.createElement('div');
  el.className='dmg';
  el.textContent=(heal?'+':'-')+Math.ceil(val);
  el.style.cssText=`left:${x-20}px;top:${FY-y-22}px;color:${col};`+
    `font-size:${heal?'20px':'22px'};`;
  document.body.appendChild(el);
  setTimeout(()=>el.remove(),1000);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// COMBO
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function addCombo(){comboCount++;comboTimer=3.2;snd.combo(Math.min(comboCount,16));if(comboCount>=10)unlock('combo10');updateHUD();}
function resetCombo(){comboCount=0;comboTimer=0;updateHUD();}
function comboMult(){return 1+Math.min(comboCount*.06,1.2);}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// WAVE SYSTEM
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function startWave(){
  enemies=[];bosses=[];projectiles=[];killedLastFrame=false;
  const isBoss=wave===maxWaves;
  if(!isBoss){
    const cnt=Math.min(2+Math.floor(wave/2)+Math.floor(section/2),11);
    for(let i=0;i<cnt;i++)enemies.push(makeEnemy(rand(canvas.width*.5,RWALL()-55)));
  } else {
    bosses.push(makeEnemy(canvas.width*.72,true));snd.boss();
  }
  if(wave===1)for(let i=0;i<2;i++)spawnPickup(i?'ammo':'health',rand(LWALL+70,RWALL()-70));
  updateHUD();
}

function waveCleared(){
  gStats.waves++;wave++;
  if(wave>maxWaves){
    section++;
    if(section>16){unlock('win');showGameOver(true);return;}
    wave=1;openShop();return;
  }
  if(Math.random()<.42)spawnPickup('health',rand(LWALL+70,RWALL()-70));
  setTimeout(startWave,1700);updateHUD();
}

function nextSurvivalWave(){
  survWave++;enemies=[];bosses=[];projectiles=[];killedLastFrame=false;
  const cnt=Math.min(2+Math.floor(survWave/2),15);
  for(let i=0;i<cnt;i++)enemies.push(makeEnemy(rand(canvas.width*.46,RWALL()-55)));
  if(survWave%5===0){bosses.push(makeEnemy(canvas.width*.72,true));snd.boss();}
  document.getElementById('modHud').textContent=`SURV W${survWave}`;updateHUD();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SHOP
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const shopDefs=[
  {name:'Max Health +60',cost:50,desc:'Restore + increase max HP',fn:()=>{upg.hp+=60;player.maxHp=upg.hp;player.hp=upg.hp;}},
  {name:'Speed +1',cost:80,desc:'Move faster',fn:()=>upg.spd+=1},
  {name:'Damage +25%',cost:100,desc:'All attacks hit harder',fn:()=>upg.dmg+=.25},
  {name:'Defense +20%',cost:90,desc:'Take less damage',fn:()=>upg.def=Math.max(.1,upg.def-.2)},
  {name:'Coin Bonus +20%',cost:60,desc:'Earn more coins',fn:()=>upg.coinMult+=.2},
  {name:'Gun + 50 Ammo',cost:40,desc:'Arm yourself with a gun',fn:()=>{gunAmmo=52;hasGun=true;document.getElementById('ab-shoot').style.display='block';}},
  {name:'Full Restore',cost:120,desc:'Restore all HP & power',fn:()=>{player.hp=player.maxHp;upg.power=100;}},
  {name:'Ammo x100',cost:65,desc:'100 shots loaded',fn:()=>{gunAmmo=100;hasGun=true;document.getElementById('ab-shoot').style.display='block';}},
  {name:'Power Restore',cost:70,desc:'Full special power',fn:()=>upg.power=100},
];

function openShop(){
  gRunning=false;
  document.getElementById('shopCoins').textContent=coins;
  const c=document.getElementById('shopItems');c.innerHTML='';
  shopDefs.forEach(s=>{
    const btn=document.createElement('button');
    btn.className='shbtn';btn.disabled=coins<s.cost;
    btn.innerHTML=`<div class="sn">${s.name}</div><div class="sc">ğŸ’° ${s.cost}</div><div class="sd">${s.desc}</div>`;
    btn.addEventListener('click',()=>{
      if(coins<s.cost)return;
      coins-=s.cost;s.fn();snd.coin();
      document.getElementById('shopCoins').textContent=coins;
      document.querySelectorAll('.shbtn').forEach(b=>{
        const cost=parseInt(b.querySelector('.sc').textContent.replace(/\D/g,''));
        b.disabled=coins<cost;
      });updateHUD();
    });
    c.appendChild(btn);
  });
  showScreen('shopScreen');
}

function continueGame(){
  hideScreen('shopScreen');
  for(let i=0;i<3;i++)spawnPickup(['health','ammo','power'][i%3],rand(LWALL+70,RWALL()-70));
  gRunning=true;startWave();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PAUSE / RESUME
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function pauseGame(){if(!gRunning||gPaused)return;gPaused=true;gRunning=false;showScreen('pauseScreen');}
function resumeGame(){gPaused=false;gRunning=true;hideScreen('pauseScreen');hideScreen('settingsScreen');document.getElementById('statsBox').classList.remove('show');}
function toggleStats(){
  const el=document.getElementById('statsBox');
  const mins=Math.floor((Date.now()-gStats.start)/60000);
  el.innerHTML=`â± ${mins}m &nbsp; ğŸ’€ Kills: ${gStats.kills} &nbsp; ğŸ‘‘ Bosses: ${gStats.bossKills}<br>âš”ï¸ Dealt: ${Math.floor(gStats.dmgDealt)} &nbsp; ğŸ©¸ Taken: ${Math.floor(gStats.dmgTaken)}<br>ğŸ’¨ Dodges: ${gStats.dodges} &nbsp; ğŸ”« Shots: ${gStats.shots} &nbsp; ğŸŒŠ Waves: ${gStats.waves}`;
  el.classList.toggle('show');
}

function showGameOver(win){
  const mins=Math.floor((Date.now()-gStats.start)/60000);
  document.getElementById('goTitle').textContent=win?'ğŸ† YOU WIN! CHAMPION!':'DEFEATED! ğŸ’€';
  document.getElementById('goStats').innerHTML=`Kills: ${gStats.kills} &nbsp; Coins: ${totalCoins} &nbsp; Section ${section}<br>Time: ${mins}m`;
  onlyScreen('gameoverScreen');
  document.getElementById('hud').classList.remove('show');
  try{localStorage.setItem('srSave',JSON.stringify({section,coins,upg}));}catch(e){}
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// HUD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function updateHUD(){
  const p=player;
  const hr=clamp(p.hp/p.maxHp,0,1);
  const hf=document.getElementById('hpFill');
  hf.style.width=hr*100+'%';
  hf.style.background=hr<.25?'linear-gradient(90deg,#ff2200,#ff4400)':hr<.5?'linear-gradient(90deg,#ff2200,#ffcc00)':'linear-gradient(90deg,#ff2200,#44ff00)';
  document.getElementById('pwFill').style.width=clamp(upg.power||0,0,100)+'%';
  document.getElementById('secHud').textContent=section;
  document.getElementById('waveHud').textContent=wave;
  document.getElementById('coinsHud').textContent='ğŸ’° '+coins;
  document.getElementById('weapHud').textContent=hasGun?`ğŸ”« Gun (${gunAmmo})`:'ğŸ‘Š Fists';
  document.getElementById('comboHud').textContent=comboCount>=2?`Ã—${comboCount} COMBO!`:'';
  const alive=[...enemies,...bosses].filter(e=>e.state!==ST.DEAD).length;
  document.getElementById('enemHud').textContent=alive;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MINIMAP
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function drawMinimap(){
  const mc=document.getElementById('minimap'),mx=mc.getContext('2d');
  const mw=134,mh=28;
  mx.clearRect(0,0,mw,mh);
  mx.fillStyle='rgba(0,5,22,.86)';mx.fillRect(0,0,mw,mh);
  mx.strokeStyle='rgba(0,180,255,.3)';mx.lineWidth=1;mx.strokeRect(0,0,mw,mh);
  const W=RWALL()-LWALL;
  const toM=x=>((x-LWALL)/W)*(mw-14)+7;
  // Player dot with glow
  mx.shadowColor='#00e5ff';mx.shadowBlur=6;
  mx.fillStyle='#00e5ff';mx.beginPath();mx.arc(toM(player.x),12,4.5,0,Math.PI*2);mx.fill();
  mx.shadowBlur=0;
  [...enemies,...bosses].forEach(e=>{
    if(e.state===ST.DEAD)return;
    mx.fillStyle=e.isBoss?'#ff6600':'#ff3322';
    mx.beginPath();mx.arc(toM(e.x),13,e.isBoss?4:3,0,Math.PI*2);mx.fill();
  });
  pickups.forEach(pu=>{
    mx.fillStyle=pu.type==='coin'?'#ffd600':pu.type==='health'?'#00ff88':'#aa44ff';
    mx.beginPath();mx.arc(toM(pu.x),16,2,0,Math.PI*2);mx.fill();
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DRAW ARENA
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function drawArena(){
  const FY=FLOOR(),W=canvas.width,H=canvas.height;
  const theme=BGTHEMES[(section-1)%BGTHEMES.length];
  // Clear (transparent so Three.js BG shows through)
  ctx.clearRect(0,0,W,H);
  // Semi-transparent overlay for depth
  ctx.fillStyle='rgba(0,0,8,0.62)';ctx.fillRect(0,0,W,H);

  // Atmospheric gradient
  const bg=ctx.createLinearGradient(0,0,0,H);
  bg.addColorStop(0,'rgba(0,0,0,0)');
  bg.addColorStop(.55,theme.sky.replace('#','rgba(').replace(/(..)(..)(..)$/,(_,r,g,b)=>`${parseInt(r,16)},${parseInt(g,16)},${parseInt(b,16)},0.22)`));
  bg.addColorStop(1,'rgba(0,0,0,.15)');
  ctx.fillStyle=bg;ctx.fillRect(0,0,W,H);

  // Scan lines (very subtle)
  for(let y=0;y<H;y+=3){
    ctx.fillStyle='rgba(0,0,0,.04)';
    ctx.fillRect(0,y,W,1);
  }

  // Floor glow underneath
  const fg2=ctx.createRadialGradient(W/2,FY,0,W/2,FY,W*.7);
  fg2.addColorStop(0,theme.accent.replace('#','rgba(').replace(/(..)(..)(..)$/,(_,r,g,b)=>`${parseInt(r,16)},${parseInt(g,16)},${parseInt(b,16)},0.18)`));
  fg2.addColorStop(1,'transparent');
  ctx.fillStyle=fg2;ctx.fillRect(0,FY-40,W,50);

  // Floor surface
  const fg=ctx.createLinearGradient(0,FY,0,FY+85);
  fg.addColorStop(0,'rgba(16,18,38,0.92)');
  fg.addColorStop(1,'rgba(4,5,14,0.98)');
  ctx.fillStyle=fg;ctx.fillRect(0,FY,W,H-FY);

  // Floor grid lines
  ctx.strokeStyle='rgba(255,255,255,.04)';ctx.lineWidth=1;
  for(let x=LWALL;x<RWALL();x+=55){
    ctx.beginPath();ctx.moveTo(x,FY);ctx.lineTo(x,H);ctx.stroke();
  }

  // Floor line (glowing)
  const flGrad=ctx.createLinearGradient(LWALL,0,RWALL(),0);
  flGrad.addColorStop(0,'transparent');
  flGrad.addColorStop(.15,theme.line);
  flGrad.addColorStop(.5,theme.line);
  flGrad.addColorStop(.85,theme.line);
  flGrad.addColorStop(1,'transparent');
  ctx.strokeStyle=flGrad;ctx.lineWidth=2.5;
  ctx.shadowColor=theme.line;ctx.shadowBlur=14;
  ctx.beginPath();ctx.moveTo(LWALL,FY);ctx.lineTo(RWALL(),FY);ctx.stroke();
  ctx.shadowBlur=0;

  // Walls
  const wallGrad=ctx.createLinearGradient(0,0,LWALL,0);
  wallGrad.addColorStop(0,'rgba(0,0,0,.9)');wallGrad.addColorStop(1,'rgba(0,40,100,.3)');
  ctx.fillStyle=wallGrad;ctx.fillRect(0,0,LWALL,H);
  const wallGradR=ctx.createLinearGradient(RWALL(),0,W,0);
  wallGradR.addColorStop(0,'rgba(0,40,100,.3)');wallGradR.addColorStop(1,'rgba(0,0,0,.9)');
  ctx.fillStyle=wallGradR;ctx.fillRect(RWALL(),0,W-RWALL(),H);

  // Wall energy lines
  ctx.strokeStyle=theme.line;ctx.lineWidth=2;
  ctx.shadowColor=theme.line;ctx.shadowBlur=10;
  ctx.beginPath();ctx.moveTo(LWALL,0);ctx.lineTo(LWALL,H);ctx.stroke();
  ctx.beginPath();ctx.moveTo(RWALL(),0);ctx.lineTo(RWALL(),H);ctx.stroke();
  ctx.shadowBlur=0;

  // Ceiling spotlights
  const lxs=[LWALL+16,...Array.from({length:4},(_,i)=>LWALL+(RWALL()-LWALL)/5*(i+1)),RWALL()-16];
  lxs.forEach((lx,li)=>{
    const t=Date.now()/1000;
    const pulse=.75+Math.sin(t*1.2+li*.8)*.25;
    const rg=ctx.createConicalGradient?null:ctx.createRadialGradient(lx,0,0,lx,0,55);
    if(!rg)return;
    rg.addColorStop(0,`rgba(0,160,255,${.28*pulse})`);
    rg.addColorStop(.6,`rgba(0,80,200,${.07*pulse})`);
    rg.addColorStop(1,'transparent');
    ctx.fillStyle=rg;ctx.fillRect(lx-55,0,110,56);
    // Light fixture
    ctx.fillStyle=`rgba(140,200,255,${.7+Math.sin(t*2+li)*0.3})`;
    ctx.shadowColor='#00e5ff';ctx.shadowBlur=8;
    ctx.beginPath();ctx.arc(lx,8,3.8,0,Math.PI*2);ctx.fill();
    ctx.shadowBlur=0;
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DRAW STICKMAN (HIGHLY DETAILED)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function drawStick(e,isPlayer){
  const FY=FLOOR();
  const cx=e.x,cy=FY-e.y;
  ctx.save();
  ctx.translate(cx,cy);
  if(e.facing<0)ctx.scale(-1,1);
  const sc=e.sc||1;ctx.scale(sc,sc);

  if(isPlayer&&e.invT>0&&Math.floor(e.invT*12)%2===0){ctx.restore();return;}
  if(e.state===ST.DEAD){
    const angle=Math.min(Math.PI/2,e.deadT*3.5);
    ctx.rotate(angle);
    ctx.globalAlpha=Math.max(0,1-e.deadT*.75);
  }

  const hurt=e.hurtT>0;
  const pal=isPlayer?{body:'#0066cc',limb:'#004488',boots:'#111122',skin:'#ffeedd',eye:'#00e5ff',accent:'#0099ff'}:e.pal;
  const t=e.animT;
  const walkCyc=Math.sin(t*9);
  const walkCyc2=Math.sin(t*9+Math.PI);

  // Hurt flash
  if(hurt){ctx.globalAlpha=(ctx.globalAlpha||1)*.6;}

  // â”€â”€ Leg poses
  let llR=0,rlR=0,laR=0,raR=0,bodyLean=0;
  const isWalk=(e.state===ST.WALK||Math.abs(e.vx)>.4);
  if(isWalk){ llR=walkCyc*.95; rlR=walkCyc2*.95; laR=walkCyc2*.5; raR=walkCyc*.5; bodyLean=walkCyc*.04; }
  if(e.state===ST.PUNCH){ raR=-1.65+Math.sin(e.stateT*30)*.5; laR=.4; bodyLean=.12; }
  if(e.state===ST.KICK) { rlR=-1.45+Math.sin(e.stateT*25)*.5; laR=.2; }
  if(e.state===ST.BLOCK){ laR=raR=-.9; bodyLean=-.05; }
  if(e.state===ST.SHOOT){ raR=-1.1+Math.sin(e.stateT*32)*.08; laR=-.3; bodyLean=.06; }
  if(e.state===ST.DODGE){ bodyLean=.35; llR=-.8; rlR=.6; laR=.7; raR=-.4; }
  if(isPlayer&&e.y>2){ llR+=Math.sin(t*7)*.25; rlR+=Math.sin(t*7+Math.PI)*.25; }

  // Idle breathing
  const breathY=Math.sin(t*2.5)*.8;

  ctx.lineCap='round';ctx.lineJoin='round';

  // â”€â”€ Shadow beneath character
  ctx.save();
  ctx.translate(0,5);
  const shadowSize=(sc||1)*28;
  const shadowG=ctx.createRadialGradient(0,0,0,0,0,shadowSize);
  shadowG.addColorStop(0,'rgba(0,0,0,.35)');shadowG.addColorStop(1,'transparent');
  ctx.fillStyle=shadowG;
  ctx.scale(1,.25);ctx.beginPath();ctx.arc(0,0,shadowSize,0,Math.PI*2);ctx.fill();
  ctx.restore();

  // â”€â”€ Body group (with breathing offset)
  ctx.save();ctx.translate(0,breathY+bodyLean*4);

  // Left leg
  ctx.save();ctx.translate(-7,-2);ctx.rotate(llR);
  // Upper leg
  ctx.strokeStyle=pal.limb;ctx.lineWidth=8;
  ctx.beginPath();ctx.moveTo(0,0);ctx.lineTo(-2,18);ctx.stroke();
  // Knee joint
  ctx.fillStyle=pal.limb;ctx.beginPath();ctx.arc(-2,18,4,0,Math.PI*2);ctx.fill();
  // Lower leg
  ctx.save();ctx.translate(-2,18);ctx.rotate(llR*-.3);
  ctx.strokeStyle=pal.limb;ctx.lineWidth=7;
  ctx.beginPath();ctx.moveTo(0,0);ctx.lineTo(0,16);ctx.stroke();
  // Boot
  ctx.fillStyle=pal.boots;ctx.fillRect(-5,13,14,7);ctx.fillRect(-5,18,6,4);
  ctx.restore();ctx.restore();

  // Right leg
  ctx.save();ctx.translate(7,-2);ctx.rotate(rlR);
  ctx.strokeStyle=pal.limb;ctx.lineWidth=8;
  ctx.beginPath();ctx.moveTo(0,0);ctx.lineTo(2,18);ctx.stroke();
  ctx.fillStyle=pal.limb;ctx.beginPath();ctx.arc(2,18,4,0,Math.PI*2);ctx.fill();
  ctx.save();ctx.translate(2,18);ctx.rotate(rlR*-.3);
  ctx.strokeStyle=pal.limb;ctx.lineWidth=7;
  ctx.beginPath();ctx.moveTo(0,0);ctx.lineTo(0,16);ctx.stroke();
  ctx.fillStyle=pal.boots;ctx.fillRect(-9,13,14,7);ctx.fillRect(-1,18,6,4);
  ctx.restore();ctx.restore();

  // Torso
  const torsoG=ctx.createLinearGradient(-10,-48,10,-48);
  torsoG.addColorStop(0,pal.limb);torsoG.addColorStop(.5,pal.body);torsoG.addColorStop(1,pal.limb);
  ctx.fillStyle=torsoG;
  ctx.beginPath();ctx.moveTo(-10,-4);ctx.lineTo(-9,-48);ctx.lineTo(9,-48);ctx.lineTo(10,-4);ctx.closePath();ctx.fill();
  // Torso highlight
  ctx.fillStyle='rgba(255,255,255,.08)';ctx.beginPath();ctx.moveTo(-5,-6);ctx.lineTo(-4,-46);ctx.lineTo(2,-46);ctx.lineTo(3,-6);ctx.closePath();ctx.fill();
  // Belt
  ctx.fillStyle='rgba(0,0,0,.5)';ctx.fillRect(-11,-5,22,5);
  ctx.strokeStyle='rgba(255,255,255,.15)';ctx.lineWidth=1;ctx.strokeRect(-11,-5,22,5);
  // Belt buckle
  ctx.fillStyle='rgba(255,200,0,.6)';ctx.fillRect(-4,-4.5,8,4);

  // Left arm
  ctx.save();ctx.translate(-9,-40);ctx.rotate(laR-.3);
  ctx.strokeStyle=pal.limb;ctx.lineWidth=7;
  ctx.beginPath();ctx.moveTo(0,0);ctx.lineTo(-6,20);ctx.stroke();
  // Elbow joint
  ctx.fillStyle=pal.limb;ctx.beginPath();ctx.arc(-6,20,3.5,0,Math.PI*2);ctx.fill();
  // Forearm
  ctx.save();ctx.translate(-6,20);ctx.rotate(laR*-.2);
  ctx.strokeStyle=pal.limb;ctx.lineWidth=6;
  ctx.beginPath();ctx.moveTo(0,0);ctx.lineTo(-2,14);ctx.stroke();
  // Hand
  ctx.fillStyle=pal.skin;ctx.beginPath();ctx.arc(-2,14,5.5,0,Math.PI*2);ctx.fill();
  ctx.restore();ctx.restore();

  // Right arm
  ctx.save();ctx.translate(9,-40);ctx.rotate(raR+.3);
  ctx.strokeStyle=pal.limb;ctx.lineWidth=7;
  ctx.beginPath();ctx.moveTo(0,0);ctx.lineTo(6,20);ctx.stroke();
  ctx.fillStyle=pal.limb;ctx.beginPath();ctx.arc(6,20,3.5,0,Math.PI*2);ctx.fill();
  ctx.save();ctx.translate(6,20);ctx.rotate(raR*.2);
  ctx.strokeStyle=pal.limb;ctx.lineWidth=6;
  ctx.beginPath();ctx.moveTo(0,0);ctx.lineTo(2,14);ctx.stroke();
  // Gun in hand (if player has gun and shooting, or enemy projectile state)
  if((isPlayer&&hasGun&&e.state===ST.SHOOT)||(e.isEnemy&&e.state===ST.SHOOT)){
    ctx.fillStyle='#223344';ctx.fillRect(-2,10,22,8);ctx.fillRect(2,18,7,9);
    if(isPlayer&&e.shootFlash>0){
      ctx.shadowColor='#ffd600';ctx.shadowBlur=18;
      ctx.fillStyle='rgba(255,220,0,.9)';ctx.beginPath();ctx.arc(20,14,6,0,Math.PI*2);ctx.fill();
      ctx.shadowBlur=0;
    }
  } else {
    ctx.fillStyle=pal.skin;ctx.beginPath();ctx.arc(2,14,5.5,0,Math.PI*2);ctx.fill();
  }
  ctx.restore();ctx.restore();

  // Head
  const headBob=Math.sin(t*2.5)*.5;
  ctx.save();ctx.translate(0,headBob);
  // Neck
  ctx.strokeStyle=pal.skin;ctx.lineWidth=6;
  ctx.beginPath();ctx.moveTo(0,-50);ctx.lineTo(0,-55);ctx.stroke();
  // Head base with subtle shadow
  ctx.shadowColor='rgba(0,0,0,.4)';ctx.shadowBlur=6;ctx.shadowOffsetX=2;ctx.shadowOffsetY=3;
  ctx.fillStyle=pal.skin;ctx.beginPath();ctx.arc(0,-64,14,0,Math.PI*2);ctx.fill();
  ctx.shadowBlur=0;ctx.shadowOffsetX=0;ctx.shadowOffsetY=0;
  // Head outline
  if(e.isBoss){
    ctx.strokeStyle='#ff4400';ctx.lineWidth=2.5;
    ctx.beginPath();ctx.arc(0,-64,14,0,Math.PI*2);ctx.stroke();
    // Boss crown
    ctx.fillStyle='#ffd600';
    for(let k=0;k<5;k++){
      const a=(k/5)*Math.PI*2-.3;
      ctx.beginPath();ctx.moveTo(Math.cos(a)*12,-64+Math.sin(a)*12);
      ctx.lineTo(Math.cos(a)*18,-64+Math.sin(a)*18);
      const a2=a+.3;ctx.lineTo(Math.cos(a2)*12,-64+Math.sin(a2)*12);
      ctx.closePath();ctx.fill();
    }
  } else if(isPlayer){
    ctx.strokeStyle=pal.accent;ctx.lineWidth=1.5;
    ctx.beginPath();ctx.arc(0,-64,14,0,Math.PI*2);ctx.stroke();
  }
  // Eyes
  const blinkAmt=Math.sin(t*7)>.96?.1:1;
  ctx.fillStyle=pal.eye||'#222';
  ctx.beginPath();ctx.ellipse(-5,-65,3,3.5*blinkAmt,0,0,Math.PI*2);ctx.fill();
  ctx.beginPath();ctx.ellipse(5,-65,3,3.5*blinkAmt,0,0,Math.PI*2);ctx.fill();
  // Eye shine
  ctx.fillStyle='rgba(255,255,255,.8)';
  ctx.beginPath();ctx.arc(-4,-66.5,1.1,0,Math.PI*2);ctx.fill();
  ctx.beginPath();ctx.arc(6,-66.5,1.1,0,Math.PI*2);ctx.fill();
  // Expression based on state
  if(e.state===ST.DEAD){
    // X eyes
    ctx.strokeStyle='#ff2200';ctx.lineWidth=1.5;
    ctx.beginPath();ctx.moveTo(-8,-68);ctx.lineTo(-2,-62);ctx.stroke();
    ctx.beginPath();ctx.moveTo(-2,-68);ctx.lineTo(-8,-62);ctx.stroke();
    ctx.beginPath();ctx.moveTo(2,-68);ctx.lineTo(8,-62);ctx.stroke();
    ctx.beginPath();ctx.moveTo(8,-68);ctx.lineTo(2,-62);ctx.stroke();
  } else if(e.state===ST.PUNCH||e.state===ST.KICK){
    // Angry brows
    ctx.strokeStyle='#664400';ctx.lineWidth=2;
    ctx.beginPath();ctx.moveTo(-8,-69);ctx.lineTo(-2,-67);ctx.stroke();
    ctx.beginPath();ctx.moveTo(2,-67);ctx.lineTo(8,-69);ctx.stroke();
    ctx.strokeStyle='#aa5500';ctx.lineWidth=1.5;
    ctx.beginPath();ctx.moveTo(-6,-60);ctx.quadraticCurveTo(-1,-57,4,-60);ctx.stroke();
  } else {
    // Normal mouth
    ctx.strokeStyle='#c88866';ctx.lineWidth=1.8;
    ctx.beginPath();ctx.moveTo(-5,-60);ctx.quadraticCurveTo(0,-57,5,-60);ctx.stroke();
  }
  ctx.restore();

  // Block shield effect
  if(e.state===ST.BLOCK){
    ctx.save();ctx.translate(-15,-30);
    ctx.fillStyle='rgba(0,200,100,.18)';ctx.strokeStyle='rgba(0,255,130,.5)';ctx.lineWidth=2;
    ctx.beginPath();ctx.ellipse(0,0,12,22,-.3,0,Math.PI*2);ctx.fill();ctx.stroke();
    ctx.restore();
  }

  // Enemy HP bar (floating, with boss glow)
  if(e.isEnemy&&e.state!==ST.DEAD){
    const bw=52*(e.sc||1),bh=5,ratio=clamp(e.hp/e.maxHp,0,1);
    const by=-80*(e.sc||1);
    ctx.fillStyle='rgba(0,0,0,.6)';ctx.fillRect(-bw/2-1,by-1,bw+2,bh+2);
    ctx.fillStyle='#330000';ctx.fillRect(-bw/2,by,bw,bh);
    const hpG=ctx.createLinearGradient(-bw/2,0,bw/2,0);
    hpG.addColorStop(0,ratio<.3?'#ff2200':ratio<.6?'#ffcc00':'#00dd55');
    hpG.addColorStop(1,ratio<.3?'#ff5500':ratio<.6?'#ffd600':'#00ff88');
    ctx.fillStyle=hpG;ctx.fillRect(-bw/2,by,bw*ratio,bh);
    if(e.isBoss){
      ctx.shadowColor=ratio<.3?'#ff2200':'#ffd600';ctx.shadowBlur=8;
      ctx.strokeStyle='rgba(255,255,255,.2)';ctx.lineWidth=1;ctx.strokeRect(-bw/2,by,bw,bh);
      ctx.shadowBlur=0;
    }
  }

  ctx.restore();// sc/facing
  ctx.restore();// translate
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DRAW PROJECTILES (with trail)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function drawProjectiles(){
  const FY=FLOOR();
  projectiles.forEach(pr=>{
    // Trail
    pr.trail.forEach((pt,i)=>{
      const alpha=(1-i/pr.trail.length)*.35;
      const size=8-i*.8;
      ctx.save();ctx.globalAlpha=alpha;
      ctx.shadowColor=pr.col;ctx.shadowBlur=8;
      ctx.fillStyle=pr.col;
      ctx.beginPath();ctx.arc(pt.x,FY-pt.y,Math.max(1,size),0,Math.PI*2);ctx.fill();
      ctx.restore();
    });
    // Main bullet
    ctx.save();
    ctx.shadowColor=pr.col;ctx.shadowBlur=22;
    ctx.fillStyle='#fff';ctx.beginPath();ctx.arc(pr.x,FY-pr.y,5,0,Math.PI*2);ctx.fill();
    ctx.fillStyle=pr.col;ctx.beginPath();ctx.arc(pr.x,FY-pr.y,8,0,Math.PI*2);ctx.fill();
    ctx.shadowBlur=0;ctx.restore();
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DRAW PICKUPS (animated)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function drawPickups(){
  const FY=FLOOR();
  const t=Date.now()/1000;
  pickups.forEach(pu=>{
    const sy=FY-14+Math.sin(pu.bobT+t*3)*7;
    const pulse=.8+Math.sin(t*3+pu.bobT)*.2;
    ctx.save();ctx.translate(pu.x,sy);

    if(pu.type==='coin'){
      const r=11*pulse;
      ctx.shadowColor='#ffd600';ctx.shadowBlur=18;
      const cg=ctx.createRadialGradient(0,0,0,0,0,r);
      cg.addColorStop(0,'#fff7aa');cg.addColorStop(.5,'#ffd600');cg.addColorStop(1,'#cc8800');
      ctx.fillStyle=cg;ctx.beginPath();ctx.arc(0,0,r,0,Math.PI*2);ctx.fill();
      ctx.rotate(t*.6);
      ctx.fillStyle='rgba(0,0,0,.3)';ctx.font=`bold ${Math.round(10*pulse)}px Arial`;ctx.textAlign='center';ctx.textBaseline='middle';ctx.fillText('$',0,1);
    } else if(pu.type==='health'){
      ctx.shadowColor='#00ff88';ctx.shadowBlur=16;
      ctx.fillStyle='#00dd66';
      ctx.fillRect(-10,-3.5,20,7);ctx.fillRect(-3.5,-10,7,20);
      // Center gem
      ctx.fillStyle='#afffdc';ctx.fillRect(-2,-2,4,4);
    } else if(pu.type==='gun'){
      ctx.shadowColor='#88aaff';ctx.shadowBlur=14;
      ctx.fillStyle='#445566';ctx.fillRect(-13,-5,24,10);
      ctx.fillStyle='#5566aa';ctx.fillRect(-3,3,8,9);
      ctx.fillStyle='#778899';ctx.fillRect(8,-4,4,8);
    } else if(pu.type==='ammo'){
      ctx.shadowColor='#ffdd00';ctx.shadowBlur=14;
      ctx.fillStyle='#cc8800';ctx.fillRect(-7,-10,14,20);
      ctx.fillStyle='#ffcc00';ctx.fillRect(-6,-9,12,4);
    } else if(pu.type==='power'){
      ctx.shadowColor='#cc44ff';ctx.shadowBlur=18;
      const pts=5;
      ctx.rotate(t*.5);
      ctx.fillStyle='#aa00ff';ctx.beginPath();
      for(let i=0;i<pts*2;i++){const a=i/pts*Math.PI-Math.PI/2,r=i%2===0?12*pulse:6;ctx.lineTo(Math.cos(a)*r,Math.sin(a)*r);}
      ctx.closePath();ctx.fill();
      ctx.fillStyle='#cc88ff';ctx.beginPath();ctx.arc(0,0,4,0,Math.PI*2);ctx.fill();
    }
    ctx.shadowBlur=0;ctx.restore();
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DRAW PARTICLES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function drawParticles(){
  const FY=FLOOR();
  particles.forEach(p=>{
    const alpha=Math.max(0,p.life/p.maxLife);
    ctx.save();ctx.globalAlpha=alpha;
    ctx.shadowColor=p.col;ctx.shadowBlur=p.type==='burst'?10:4;
    ctx.fillStyle=p.col;
    const sz=p.size*alpha;
    ctx.beginPath();ctx.arc(p.x,FY-p.y,sz,0,Math.PI*2);ctx.fill();
    ctx.restore();
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DRAW DODGE TRAIL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function drawTrail(e){
  if(!e.trailPts||e.trailPts.length<2)return;
  const FY=FLOOR();
  const col=e.isEnemy?'rgba(255,80,0,':'rgba(0,200,255,';
  e.trailPts.forEach((pt,i)=>{
    const alpha=(1-i/e.trailPts.length)*.3;
    ctx.save();ctx.globalAlpha=alpha;
    ctx.fillStyle=col+alpha+')';
    ctx.beginPath();ctx.ellipse(pt.x,FY-pt.y-40,(e.sc||1)*12,(e.sc||1)*28,.1,0,Math.PI*2);ctx.fill();
    ctx.restore();
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// GAME START
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function startGame(mode){
  getACtx();gMode=mode;gRunning=true;gPaused=false;
  gStats.start=Date.now();gStats.kills=0;gStats.bossKills=0;
  gStats.dmgDealt=0;gStats.dmgTaken=0;gStats.dodges=0;gStats.shots=0;gStats.waves=0;
  section=1;wave=1;coins=0;totalCoins=0;hasGun=false;gunAmmo=0;
  comboCount=0;comboTimer=0;totalTime=0;survWave=0;
  upg={hp:100,spd:5,dmg:1,def:1,coinMult:1,power:100};
  enemies=[];bosses=[];projectiles=[];particles=[];pickups=[];
  player=makePlayer();
  onlyScreen(null);
  document.getElementById('hud').classList.add('show');
  document.getElementById('modHud').textContent=mode.toUpperCase();
  document.getElementById('ab-shoot').style.display='none';
  if(mode==='survival')nextSurvivalWave();else startWave();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MAIN LOOP
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let last=0;
function loop(ts){
  requestAnimationFrame(loop);
  const dt=Math.min(.05,(ts-last)/1000);last=ts;

  if(!gRunning||gPaused){
    ctx.clearRect(0,0,canvas.width,canvas.height);
    return;
  }
  totalTime+=dt;

  updatePlayer(dt);physics(player,dt);
  const allE=[...enemies,...bosses];
  allE.forEach(e=>{if(e.state!==ST.DEAD){updateEnemy(e,dt);physics(e,dt);}else{e.deadT+=dt;}});
  enemies=enemies.filter(e=>!(e.state===ST.DEAD&&e.deadT>2.2));
  bosses=bosses.filter(e=>!(e.state===ST.DEAD&&e.deadT>2.2));
  particles.forEach(p=>{p.x+=p.vx*dt;p.y+=p.vy*dt;p.vy-=28*dt;p.vx*=.96;p.life-=dt;});
  particles=particles.filter(p=>p.life>0);
  if(comboCount>0){comboTimer-=dt;if(comboTimer<=0)resetCombo();}

  // Screen shake
  if(shakeT>0){shakeX=Math.sin(ts*.07)*shakeT*5;shakeY=Math.cos(ts*.1)*shakeT*4;shakeT-=dt;}
  else{shakeX*=.75;shakeY*=.75;}

  checkCombat(dt);

  // Render
  ctx.save();ctx.translate(shakeX,shakeY);
  drawArena();
  // Trails
  [player,...allE].forEach(e=>drawTrail(e));
  drawPickups();drawProjectiles();drawParticles();
  allE.forEach(e=>{if(!(e.state===ST.DEAD&&e.deadT>1.8))drawStick(e,false);});
  if(!(player.state===ST.DEAD&&player.deadT>1.8))drawStick(player,true);
  ctx.restore();

  if(Math.floor(totalTime*22)%4===0){updateHUD();drawMinimap();}
}

requestAnimationFrame(loop);
console.log('ğŸ¦¾ Stickman Rage â€” Three.js + Canvas2D, zero external game deps!');
</script>
</body>
</html>
